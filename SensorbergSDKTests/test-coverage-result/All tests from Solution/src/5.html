<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>d:\work\sensorberg\windows10-sdk\sensorbergsdktests\layoutmanagertest.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
// Created by Kay Czarnotta on 04.03.2016
// 
// Copyright (c) 2016,  Sensorberg
// 
// All rights reserved.

using System;
using System.Linq;
using System.Threading.Tasks;
using Windows.Data.Json;
using Windows.Storage;
using Microsoft.VisualStudio.TestPlatform.UnitTestFramework;
using SensorbergSDK.Internal;
using SensorbergSDK.Internal.Services;
using SensorbergSDK.Services;
using SensorbergSDKTests.Mocks;

namespace SensorbergSDKTests
{
    [TestClass]
    public class LayoutManagerTest
    {
        [TestInitialize]
        public async Task Setup()
        {
            ServiceManager.ReadOnlyForTests = false;
            ServiceManager.Clear();
            ServiceManager.ApiConnction = new MockApiConnection();
            ServiceManager.LayoutManager = new LayoutManager();
            ServiceManager.StorageService = new StorageService() {Storage = new MockStorage()};
            ServiceManager.ReadOnlyForTests = true;
        }

        [TestMethod]
        public async Task TestValidLayout()
        {
            await ValidateBaseMockLayout(ServiceManager.LayoutManager);
        }

        [TestMethod]
        public async Task TestValidInvalidateLayout()
        {
            ILayoutManager manager = ServiceManager.LayoutManager;
            await ValidateBaseMockLayout(manager);
            await manager.InvalidateLayout();
            Assert.IsFalse(manager.IsLayoutValid, &quot;Layout still valid&quot;);
            Assert.IsNull(manager.Layout, &quot;Layout still exists&quot;);
            Assert.IsTrue(await manager.VerifyLayoutAsync(true), &quot;Verification failed&quot;);
            Assert.IsTrue(manager.IsLayoutValid, &quot;Layout still invalid&quot;);
        }

        private static async Task ValidateBaseMockLayout(ILayoutManager manager)
        {
            Assert.IsTrue(await manager.VerifyLayoutAsync(true), &quot;Verification failed&quot;);
            Layout layout = manager.Layout;
            ValidateMockLayout(layout);
        }

        public static void ValidateMockLayout(Layout layout)
        {
            Assert.IsNotNull(layout, &quot;No Layout avialable&quot;);
            Assert.AreEqual(5, layout.AccountBeaconId1s.Count, &quot;Number of proximity beacons not matching&quot;);
            Assert.IsTrue(layout.AccountBeaconId1s.Contains(&quot;7367672374000000ffff0000ffff0003&quot;), &quot;Beacon 1 not found&quot;);
            Assert.IsTrue(layout.AccountBeaconId1s.Contains(&quot;7367672374000000ffff0000ffff0006&quot;), &quot;Beacon 2 not found&quot;);
            Assert.IsTrue(layout.AccountBeaconId1s.Contains(&quot;7367672374000000ffff0000ffff0004&quot;), &quot;Beacon 3 not found&quot;);
            Assert.IsTrue(layout.AccountBeaconId1s.Contains(&quot;7367672374000000ffff0000ffff0007&quot;), &quot;Beacon 4 not found&quot;);
            Assert.AreEqual(9, layout.ResolvedActions.Count, &quot;not 9 actions&quot;);

            ResolvedAction a = layout.ResolvedActions.FirstOrDefault(t =&gt; t.BeaconAction.Uuid == &quot;9ded63644e424d758b0218f7c70f2473&quot;);
            Assert.AreEqual(3, (int) a.EventTypeDetectedByDevice, &quot;beacon 1 - Wrong trigger type&quot;);
            Assert.AreEqual(2, a.BeaconPids.Count, &quot;beacon 1 - Beacon count wrong&quot;);
            Assert.IsTrue(a.BeaconPids.Contains(&quot;7367672374000000ffff0000ffff00043917830929&quot;), &quot;beacon 1 - No Beacon found!&quot;);

            Assert.AreEqual(43200, a.SupressionTime, &quot;beacon 1 - Wrong supression time!&quot;);
            Assert.AreEqual(0, a.Delay, &quot;beacon 1 - Different delay is set&quot;);

            Assert.AreEqual(string.Empty, a.BeaconAction.Subject, &quot;beacon 1 - Different action subject&quot;);
            Assert.AreEqual(string.Empty, a.BeaconAction.Body, &quot;beacon 1 - Different action body&quot;);
            Assert.AreEqual(&quot;http://www.visitfinland.com/&quot;, a.BeaconAction.Url, &quot;beacon 1 - wrong url is set&quot;);
            Assert.IsNull(a.BeaconAction.Payload, &quot;beacon 1 - Payload is not null&quot;);

            Assert.AreEqual(1, a.Timeframes.Count, &quot;beacon 1 - More timeframes are set&quot;);
            Assert.AreEqual(new DateTime(2015, 04, 16, 12, 46, 19, 627), a.Timeframes[0].Start.Value.DateTime, &quot;beacon 1 - Different timesetting&quot;);

            Assert.AreEqual(3, (int) a.BeaconAction.Type, &quot;beacon 1 - Different type&quot;);
            Assert.IsFalse(a.SendOnlyOnce, &quot;beacon 1 - Send only once is set&quot;);


            a = layout.ResolvedActions.FirstOrDefault(t =&gt; t.BeaconAction.Uuid == &quot;3f30be2605524f82a9bf0ccb4a81618f&quot;);
            Assert.AreEqual(1, (int) a.EventTypeDetectedByDevice, &quot;beacon 2 - Wrong trigger type&quot;);
            Assert.AreEqual(1, a.BeaconPids.Count, &quot;beacon 2 - Beacon count wrong&quot;);
            Assert.IsTrue(a.BeaconPids.Contains(&quot;7367672374000000ffff0000ffff00034886921321&quot;), &quot;beacon 2 - No Beacon found!&quot;);

            Assert.AreEqual(900, a.SupressionTime, &quot;beacon 2 - Wrong supression time!&quot;);
            Assert.AreEqual(0, a.Delay, &quot;beacon 2 - Different delay is set&quot;);

            Assert.AreEqual(string.Empty, a.BeaconAction.Subject, &quot;beacon 2 - Different action subject&quot;);
            Assert.AreEqual(string.Empty, a.BeaconAction.Body, &quot;beacon 2 - Different action body&quot;);
            Assert.AreEqual(&quot;http://www.visitfinland.com/&quot;, a.BeaconAction.Url, &quot;beacon 2 - wrong url is set&quot;);
            Assert.IsNull(a.BeaconAction.Payload, &quot;beacon 2 - Payload is not null&quot;);

            Assert.AreEqual(1, a.Timeframes.Count, &quot;beacon 2 - More timeframes are set&quot;);
            Assert.AreEqual(new DateTime(2015, 04, 16, 12, 33, 48, 627), a.Timeframes[0].Start.Value.DateTime, &quot;beacon 2 - Different timesetting&quot;);

            Assert.AreEqual(3, (int) a.BeaconAction.Type, &quot;beacon 2 - Different type&quot;);
            Assert.IsFalse(a.SendOnlyOnce, &quot;beacon 2 - Send only once is set&quot;);


            a = layout.ResolvedActions.FirstOrDefault(t =&gt; t.BeaconAction.Uuid == &quot;312a8594e07542bd814ecdd17f76538e&quot;);
            Assert.AreEqual(1, (int) a.EventTypeDetectedByDevice, &quot;beacon 3 - Wrong trigger type&quot;);
            Assert.AreEqual(1, a.BeaconPids.Count, &quot;beacon 3 - Beacon count wrong&quot;);
            Assert.IsTrue(a.BeaconPids.Contains(&quot;7367672374000000ffff0000ffff00034886921321&quot;), &quot;beacon 3 - No Beacon found!&quot;);

            Assert.AreEqual(900, a.SupressionTime, &quot;beacon 3 - Wrong supression time!&quot;);
            Assert.AreEqual(0, a.Delay, &quot;beacon 3 - Different delay is set&quot;);

            Assert.AreEqual(string.Empty, a.BeaconAction.Subject, &quot;beacon 3 - Different action subject&quot;);
            Assert.AreEqual(string.Empty, a.BeaconAction.Body, &quot;beacon 3 - Different action body&quot;);
            Assert.AreEqual(&quot;http://www.visitfinland.com/&quot;, a.BeaconAction.Url, &quot;beacon 3 - wrong url is set&quot;);
            Assert.IsNull(a.BeaconAction.Payload, &quot;beacon 3 - Payload is not null&quot;);

            Assert.AreEqual(1, a.Timeframes.Count, &quot;beacon 3 - More timeframes are set&quot;);
            Assert.AreEqual(new DateTime(2015, 04, 16, 12, 34, 22, 596), a.Timeframes[0].Start.Value.DateTime, &quot;beacon 3 - Different timesetting&quot;);

            Assert.AreEqual(3, (int) a.BeaconAction.Type, &quot;beacon 3 - Different type&quot;);
            Assert.IsFalse(a.SendOnlyOnce, &quot;beacon 3 - Send only once is set&quot;);


            a = layout.ResolvedActions.FirstOrDefault(t =&gt; t.BeaconAction.Uuid == &quot;959ea393e3424ab7ad53584a8b789197&quot;);
            Assert.AreEqual(1, (int) a.EventTypeDetectedByDevice, &quot;beacon 4 - Wrong trigger type&quot;);
            Assert.AreEqual(1, a.BeaconPids.Count, &quot;beacon 4 - Beacon count wrong&quot;);
            Assert.IsTrue(a.BeaconPids.Contains(&quot;7367672374000000ffff0000ffff00034895330988&quot;), &quot;beacon 4 - No Beacon found!&quot;);

            Assert.AreEqual(900, a.SupressionTime, &quot;beacon 4 - Wrong supression time!&quot;);
            Assert.AreEqual(60, a.Delay, &quot;beacon 4 - Different delay is set&quot;);

            Assert.AreEqual(&quot;Delay 1 minute&quot;, a.BeaconAction.Subject, &quot;beacon 4 - Different action subject&quot;);
            Assert.AreEqual(&quot;Delay 1 minute&quot;, a.BeaconAction.Body, &quot;beacon 4 - Different action body&quot;);
            Assert.AreEqual(&quot;http://www.microsoft.com&quot;, a.BeaconAction.Url, &quot;beacon 4 - wrong url is set&quot;);
            Assert.IsNull(a.BeaconAction.Payload, &quot;beacon 4 - Payload is not null&quot;);

            Assert.AreEqual(1, a.Timeframes.Count, &quot;beacon 4 - More timeframes are set&quot;);
            Assert.AreEqual(new DateTime(2015, 04, 30, 08, 05, 54, 432), a.Timeframes[0].Start.Value.DateTime, &quot;beacon 4 - Different timesetting&quot;);

            Assert.AreEqual(1, (int) a.BeaconAction.Type, &quot;beacon 4 - Different type&quot;);
            Assert.IsFalse(a.SendOnlyOnce, &quot;beacon 4 - Send only once is set&quot;);


            a = layout.ResolvedActions.FirstOrDefault(t =&gt; t.BeaconAction.Uuid == &quot;351fd4b8b1c34da6b827e53acd79ff17&quot;);
            Assert.AreEqual(1, (int) a.EventTypeDetectedByDevice, &quot;beacon 5 - Wrong trigger type&quot;);
            Assert.AreEqual(1, a.BeaconPids.Count, &quot;beacon 5 - Beacon count wrong&quot;);
            Assert.IsTrue(a.BeaconPids.Contains(&quot;7367672374000000ffff0000ffff00034886921321&quot;), &quot;beacon 5 - No Beacon found!&quot;);

            Assert.AreEqual(900, a.SupressionTime, &quot;beacon 5 - Wrong supression time!&quot;);
            Assert.AreEqual(0, a.Delay, &quot;beacon 5 - Different delay is set&quot;);

            Assert.AreEqual(string.Empty, a.BeaconAction.Subject, &quot;beacon 5 - Different action subject&quot;);
            Assert.AreEqual(string.Empty, a.BeaconAction.Body, &quot;beacon 5 - Different action body&quot;);
            Assert.AreEqual(&quot;http://www.visitfinland.com/&quot;, a.BeaconAction.Url, &quot;beacon 5 - wrong url is set&quot;);
            Assert.IsNull(a.BeaconAction.Payload, &quot;beacon 5 - Payload is not null&quot;);

            Assert.AreEqual(1, a.Timeframes.Count, &quot;beacon 5 - More timeframes are set&quot;);
            Assert.AreEqual(new DateTime(2015, 04, 16, 12, 33, 28, 264), a.Timeframes[0].Start.Value.DateTime, &quot;beacon 5 - Different timesetting&quot;);

            Assert.AreEqual(3, (int) a.BeaconAction.Type, &quot;beacon 5 - Different type&quot;);
            Assert.IsFalse(a.SendOnlyOnce, &quot;beacon 5 - Send only once is set&quot;);


            a = layout.ResolvedActions.FirstOrDefault(t =&gt; t.BeaconAction.Uuid == &quot;a5009f851ded4ce68d9b1b4ff6db6137&quot;);
            Assert.AreEqual(1, (int) a.EventTypeDetectedByDevice, &quot;beacon 7- Wrong trigger type&quot;);
            Assert.AreEqual(1, a.BeaconPids.Count, &quot;beacon 7 - Beacon count wrong&quot;);
            Assert.IsTrue(a.BeaconPids.Contains(&quot;7367672374000000ffff0000ffff00073918758763&quot;), &quot;beacon 7 - No Beacon found!&quot;);

            Assert.AreEqual(31536000, a.SupressionTime, &quot;beacon 7 - Wrong supression time!&quot;);
            Assert.AreEqual(0, a.Delay, &quot;beacon 7 - Different delay is set&quot;);

            Assert.AreEqual(&quot;You&#180;re in the year 2017!&quot;, a.BeaconAction.Subject, &quot;beacon 7 - Different action subject&quot;);
            Assert.AreEqual(&quot;It&#180;s a great year&quot;, a.BeaconAction.Body, &quot;beacon 7 - Different action body&quot;);
            Assert.AreEqual(&quot;http://www.visitfinland.com/&quot;, a.BeaconAction.Url, &quot;beacon 7 - wrong url is set&quot;);
            Assert.IsNull(a.BeaconAction.Payload, &quot;beacon 7 - Payload is not null&quot;);

            Assert.AreEqual(1, a.Timeframes.Count, &quot;beacon 7 - More timeframes are set&quot;);
            Assert.AreEqual(new DateTime(2016, 12, 31, 11, 00, 00, 00), a.Timeframes[0].Start.Value.DateTime, &quot;beacon 7 - Different timesetting&quot;);
            Assert.AreEqual(new DateTime(2017, 12, 31, 11, 00, 00, 00), a.Timeframes[0].End.Value.DateTime, &quot;beacon 7 - Different timesetting&quot;);

            Assert.AreEqual(1, (int) a.BeaconAction.Type, &quot;beacon 7 - Different type&quot;);
            Assert.IsFalse(a.SendOnlyOnce, &quot;beacon 7 - Send only once is set&quot;);


            a = layout.ResolvedActions.FirstOrDefault(t =&gt; t.BeaconAction.Uuid == &quot;4224871362624826b510141da0d4fc5d&quot;);
            Assert.AreEqual(1, (int) a.EventTypeDetectedByDevice, &quot;beacon 8- Wrong trigger type&quot;);
            Assert.AreEqual(1, a.BeaconPids.Count, &quot;beacon 8 - Beacon count wrong&quot;);
            Assert.IsTrue(a.BeaconPids.Contains(&quot;7367672374000000ffff0000ffff00062343028018&quot;), &quot;beacon 8 - No Beacon found!&quot;);

            Assert.AreEqual(-1, a.SupressionTime, &quot;beacon 8 - Wrong supression time!&quot;);
            Assert.AreEqual(0, a.Delay, &quot;beacon 8 - Different delay is set&quot;);

            Assert.AreEqual(string.Empty, a.BeaconAction.Subject, &quot;beacon 8 - Different action subject&quot;);
            Assert.AreEqual(string.Empty, a.BeaconAction.Body, &quot;beacon 8 - Different action body&quot;);
            Assert.AreEqual(&quot;payload://is.awesome&quot;, a.BeaconAction.Url, &quot;beacon 8 - wrong url is set&quot;);
            Assert.IsNotNull(a.BeaconAction.Payload, &quot;beacon 8 - Payload is null&quot;);
            Assert.AreEqual(a.BeaconAction.Payload.ToString(), JsonObject.Parse(&quot;{\&quot;payload\&quot;:\&quot;is\&quot;,\&quot;awesome\&quot;:true}&quot;).ToString());

            Assert.AreEqual(1, a.Timeframes.Count, &quot;beacon 8 - More timeframes are set&quot;);
            Assert.AreEqual(new DateTime(2015, 04, 16, 12, 48, 51, 828), a.Timeframes[0].Start.Value.DateTime, &quot;beacon 8 - Different timesetting&quot;);

            Assert.AreEqual(3, (int) a.BeaconAction.Type, &quot;beacon 8 - Different type&quot;);
            Assert.IsFalse(a.SendOnlyOnce, &quot;beacon 8 - Send only once is set&quot;);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[60,9,60,10,1],[61,13,61,61,1],[62,13,62,108,1],[63,13,63,120,1],[64,13,64,120,1],[65,13,65,120,1],[66,13,66,120,1],[67,13,67,79,1],[69,13,69,75,1],[69,132,69,134,1],[70,13,70,100,1],[71,13,71,85,1],[72,13,72,127,1],[74,13,74,91,1],[75,13,75,78,1],[77,13,77,106,1],[78,13,78,100,1],[79,13,79,112,1],[80,13,80,85,1],[82,13,82,90,1],[83,13,83,148,1],[85,13,85,88,1],[86,13,86,80,1],[89,13,89,60,1],[89,117,89,119,1],[90,13,90,100,1],[91,13,91,85,1],[92,13,92,127,1],[94,13,94,89,1],[95,13,95,78,1],[97,13,97,106,1],[98,13,98,100,1],[99,13,99,112,1],[100,13,100,85,1],[102,13,102,90,1],[103,13,103,148,1],[105,13,105,88,1],[106,13,106,80,1],[109,13,109,60,1],[109,117,109,119,1],[110,13,110,100,1],[111,13,111,85,1],[112,13,112,127,1],[114,13,114,89,1],[115,13,115,78,1],[117,13,117,106,1],[118,13,118,100,1],[119,13,119,112,1],[120,13,120,85,1],[122,13,122,90,1],[123,13,123,148,1],[125,13,125,88,1],[126,13,126,80,1],[129,13,129,60,1],[129,117,129,119,1],[130,13,130,100,1],[131,13,131,85,1],[132,13,132,127,1],[134,13,134,89,1],[135,13,135,79,1],[137,13,137,110,1],[138,13,138,104,1],[139,13,139,108,1],[140,13,140,85,1],[142,13,142,90,1],[143,13,143,148,1],[145,13,145,88,1],[146,13,146,80,1],[149,13,149,60,1],[149,117,149,119,1],[150,13,150,100,1],[151,13,151,85,1],[152,13,152,127,1],[154,13,154,89,1],[155,13,155,78,1],[157,13,157,106,1],[158,13,158,100,1],[159,13,159,112,1],[160,13,160,85,1],[162,13,162,90,1],[163,13,163,148,1],[165,13,165,88,1],[166,13,166,80,1],[169,13,169,60,1],[169,117,169,119,1],[170,13,170,99,1],[171,13,171,85,1],[172,13,172,127,1],[174,13,174,94,1],[175,13,175,78,1],[177,13,177,120,1],[178,13,178,107,1],[179,13,179,112,1],[180,13,180,85,1],[182,13,182,90,1],[183,13,183,147,1],[184,13,184,145,1],[186,13,186,88,1],[187,13,187,80,1],[190,13,190,60,1],[190,117,190,119,1],[191,13,191,99,1],[192,13,192,85,1],[193,13,193,127,1],[195,13,195,88,1],[196,13,196,78,1],[198,13,198,106,1],[199,13,199,100,1],[200,13,200,104,1],[201,13,201,84,1],[202,13,202,134,1],[204,13,204,90,1],[205,13,205,148,1],[207,13,207,88,1],[208,13,208,80,1],[209,9,209,10,1],[25,9,25,10,1],[26,13,26,53,1],[27,13,27,36,1],[28,13,28,67,1],[29,13,29,64,1],[30,13,30,96,1],[31,13,31,52,1],[32,9,32,10,1],[36,9,36,10,1],[37,13,37,72,1],[38,9,38,10,1],[42,9,42,10,1],[43,13,43,67,1],[44,13,44,51,1],[45,13,45,46,1],[46,13,46,73,1],[47,13,47,66,1],[48,13,48,89,1],[49,13,49,74,1],[50,9,50,10,1],[53,9,53,10,1],[54,13,54,89,1],[55,13,55,44,1],[56,13,56,40,1],[57,9,57,10,1],[69,75,69,132,1],[89,60,89,117,1],[109,60,109,117,1],[129,60,129,117,1],[149,60,149,117,1],[169,60,169,117,1],[190,60,190,117,1]]);
    </script>
  </body>
</html>