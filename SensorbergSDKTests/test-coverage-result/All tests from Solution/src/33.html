<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>d:\work\sensorberg\windows10-sdk\sensorbergsdk\scanner.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using SensorbergSDK.Internal;
using System;
using System.Collections.Generic;
using System.Threading;
using Windows.Devices.Bluetooth;
using Windows.Devices.Bluetooth.Advertisement;
using MetroLog;
using SensorbergSDK.Services;

namespace SensorbergSDK
{
    public enum ScannerStatus
    {
        Stopped,
        Started,
        Aborted
    }

    /// &lt;summary&gt;
    /// Bluetooth LE advertisement scanner helper class with beacon list management.
    /// &lt;/summary&gt;
	public sealed class Scanner : IBeaconScanner, IDisposable
    {
        private static readonly ILogger logger = LogManagerFactory.DefaultLogManager.GetLogger&lt;Scanner&gt;();
        /// &lt;summary&gt;
        /// Triggered when the scanner is either started, stopped or aborted.
        /// Aborted status may indicate that the bluetooth has not been turned on on the device.
        /// &lt;/summary&gt;
        public event EventHandler&lt;ScannerStatus&gt; StatusChanged;

        public event EventHandler&lt;BeaconEventArgs&gt; BeaconEvent;

        /// &lt;summary&gt;
        /// Triggered when beacon hasn&#39;t been seen for a time defined in BeaconNotSeenDelayInMilliseconds.
        /// &lt;/summary&gt;
        public event EventHandler&lt;Beacon&gt; BeaconNotSeenForAWhile;

        private readonly BeaconContainer _beaconsContainer;
        private BluetoothLEAdvertisementWatcher _bluetoothLEAdvertisementWatcher;
        private BluetoothLEManufacturerData _bluetoothLeManufacturerData;
        private Timer _beaconListRefreshTimer;
        private Timer _notifyStartedDelayTimer;

        private UInt64 _beaconExitTimeout;
        private UInt64? _enterDistanceThreshold;

        private ScannerStatus _status;
        /// &lt;summary&gt;
        /// Defines whether the scanner (bluetooth advertisement watcher) has been started or not.
        /// When the watcher is started, the timer for checking up on the list of beacons is
        /// started as well.
        /// &lt;/summary&gt;
        public ScannerStatus Status
        {
            get
            {
                return _status;
            }
            private set
            {
                if (_status != value)
                {
                    _status = value;

                    if (_notifyStartedDelayTimer != null)
                    {
                        _notifyStartedDelayTimer.Dispose();
                        _notifyStartedDelayTimer = null;
                    }

                    if (_status == ScannerStatus.Started)
                    {
                        if (_beaconListRefreshTimer == null)
                        {
                            _beaconListRefreshTimer = new Timer(CheckListForOldBeacons, null,
                                Constants.BeaconsListRefreshIntervalInMilliseconds, Constants.BeaconsListRefreshIntervalInMilliseconds);
                        }

                        // Delay the notification in case there is an immediate error (e.g. when
                        // the bluetooth is not turned on the device.
                        _notifyStartedDelayTimer = new Timer(OnNotifyStartedDelayTimeout, null, 500, Timeout.Infinite);
                    }
                    else
                    {
                        // Notify immediately
                        if (StatusChanged != null)
                        {
                            StatusChanged(this, _status);
                        }
                    }
                }
            }
        }

        /// &lt;summary&gt;
        /// Constructor
        /// &lt;/summary&gt;
        public Scanner()
        {
            _status = ScannerStatus.Stopped;
            _beaconsContainer = new BeaconContainer();
        }

        /// &lt;summary&gt;
        /// Starts the watcher and hooks its events to callbacks.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;manufacturerId&quot;&gt;The manufacturer ID.&lt;/param&gt;
        /// &lt;param name=&quot;beaconCode&quot;&gt;The beacon code.&lt;/param&gt;
        /// &lt;param name=&quot;beaconExitTimeoutInMiliseconds&quot;&gt;Time in miliseconds after beacon will be trated as lost&lt;/param&gt;
        /// &lt;param name=&quot;rssiEnterThreshold&quot;&gt;Optional rssi threshold which will trigger beacon discover event. Value must be between -128 and 127&lt;/param&gt;
        /// &lt;param name=&quot;enterDistanceThreshold&quot;&gt;Optional minimal distance in meters that will trigger beacon discover event&lt;/param&gt;
        public void StartWatcher(UInt16 manufacturerId, UInt16 beaconCode, UInt64 beaconExitTimeoutInMiliseconds, Int16? rssiEnterThreshold = null, UInt64? enterDistanceThreshold = null)
        {
            _beaconExitTimeout = beaconExitTimeoutInMiliseconds;
            _enterDistanceThreshold = enterDistanceThreshold;

            if (_beaconExitTimeout &lt; 1000)
            {
                _beaconExitTimeout = 1000;
            }

            if (Status != ScannerStatus.Started)
            {
                if (_bluetoothLEAdvertisementWatcher == null)
                {
                    _bluetoothLeManufacturerData = BeaconFactory.BeaconManufacturerData(manufacturerId, beaconCode);
                    _bluetoothLEAdvertisementWatcher = new BluetoothLEAdvertisementWatcher();
                    _bluetoothLEAdvertisementWatcher.AdvertisementFilter.Advertisement.ManufacturerData.Add(_bluetoothLeManufacturerData);
                    _bluetoothLEAdvertisementWatcher.SignalStrengthFilter.SamplingInterval = TimeSpan.FromMilliseconds(0);
                    _bluetoothLEAdvertisementWatcher.SignalStrengthFilter.OutOfRangeTimeout = TimeSpan.FromMilliseconds(_beaconExitTimeout);
                    _bluetoothLEAdvertisementWatcher.ScanningMode = BluetoothLEScanningMode.Active;

                    if (rssiEnterThreshold != null &amp;&amp; rssiEnterThreshold.Value &gt;= -128 &amp;&amp; rssiEnterThreshold.Value &lt;= 127)
                    {
                        _bluetoothLEAdvertisementWatcher.SignalStrengthFilter = new BluetoothSignalStrengthFilter() { InRangeThresholdInDBm = rssiEnterThreshold.Value };
                    }
                }

                _bluetoothLEAdvertisementWatcher.Received += OnAdvertisementReceived;
                _bluetoothLEAdvertisementWatcher.Stopped += OnWatcherStopped;
                _bluetoothLEAdvertisementWatcher.Start();

                Status = ScannerStatus.Started;
                logger.Debug(&quot;Scanner.StartWatcher(): Watcher started&quot;);
            }
        }

        /// &lt;summary&gt;
        /// Stops the watcher. The events are unhooked in the callback (OnWatcherStopped).
        /// &lt;/summary&gt;
        public void StopWatcher()
        {
            if (Status == ScannerStatus.Started)
            {
                _bluetoothLEAdvertisementWatcher?.Stop();
            }
        }

        /// &lt;summary&gt;
        /// Notifies any listeners about the beacon event.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;beacon&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;eventType&quot;&gt;&lt;/param&gt;
        private void NotifyBeaconEvent(Beacon beacon, BeaconEventType eventType)
        {
            if (BeaconEvent != null)
            {
                BeaconEvent(this, new BeaconEventArgs() { Beacon = beacon, EventType = eventType });
            }
        }

        /// &lt;summary&gt;
        /// Checks the list of beacons for old beacons. If old enough beacons are found, an
        /// exit event for them is generated and they are removed from the list.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;state&quot;&gt;&lt;/param&gt;
        private void CheckListForOldBeacons(object state)
        {
            List&lt;Beacon&gt; beacons = _beaconsContainer.RemoveBeaconsBasedOnAge(_beaconExitTimeout);

            foreach (Beacon beacon in beacons)
            {
                NotifyBeaconEvent(beacon, BeaconEventType.Exit);
            }

            beacons = _beaconsContainer.BeaconsBasedOnAge(_beaconExitTimeout);

            if (BeaconNotSeenForAWhile != null)
            {
                foreach (Beacon beacon in beacons)
                {
                    BeaconNotSeenForAWhile(this, beacon);
                }
            }

            if (Status != ScannerStatus.Started &amp;&amp; _beaconsContainer.Count == 0 &amp;&amp; _beaconListRefreshTimer != null)
            {
                _beaconListRefreshTimer.Dispose();
                _beaconListRefreshTimer = null;
            }
        }

        /// &lt;summary&gt;
        /// Triggered when the watcher receives an advertisement.
        /// 
        /// If the advertisement came from a beacon, a Beacon instance is created based on the
        /// received data. A new beacon is added to the list and an existing one is only updated.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;args&quot;&gt;&lt;/param&gt;
        private void OnAdvertisementReceived(BluetoothLEAdvertisementWatcher sender, BluetoothLEAdvertisementReceivedEventArgs args)
        {
            logger.Debug(&quot;Scanner: Advertisement received &quot; + args.Timestamp.ToString(&quot;HH:mm:ss.fff&quot;));
            Beacon beacon = BeaconFactory.BeaconFromBluetoothLEAdvertisementReceivedEventArgs(args);

            if (beacon != null)
            {
                if (_enterDistanceThreshold != null &amp;&amp; beacon.Distance &gt; _enterDistanceThreshold.Value)
                {
                    return;
                }

                bool isExistingBeacon = _beaconsContainer.TryUpdate(beacon);
                logger.Trace(&quot;Scanner: beacon exists:&quot; + isExistingBeacon + &quot; &quot; + beacon.Id1 + &quot; &quot; + beacon.Id2 + &quot; &quot; + beacon.Id3);
                if (isExistingBeacon)
                {
                    NotifyBeaconEvent(beacon, BeaconEventType.None);

                }
                else
                {
                    _beaconsContainer.Add(beacon);
                    NotifyBeaconEvent(beacon, BeaconEventType.Enter);
                }
            }
        }

        private void OnWatcherStopped(BluetoothLEAdvertisementWatcher sender, BluetoothLEAdvertisementWatcherStoppedEventArgs args)
        {
            if (_bluetoothLEAdvertisementWatcher != null)
            {
                logger.Debug(&quot;Scanner: .OnWatcherStopped(): Status: &quot; + _bluetoothLEAdvertisementWatcher.Status);

                if (_bluetoothLEAdvertisementWatcher.Status == BluetoothLEAdvertisementWatcherStatus.Aborted)
                {
                    Status = ScannerStatus.Aborted;
                }
                else
                {
                    Status = ScannerStatus.Stopped;
                }

                _bluetoothLEAdvertisementWatcher.Received -= OnAdvertisementReceived;
                _bluetoothLEAdvertisementWatcher.Stopped -= OnWatcherStopped;
                _bluetoothLEAdvertisementWatcher = null;
            }
        }

        /// &lt;summary&gt;
        /// Sends a delayed notifications about watcher started event.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;state&quot;&gt;&lt;/param&gt;
        private void OnNotifyStartedDelayTimeout(object state)
        {
            if (_notifyStartedDelayTimer != null)
            {
                _notifyStartedDelayTimer.Dispose();
                _notifyStartedDelayTimer = null;
            }

            if (StatusChanged != null)
            {
                StatusChanged(this, _status);
            }
        }

        public void Dispose()
        {
            _beaconListRefreshTimer?.Dispose();
            _notifyStartedDelayTimer?.Dispose();
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[56,13,56,14,0],[57,17,57,32,0],[58,13,58,14,0],[60,13,60,14,0],[61,17,61,38,0],[62,17,62,18,0],[63,21,63,37,0],[65,21,65,58,0],[66,21,66,22,0],[67,25,67,60,0],[68,25,68,57,0],[69,21,69,22,0],[71,21,71,58,0],[72,21,72,22,0],[73,25,73,61,0],[74,25,74,26,0],[75,29,76,137,0],[77,25,77,26,0],[81,25,81,120,0],[82,21,82,22,0],[84,21,84,22,0],[86,25,86,51,0],[87,25,87,26,0],[88,29,88,58,0],[89,25,89,26,0],[90,21,90,22,0],[91,17,91,18,0],[92,13,92,14,0],[113,9,113,10,0],[114,13,114,65,0],[115,13,115,62,0],[117,13,117,43,0],[118,13,118,14,0],[119,17,119,43,0],[120,13,120,14,0],[122,13,122,49,0],[123,13,123,14,0],[124,17,124,62,0],[125,17,125,18,0],[126,21,126,117,0],[127,21,127,94,0],[128,21,128,139,0],[129,21,129,123,0],[130,21,130,141,0],[131,21,131,100,0],[133,21,133,123,0],[134,21,134,22,0],[135,25,135,170,0],[136,21,136,22,0],[137,17,137,18,0],[139,17,139,86,0],[140,17,140,78,0],[141,17,141,58,0],[143,17,143,48,0],[144,17,144,73,0],[145,13,145,14,0],[146,9,146,10,0],[152,9,152,10,0],[153,13,153,49,0],[154,13,154,14,0],[155,17,155,58,0],[156,13,156,14,0],[157,9,157,10,0],[165,9,165,10,0],[166,13,166,37,0],[167,13,167,14,0],[168,17,168,101,0],[169,13,169,14,0],[170,9,170,10,0],[178,9,178,10,0],[179,13,179,98,0],[181,13,181,20,0],[181,39,181,46,0],[181,22,181,35,0],[182,13,182,14,0],[183,17,183,65,0],[184,13,184,14,0],[181,36,181,38,0],[186,13,186,79,0],[188,13,188,48,0],[189,13,189,14,0],[190,17,190,24,0],[190,43,190,50,0],[190,26,190,39,0],[191,17,191,18,0],[192,21,192,58,0],[193,17,193,18,0],[190,40,190,42,0],[194,13,194,14,0],[196,13,196,116,0],[197,13,197,14,0],[198,17,198,51,0],[199,17,199,48,0],[200,13,200,14,0],[201,9,201,10,0],[212,9,212,10,0],[213,13,213,104,0],[214,13,214,101,0],[216,13,216,32,0],[217,13,217,14,0],[218,17,218,104,0],[219,17,219,18,0],[220,21,220,28,0],[223,17,223,77,0],[224,17,224,133,0],[225,17,225,38,0],[226,17,226,18,0],[227,21,227,69,0],[229,17,229,18,0],[231,17,231,18,0],[232,21,232,51,0],[233,21,233,70,0],[234,17,234,18,0],[235,13,235,14,0],[236,9,236,10,0],[239,9,239,10,0],[240,13,240,58,0],[241,13,241,14,0],[242,17,242,114,0],[244,17,244,110,0],[245,17,245,18,0],[246,21,246,52,0],[247,17,247,18,0],[249,17,249,18,0],[250,21,250,52,0],[251,17,251,18,0],[253,17,253,86,0],[254,17,254,78,0],[255,17,255,57,0],[256,13,256,14,0],[257,9,257,10,0],[264,9,264,10,0],[265,13,265,50,0],[266,13,266,14,0],[267,17,267,52,0],[268,17,268,49,0],[269,13,269,14,0],[271,13,271,39,0],[272,13,272,14,0],[273,17,273,46,0],[274,13,274,14,0],[275,9,275,10,0],[278,9,278,10,0],[279,13,279,48,0],[280,13,280,49,0],[281,9,281,10,0],[24,9,24,107,0],[98,9,98,25,1],[99,9,99,10,1],[100,13,100,45,1],[101,13,101,55,1],[102,9,102,10,1]]);
    </script>
  </body>
</html>