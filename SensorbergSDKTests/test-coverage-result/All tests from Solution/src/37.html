<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>d:\work\sensorberg\windows10-sdk\sensorbergsdk\internal\data\beaconcontainer.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;

namespace SensorbergSDK.Internal
{
    /// &lt;summary&gt;
    /// A container class for managing a set of current beacons.
    /// &lt;/summary&gt;
    public class BeaconContainer
    {
        private readonly List&lt;Beacon&gt; _beacons;
        private readonly object _beaconListLock;

        /// &lt;summary&gt;
        /// The number of beacons in the container.
        /// &lt;/summary&gt;
        public int Count
        {
            get
            {
                return _beacons.Count;
            }
        }

        /// &lt;summary&gt;
        /// Constructor.
        /// &lt;/summary&gt;
        public BeaconContainer()
        {
            _beaconListLock = new object();
            _beacons = new List&lt;Beacon&gt;();
        }

        /// &lt;summary&gt;
        /// Adds the given beacon to this container.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;beacon&quot;&gt;The beacon to add.&lt;/param&gt;
        /// &lt;param name=&quot;overwrite&quot;&gt;If true, will update a matching beacon.&lt;/param&gt;
        public void Add(Beacon beacon, bool overwrite = false)
        {
            if (beacon == null)
            {
                return;
            }

            if (overwrite)
            {
                if (!TryUpdate(beacon))
                {
                    SaveAddBeacon(beacon);
                }
            }
            else
            {
                SaveAddBeacon(beacon);
            }
        }

        /// &lt;param name=&quot;beacon&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;True, if the given beacon matches an existing one in this container.&lt;/returns&gt;
        public bool Contains(Beacon beacon)
        {
            bool found = false;

            lock (_beaconListLock)
            {
                foreach (Beacon existingBeacon in _beacons)
                {
                    if (beacon.Matches(existingBeacon))
                    {
                        found = true;
                        break;
                    }
                }
            }

            return found;
        }

        /// &lt;summary&gt;
        /// Updates a matching beacon in the list based on the given one, if found.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;beacon&quot;&gt;The beacon, with latest data, to update.&lt;/param&gt;
        /// &lt;returns&gt;True, if updated. False, if no matching beacon was found.&lt;/returns&gt;
        public bool TryUpdate(Beacon beacon)
        {
            lock (_beaconListLock)
            {
                for (int i = 0; i &lt; _beacons.Count; ++i)
                {
                    if (beacon.Matches(_beacons[i]))
                    {
                        _beacons[i] = beacon;
                        return true;
                    }
                }
            }

            return false;
        }

        /// &lt;summary&gt;
        /// Removes the beacons, which are older than the given age, from this container.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;olderThanAgeInMilliseconds&quot;&gt;The minimum age of the beacons, which should be removed.&lt;/param&gt;
        /// &lt;returns&gt;A list of removed beacons.&lt;/returns&gt;
        public List&lt;Beacon&gt; RemoveBeaconsBasedOnAge(UInt64 olderThanAgeInMilliseconds)
        {
            List&lt;Beacon&gt; removedBeacons = new List&lt;Beacon&gt;();

            if (_beacons.Count &gt; 0)
            {
                TimeSpan ageAsTimeSpan = TimeSpan.FromMilliseconds(olderThanAgeInMilliseconds);

                lock (_beaconListLock)
                {
                    for (int i = _beacons.Count - 1; i &gt;= 0; --i)
                    {
                        var currentBeacon = _beacons[i];

                        if (currentBeacon.Timestamp.Add(ageAsTimeSpan) &lt; DateTime.Now)
                        {
                            System.Diagnostics.Debug.WriteLine(&quot;CurrentBeaconsContainer.RemoveOldBeacons(): &quot;
                                + string.Format(&quot;Last seen {0:mm:ss}, time is now {1:mm:ss} =&gt; exit&quot;,
                                    currentBeacon.Timestamp, DateTime.Now));

                            removedBeacons.Add(currentBeacon);
                            _beacons.RemoveAt(i);
                        }
                    }
                }
            }

            return removedBeacons;
        }

        /// &lt;summary&gt;
        /// Finds the beacons, which are older than the given age.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;olderThanAgeInMilliseconds&quot;&gt;The minimum age of the beacons to find.&lt;/param&gt;
        /// &lt;returns&gt;A list of beacons matching the age criteria.&lt;/returns&gt;
        public List&lt;Beacon&gt; BeaconsBasedOnAge(UInt64 olderThanAgeInMilliseconds)
        {
            List&lt;Beacon&gt; beacons = new List&lt;Beacon&gt;();
            TimeSpan ageAsTimeSpan = TimeSpan.FromMilliseconds(olderThanAgeInMilliseconds);

            lock (_beaconListLock)
            {
                foreach (Beacon beacon in _beacons)
                {
                    if (beacon.Timestamp.Add(ageAsTimeSpan) &lt; DateTime.Now)
                    {
                        beacons.Add(beacon);
                    }
                }
            }

            return beacons;
        }

        /// &lt;summary&gt;
        /// Locks collection and add beacon to it
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;beacon&quot;&gt;Beacon to add&lt;/param&gt;
        private void SaveAddBeacon(Beacon beacon)
        {
            lock (_beaconListLock)
            {
                _beacons.Add(beacon);
            }
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[20,13,20,14,0],[21,17,21,39,0],[22,13,22,14,0],[40,9,40,10,0],[41,13,41,32,0],[42,13,42,14,0],[43,17,43,24,0],[46,13,46,27,0],[47,13,47,14,0],[48,17,48,40,0],[49,17,49,18,0],[50,21,50,43,0],[51,17,51,18,0],[52,13,52,14,0],[54,13,54,14,0],[55,17,55,39,0],[56,13,56,14,0],[57,9,57,10,0],[62,9,62,10,0],[63,13,63,32,0],[65,13,65,35,0],[66,13,66,14,0],[67,17,67,24,0],[67,51,67,59,0],[67,26,67,47,0],[68,17,68,18,0],[69,21,69,56,0],[70,21,70,22,0],[71,25,71,38,0],[72,25,72,31,0],[74,17,74,18,0],[67,48,67,50,0],[75,13,75,14,0],[77,13,77,26,0],[78,9,78,10,0],[86,9,86,10,0],[87,13,87,35,0],[88,13,88,14,0],[89,22,89,31,0],[90,17,90,18,0],[91,21,91,53,0],[92,21,92,22,0],[93,25,93,46,0],[94,25,94,37,0],[96,17,96,18,0],[89,53,89,56,0],[89,33,89,51,0],[97,13,97,14,0],[99,13,99,26,0],[100,9,100,10,0],[108,9,108,10,0],[109,13,109,62,0],[111,13,111,36,0],[112,13,112,14,0],[113,17,113,96,0],[115,17,115,39,0],[116,17,116,18,0],[117,26,117,52,0],[118,21,118,22,0],[119,25,119,57,0],[121,25,121,87,0],[122,25,122,26,0],[123,29,125,77,0],[127,29,127,63,0],[128,29,128,50,0],[129,25,129,26,0],[130,21,130,22,0],[117,62,117,65,0],[117,54,117,60,0],[131,17,131,18,0],[132,13,132,14,0],[134,13,134,35,0],[135,9,135,10,0],[143,9,143,10,0],[144,13,144,55,0],[145,13,145,92,0],[147,13,147,35,0],[148,13,148,14,0],[149,17,149,24,0],[149,43,149,51,0],[149,26,149,39,0],[150,17,150,18,0],[151,21,151,76,0],[152,21,152,22,0],[153,25,153,45,0],[154,21,154,22,0],[155,17,155,18,0],[149,40,149,42,0],[156,13,156,14,0],[158,13,158,28,0],[159,9,159,10,0],[166,9,166,10,0],[167,13,167,35,0],[168,13,168,14,0],[169,17,169,38,0],[170,13,170,14,0],[171,9,171,10,0],[28,9,28,33,1],[29,9,29,10,1],[30,13,30,44,1],[31,13,31,43,1],[32,9,32,10,1]]);
    </script>
  </body>
</html>