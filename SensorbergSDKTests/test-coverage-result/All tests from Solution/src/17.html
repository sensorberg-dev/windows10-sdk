<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>d:\work\sensorberg\windows10-sdk\sensorbergsdktests\unittesteventhistory.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Threading.Tasks;
using Microsoft.VisualStudio.TestPlatform.UnitTestFramework;
using SensorbergSDK;
using SensorbergSDK.Internal;
using SensorbergSDK.Internal.Services;
using SensorbergSDKTests.Mocks;

namespace SensorbergSDKTests
{
    [TestClass]
    public class UnitTestEventHistory
    {
        [TestInitialize]
        public async Task Setup()
        {
            await TestHelper.ClearFiles(&quot;sensorberg-storage&quot;);
            ServiceManager.ReadOnlyForTests = false;
            ServiceManager.Clear();
            ServiceManager.ApiConnction = new MockApiConnection();
            ServiceManager.StorageService = new StorageService() {Storage = new MockStorage()};
            await ServiceManager.StorageService.InitStorage();
            ServiceManager.ReadOnlyForTests = true;
        }

        [TestMethod]
        public async Task EventHistory_ShouldSupress()
        {
            SDKData.Instance.ApiKey = &quot;540aa95ccf215718295c2c563a2090676994f09927f09a6e09a67c83be10b00c&quot;;
            var beacon = new Beacon();
            beacon.Id1 = &quot;7367672374000000ffff0000ffff0007&quot;;
            beacon.Id2 = 8008;
            beacon.Id3 = 5;
            beacon.Timestamp = DateTimeOffset.Now;
            var args = new BeaconEventArgs();
            args.Beacon = beacon;
            args.EventType = BeaconEventType.Exit;
            var resolvedActionEventArgs = new ResolvedActionsEventArgs() {BeaconPid = beacon.Pid, BeaconEventType = BeaconEventType.Enter};

            BeaconAction beaconaction1 = new BeaconAction() {Body = &quot;body&quot;, Url = &quot;http://www.com&quot;, Uuid = &quot;1223&quot;};
            BeaconAction beaconaction2 = new BeaconAction() {Body = &quot;body&quot;, Url = &quot;http://www.com&quot;, Uuid = &quot;5678&quot;};
            BeaconAction beaconaction3 = new BeaconAction() {Body = &quot;body&quot;, Url = &quot;http://www.com&quot;, Uuid = &quot;9678&quot;};
            ResolvedAction res1 = new ResolvedAction() {SupressionTime = 100, SendOnlyOnce = true, BeaconAction = beaconaction1};
            ResolvedAction res2 = new ResolvedAction() {SupressionTime = 100, SendOnlyOnce = true, BeaconAction = beaconaction2};
            ResolvedAction res3 = new ResolvedAction() {SupressionTime = 1, SendOnlyOnce = true, BeaconAction = beaconaction3};

            EventHistory eventHistory = new EventHistory();

            await eventHistory.SaveBeaconEventAsync(args);
            await eventHistory.SaveExecutedResolvedActionAsync(resolvedActionEventArgs, beaconaction1);
            await eventHistory.SaveExecutedResolvedActionAsync(resolvedActionEventArgs, beaconaction3);
            await Task.Delay(2000);

            bool shouldSupress1 = await eventHistory.ShouldSupressAsync(res1);
            bool shouldSupress2 = await eventHistory.ShouldSupressAsync(res2);
            bool shouldSupress3 = await eventHistory.ShouldSupressAsync(res3);

            Assert.IsTrue(shouldSupress1);
            Assert.IsFalse(shouldSupress2);
            Assert.IsFalse(shouldSupress3); //Supression time should be over
        }

        [TestMethod]
        public async Task EventHistory_FlushHistory()
        {
            SDKData.Instance.ApiKey = &quot;540aa95ccf215718295c2c563a2090676994f09927f09a6e09a67c83be10b00c&quot;;
            var beacon = new Beacon();
            beacon.Id1 = &quot;7367672374000000ffff0000ffff0007&quot;;
            beacon.Id2 = 8008;
            beacon.Id3 = 5;
            beacon.Timestamp = DateTimeOffset.Now;
            var args = new BeaconEventArgs();
            args.Beacon = beacon;
            args.EventType = BeaconEventType.Exit;
            var resolvedActionEventArgs = new ResolvedActionsEventArgs() {BeaconPid = beacon.Pid, BeaconEventType = BeaconEventType.Enter};

            BeaconAction beaconaction1 = new BeaconAction() {Body = &quot;body&quot;, Url = &quot;http://www.com&quot;, Uuid = &quot;1223&quot;};
            BeaconAction beaconaction2 = new BeaconAction() {Body = &quot;body&quot;, Url = &quot;http://www.com&quot;, Uuid = &quot;5678&quot;};
            BeaconAction beaconaction3 = new BeaconAction() {Body = &quot;body&quot;, Url = &quot;http://www.com&quot;, Uuid = &quot;9678&quot;};
            ResolvedAction res1 = new ResolvedAction() {SupressionTime = 100, SendOnlyOnce = true, BeaconAction = beaconaction1};
            ResolvedAction res2 = new ResolvedAction() {SupressionTime = 100, SendOnlyOnce = true, BeaconAction = beaconaction2};
            ResolvedAction res3 = new ResolvedAction() {SupressionTime = 1, SendOnlyOnce = true, BeaconAction = beaconaction3};

            EventHistory eventHistory = new EventHistory();

            await eventHistory.SaveBeaconEventAsync(args);
            await eventHistory.SaveExecutedResolvedActionAsync(resolvedActionEventArgs, beaconaction1);
            await eventHistory.SaveExecutedResolvedActionAsync(resolvedActionEventArgs, beaconaction3);

            await eventHistory.FlushHistoryAsync();
        }

    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[16,9,16,10,1],[17,13,17,63,1],[18,13,18,53,1],[19,13,19,36,1],[20,13,20,67,1],[21,13,21,96,1],[22,13,22,63,1],[23,13,23,52,1],[24,9,24,10,1],[28,9,28,10,1],[29,13,29,106,1],[30,13,30,39,1],[31,13,31,61,1],[32,13,32,31,1],[33,13,33,28,1],[34,13,34,51,1],[35,13,35,46,1],[36,13,36,34,1],[37,13,37,51,1],[38,13,38,140,1],[40,13,40,116,1],[41,13,41,116,1],[42,13,42,116,1],[43,13,43,130,1],[44,13,44,130,1],[45,13,45,128,1],[47,13,47,60,1],[49,13,49,59,1],[50,13,50,104,1],[51,13,51,104,1],[52,13,52,36,1],[54,13,54,79,1],[55,13,55,79,1],[56,13,56,79,1],[58,13,58,43,1],[59,13,59,44,1],[60,13,60,44,1],[61,9,61,10,1],[65,9,65,10,1],[66,13,66,106,1],[67,13,67,39,1],[68,13,68,61,1],[69,13,69,31,1],[70,13,70,28,1],[71,13,71,51,1],[72,13,72,46,1],[73,13,73,34,1],[74,13,74,51,1],[75,13,75,140,1],[77,13,77,116,1],[78,13,78,116,1],[79,13,79,116,1],[80,13,80,130,1],[81,13,81,130,1],[82,13,82,128,1],[84,13,84,60,1],[86,13,86,59,1],[87,13,87,104,1],[88,13,88,104,1],[90,13,90,52,1],[91,9,91,10,1]]);
    </script>
  </body>
</html>