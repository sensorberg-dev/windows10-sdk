<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>d:\work\sensorberg\windows10-sdk\sensorbergsdk\sdkmanager.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using SensorbergSDK.Internal;
using System;
using System.Diagnostics;
using System.Threading;
using System.Threading.Tasks;
using Windows.UI.Core;
using MetroLog;
using SensorbergSDK.Internal.Services;
using SensorbergSDK.Services;

namespace SensorbergSDK
{
    /// &lt;summary&gt;
    /// The main interface of Sensorberg SDK.
    /// &lt;/summary&gt;
    public sealed class SDKManager
    {
        private static ILogger logger = LogManagerFactory.DefaultLogManager.GetLogger&lt;SDKManager&gt;();
        public static readonly string DemoApiKey = Constants.DemoApiKey;
        private readonly int StartScannerIntervalInMilliseconds = 2000;
        private AppSettings _appSettings;
        private static SDKManager _instance;

        private readonly BackgroundTaskManager _backgroundTaskManager;
        private Timer _startScannerTimer;
        private bool _scannerShouldBeRunning;


        /// &lt;summary&gt;
        /// Fired when a beacon action has been successfully resolved and is ready to be exeuted.
        /// &lt;/summary&gt;
        public event EventHandler&lt;BeaconAction&gt; BeaconActionResolved
        {
            add
            {
                SdkEngine.BeaconActionResolved += value;
                _backgroundTaskManager.BackgroundBeaconActionResolved += value;
            }
            remove
            {
                SdkEngine.BeaconActionResolved -= value;
                _backgroundTaskManager.BackgroundBeaconActionResolved -= value;
            }
        }

        /// &lt;summary&gt;
        /// This event is fired, when a beacon actions could not be resolved.
        /// In most cases this event can be ignored.
        /// &lt;/summary&gt;
        public event EventHandler&lt;string&gt; FailedToResolveBeaconAction
        {
            add
            {
                SdkEngine.FailedToResolveBeaconAction += value;
            }
            remove
            {
                SdkEngine.FailedToResolveBeaconAction -= value;
            }
        }

        /// &lt;summary&gt;
        /// Fired, when the layout becomes valid/invalid.
        /// &lt;/summary&gt;
        public event EventHandler&lt;bool&gt; LayoutValidityChanged
        {
            add
            {
                SdkEngine.LayoutValidityChanged += value;
            }
            remove
            {
                SdkEngine.LayoutValidityChanged -= value;
            }
        }

        /// &lt;summary&gt;
        /// Triggered when the scanner is either started, stopped or aborted.
        /// Aborted status may indicate that the bluetooth has not been turned on on the device.
        /// &lt;/summary&gt;
        public event EventHandler&lt;ScannerStatus&gt; ScannerStatusChanged
        {
            add
            {
                Scanner.StatusChanged += value;
            }
            remove
            {
                Scanner.StatusChanged -= value;
            }
        }

        public event EventHandler BackgroundFiltersUpdated
        {
            add
            {
                _backgroundTaskManager.BackgroundFiltersUpdated += value;
            }
            remove
            {
                _backgroundTaskManager.BackgroundFiltersUpdated -= value;
            }
        }

        /// &lt;summary&gt;
        /// Instance of the SDKEngine.
        /// &lt;/summary&gt;
        private SDKEngine SdkEngine
        {
            [DebuggerStepThrough]
            get;
        }
        /// &lt;summary&gt;
        /// The scanner instance.
        /// &lt;/summary&gt;
        public IBeaconScanner Scanner
        {
            [DebuggerStepThrough]
            get
            {
                return ServiceManager.BeaconScanner;
            }
        }

        /// &lt;summary&gt;
        /// The API key for the Sensorberg service.
        /// The recommended way is to set the API key when initializing the SDK.
        /// &lt;/summary&gt;
        public string ApiKey
        {
            [DebuggerStepThrough]
            get
            {
                return SDKData.Instance.ApiKey;
            }
            [DebuggerStepThrough]
            set
            {
                SDKData.Instance.ApiKey = value;
            }
        }

        /// &lt;summary&gt;
        /// The manufacturer ID to filter beacons that are being watched.
        /// &lt;/summary&gt;
        public UInt16 ManufacturerId
        {
            [DebuggerStepThrough]
            get;
            [DebuggerStepThrough]
            private set;
        }

        /// &lt;summary&gt;
        /// The beacon code to filter beacons that are being watched.
        /// &lt;/summary&gt;
        public UInt16 BeaconCode
        {
            [DebuggerStepThrough]
            get;
            [DebuggerStepThrough]
            private set;
        }

        /// &lt;summary&gt;
        /// Indicates whether the SDK is initialized and ready to function or not.
        /// 
        /// The scanner will work even if the SDK has not been initialized. However, the resolver
        /// requires a valid API key to generate proper requests to server.
        /// 
        /// Sensorberg SDK is initialized by calling the Initialize method with a valid API key.
        /// &lt;/summary&gt;
		public bool IsInitialized
        {
            [DebuggerStepThrough]
            get
            {
                return SdkEngine.IsInitialized;
            }
        }

        /// &lt;summary&gt;
        /// Property for checking if the background task is enabled (allowed to be registered).
        /// By registering or unregistering the background task, you change this value.
        /// &lt;/summary&gt;
        public bool IsBackgroundTaskEnabled
        {
            [DebuggerStepThrough]
            get
            {
                return SDKData.Instance.BackgroundTaskEnabled;
            }
        }

        /// &lt;summary&gt;
        /// Property for checking whether the background task is registered or not.
        /// &lt;/summary&gt;
        public bool IsBackgroundTaskRegistered
        {
            [DebuggerStepThrough]
            get
            {
                return (_backgroundTaskManager != null &amp;&amp; _backgroundTaskManager.IsBackgroundTaskRegistered);
            }
        }

        /// &lt;summary&gt;
        /// True, if the scanner is running. False otherwise.
        /// &lt;/summary&gt;
		public bool IsScannerStarted
        {
            [DebuggerStepThrough]
            get
            {
                return (Scanner.Status == ScannerStatus.Started);
            }
        }

        /// &lt;summary&gt;
        /// True, if a layout has been retrieved and is valid.
        /// &lt;/summary&gt;
        public bool IsLayoutValid
        {
            [DebuggerStepThrough]
            get
            {
                return ServiceManager.LayoutManager.IsLayoutValid;
            }
        }

        public AppSettings DefaultAppSettings
        {
            [DebuggerStepThrough]
            get { return SdkEngine.DefaultAppSettings; }
            [DebuggerStepThrough]
            set { SdkEngine.DefaultAppSettings = value; }
        }

        public static string UserId
        {
            [DebuggerStepThrough]
            get
            {
                Instance();
                return _instance.SdkEngine.UserId;
            }
            [DebuggerStepThrough]
            set
            {
                Instance();
                _instance.SdkEngine.UserId = value;
            }
        }

        /// &lt;summary&gt;
        /// Returns the singleton instance of this class.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;manufacturerId&quot;&gt;The manufacturer ID of beacons to watch.&lt;/param&gt;
        /// &lt;param name=&quot;beaconCode&quot;&gt;The beacon code of beacons to watch.&lt;/param&gt;
        /// &lt;returns&gt;The singleton instance of this class.&lt;/returns&gt;
		public static SDKManager Instance(UInt16 manufacturerId, UInt16 beaconCode)
        {
            logger.Debug(&quot;Instance&quot;);
            Instance();

            _instance.ManufacturerId = manufacturerId;
            _instance.BeaconCode = beaconCode;

            return _instance;
        }

        private static void Instance()
        {
            if (_instance == null)
            {
                _instance = new SDKManager();
            }
        }

        /// &lt;summary&gt;
        /// Uninitialize the complete SDK.
        /// &lt;/summary&gt;
        public static void Dispose()
        {
            ServiceManager.BeaconScanner.StopWatcher();
            _instance?._backgroundTaskManager.UnregisterBackgroundTask();
            _instance?.SdkEngine.Dispose();
            _instance = null;
        }

        /// &lt;summary&gt;
        /// Constructor.
        /// &lt;/summary&gt;
        private SDKManager()
        {
            SdkEngine = new SDKEngine(true);
            _backgroundTaskManager = new BackgroundTaskManager();
            _backgroundTaskManager.RegisterOnProgressEventHandler();
        }

        /// &lt;summary&gt;
        /// Utility method for launching bluetooth settings on device.
        /// &lt;/summary&gt;
        public async Task LaunchBluetoothSettingsAsync()
        {
            await Windows.System.Launcher.LaunchUriAsync(new Uri(&quot;ms-settings-bluetooth:&quot;));
        }

        /// &lt;summary&gt;
        /// Initializes the SDK using the given API key. The scanner can be used separately, but
        /// the resolving beacon actions cannot be done unless the SDK is initialized.
        /// 
        /// If background task is enabled, this method check if there are updates for the
        /// background task filters available and updates them if so.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;apiKey&quot;&gt;The API key for the Sensorberg service.&lt;/param&gt;
        /// &lt;param name=&quot;timerClassName&quot;&gt;Full class name of the timer background process, if needed&lt;/param&gt;
        /// &lt;param name=&quot;advertisementClassName&quot;&gt;Full class name of the advertisement background process, if needed&lt;/param&gt;
        public async Task InitializeAsync(string apiKey, string timerClassName = null, string advertisementClassName = null, bool startScanning = true)
        {
            logger.Debug(&quot;InitializeAsync&quot;);
            SDKData sdkData = SDKData.Instance;

            if (!IsInitialized)
            {
                sdkData.ApiKey = apiKey;
                await SdkEngine.InitializeAsync();
                await InitializeSettingsAsync();
            }

            if (sdkData.BackgroundTaskEnabled)
            {
                logger.Debug(&quot;InitializeAsync#InitializeBackgground&quot;);
                await UpdateBackgroundTaskIfNeededAsync(timerClassName, advertisementClassName);
            }

            if (startScanning)
            {
                StartScanner();
            }
        } 

        private void OnSettingsUpdated(object sender, SettingsEventArgs settingsEventArgs)
        {
            var oldTimeout = _appSettings.BeaconExitTimeout;
            var oldRssiThreshold = _appSettings.RssiEnterThreshold;
            var oldDistanceThreshold = _appSettings.EnterDistanceThreshold;

            _appSettings = settingsEventArgs.Settings;

            bool settingsAreTheSame = _appSettings.BeaconExitTimeout == oldTimeout &amp;&amp; _appSettings.RssiEnterThreshold == oldRssiThreshold &amp;&amp; _appSettings.EnterDistanceThreshold == oldDistanceThreshold;

            if (settingsAreTheSame)
            {
                return;
            }

            if (_scannerShouldBeRunning)
            {
                StopScanner();
                StartScanner();
            }
        }

        /// &lt;summary&gt;
        /// De-initializes the SDK.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;stopScanner&quot;&gt;If true, will stop scanner if running.&lt;/param&gt;
        public void Deinitialize(bool stopScanner)
        {
            if (IsInitialized)
            {
                if (stopScanner)
                {
                    StopScanner();
                }

                SdkEngine.Dispose();
            }
            Dispose();
        }

        /// &lt;summary&gt;
        /// Registers the background task or in the case of a pending background filter update,
        /// re-registers the task.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;The registration result.&lt;/returns&gt;
        public async Task&lt;BackgroundTaskRegistrationResult&gt; RegisterBackgroundTaskAsync(string timerClassName, string advertisementClassName)
        {
            SDKData.Instance.BackgroundTaskEnabled = true;
            return await _backgroundTaskManager.RegisterBackgroundTaskAsync(timerClassName, advertisementClassName, ManufacturerId, BeaconCode);
        }

        public async Task&lt;BackgroundTaskRegistrationResult&gt; UpdateBackgroundTaskIfNeededAsync(string timerClassName, string advertisementClassName)
        {
            BackgroundTaskRegistrationResult result = new BackgroundTaskRegistrationResult()
            {
                Success = true,
                Exception = null
            };

            if (BackgroundTaskManager.CheckIfBackgroundFilterUpdateIsRequired())
            {
                result = await _backgroundTaskManager.UpdateBackgroundTaskAsync(timerClassName, advertisementClassName, ManufacturerId, BeaconCode);
            }

            SDKData.Instance.BackgroundTaskEnabled = true;
            return result;
        }

        /// &lt;summary&gt;
        /// Unregisters the background task.
        /// &lt;/summary&gt;
        public void UnregisterBackgroundTask()
        {
            _backgroundTaskManager.UnregisterBackgroundTask();
            SDKData.Instance.BackgroundTaskEnabled = false;
        }

        /// &lt;summary&gt;
        /// Starts the scanner and starts to listen to beacon events.
        /// &lt;/summary&gt;
        public void StartScanner()
        {
            Scanner.StatusChanged += OnScannerStatusChanged;

            if (Scanner.Status != ScannerStatus.Started)
            {
                _scannerShouldBeRunning = true;
                Scanner.BeaconEvent += OnBeaconEventAsync;
                InitializeSettingsAsync().ContinueWith(task =&gt;
                    {
                        Scanner.StartWatcher(ManufacturerId, BeaconCode, _appSettings.BeaconExitTimeout, _appSettings.RssiEnterThreshold, _appSettings.EnterDistanceThreshold);
                    });
            }
        }

        /// &lt;summary&gt;
        /// Stops the scanner and stops listening to beacon events.
        /// &lt;/summary&gt;
        public void StopScanner()
        {
            _scannerShouldBeRunning = false;
            Scanner.StatusChanged -= OnScannerStatusChanged;

            if (Scanner.Status == ScannerStatus.Started)
            {
                Scanner.BeaconEvent -= OnBeaconEventAsync;
                Scanner.StopWatcher();
            }
        }

        /// &lt;summary&gt;
        /// Invalidates the current layout cache.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public async Task InvalidateCacheAsync()
        {
            await ServiceManager.LayoutManager.InvalidateLayout();
        }

        /// &lt;summary&gt;
        /// Sets the SDK preferences based on the application visibility.
        /// Hook this event handler to Window.Current.VisibilityChanged.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
        public void OnApplicationVisibilityChanged(object sender, VisibilityChangedEventArgs e)
        {
            System.Diagnostics.Debug.WriteLine(&quot;SDKManager.OnApplicationVisibilityChanged(): &quot;
                + (e.Visible ? &quot;To visible&quot; : &quot;To not visible&quot;));
            SDKData.Instance.AppIsVisible = e.Visible;
        }

        /// &lt;summary&gt;
        /// Called, when scanner sends a beacon event. If the background task is registered,
        /// it will resolve the actions and we do nothing here.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;e&quot;&gt;The beacon event.&lt;/param&gt;
        private async void OnBeaconEventAsync(object sender, BeaconEventArgs e)
        {
            if (!IsBackgroundTaskRegistered)
            {
                await SdkEngine.ResolveBeaconAction(e);
            }
        }

        private void OnScannerStatusChanged(object sender, ScannerStatus e)
        {
            if (_startScannerTimer != null)
            {
                _startScannerTimer.Dispose();
                _startScannerTimer = null;
            }

            if (e != ScannerStatus.Started)
            {
                Scanner.BeaconEvent -= OnBeaconEventAsync;

                if (_scannerShouldBeRunning)
                {
                    _startScannerTimer = new Timer(StartScannerTimerCallback, null, StartScannerIntervalInMilliseconds, Timeout.Infinite);
                }
            }
        }

        private void StartScannerTimerCallback(object state)
        {
            if (_startScannerTimer != null)
            {
                _startScannerTimer.Dispose();
                _startScannerTimer = null;
            }

            if (_scannerShouldBeRunning)
            {
                StartScanner();
            }
        }

        private async Task InitializeSettingsAsync()
        {
            if (_appSettings == null)
            {
                _appSettings = await ServiceManager.SettingsManager.GetSettings();
                ServiceManager.SettingsManager.SettingsUpdated += OnSettingsUpdated;
            }
        }
        /// &lt;summary&gt;
        /// Sends all pending history elements.
        /// &lt;/summary&gt;
        public async Task FlushHistory()
        {
            await SdkEngine.FlushHistory();
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[40,13,40,14,0],[41,17,41,57,0],[42,17,42,80,0],[43,13,43,14,0],[57,13,57,14,0],[58,17,58,64,0],[59,13,59,14,0],[68,13,68,14,0],[69,17,69,58,0],[70,13,70,14,0],[72,13,72,14,0],[73,17,73,58,0],[74,13,74,14,0],[88,13,88,14,0],[89,17,89,48,0],[90,13,90,14,0],[96,13,96,14,0],[97,17,97,74,0],[98,13,98,14,0],[100,13,100,14,0],[101,17,101,74,0],[102,13,102,14,0],[133,13,133,14,0],[134,17,134,48,0],[135,13,135,14,0],[138,13,138,14,0],[139,17,139,49,0],[140,13,140,14,0],[190,13,190,14,0],[191,17,191,63,0],[192,13,192,14,0],[214,13,214,14,0],[215,17,215,66,0],[216,13,216,14,0],[226,13,226,14,0],[227,17,227,67,0],[228,13,228,14,0],[234,17,234,18,0],[234,19,234,55,0],[234,56,234,57,0],[236,17,236,18,0],[236,19,236,56,0],[236,57,236,58,0],[243,13,243,14,0],[244,17,244,28,0],[245,17,245,51,0],[246,13,246,14,0],[249,13,249,14,0],[250,17,250,28,0],[251,17,251,52,0],[252,13,252,14,0],[344,9,344,10,0],[345,13,345,61,0],[346,13,346,68,0],[347,13,347,76,0],[349,13,349,55,0],[351,13,351,202,0],[353,13,353,36,0],[354,13,354,14,0],[355,17,355,24,0],[358,13,358,41,0],[359,13,359,14,0],[360,17,360,31,0],[361,17,361,32,0],[362,13,362,14,0],[363,9,363,10,0],[415,9,415,10,0],[416,13,416,63,0],[417,13,417,60,0],[418,9,418,10,0],[447,13,447,14,0],[448,17,448,59,0],[449,17,449,39,0],[450,13,450,14,0],[469,9,469,10,0],[470,13,471,66,0],[472,13,472,55,0],[473,9,473,10,0],[490,9,490,10,0],[491,13,491,44,0],[492,13,492,14,0],[493,17,493,46,0],[494,17,494,43,0],[495,13,495,14,0],[497,13,497,44,0],[498,13,498,14,0],[499,17,499,59,0],[501,17,501,45,0],[502,17,502,18,0],[503,21,503,139,0],[504,17,504,18,0],[505,13,505,14,0],[506,9,506,10,0],[509,9,509,10,0],[510,13,510,44,0],[511,13,511,14,0],[512,17,512,46,0],[513,17,513,43,0],[514,13,514,14,0],[516,13,516,41,0],[517,13,517,14,0],[518,17,518,32,0],[519,13,519,14,0],[520,9,520,10,0],[305,9,305,10,0],[306,13,306,93,0],[307,9,307,10,0],[332,13,332,14,0],[333,17,333,71,0],[334,17,334,97,0],[335,13,335,14,0],[389,9,389,10,0],[390,13,390,59,0],[391,13,391,145,0],[392,9,392,10,0],[395,9,395,10,0],[396,13,400,15,0],[402,13,402,81,0],[403,13,403,14,0],[404,17,404,149,0],[405,13,405,14,0],[407,13,407,59,0],[408,13,408,27,0],[409,9,409,10,0],[458,9,458,10,0],[459,13,459,67,0],[460,9,460,10,0],[534,9,534,10,0],[535,13,535,44,0],[536,9,536,10,0],[35,13,35,14,1],[36,17,36,57,1],[37,17,37,80,1],[38,13,38,14,1],[53,13,53,14,1],[54,17,54,64,1],[55,13,55,14,1],[84,13,84,14,1],[85,17,85,48,1],[86,13,86,14,1],[110,13,111,17,1],[120,13,120,14,1],[121,17,121,53,1],[122,13,122,14,1],[148,13,149,17,1],[150,13,151,25,1],[159,13,160,17,1],[161,13,162,25,1],[177,13,177,14,1],[178,17,178,48,1],[179,13,179,14,1],[202,13,202,14,1],[203,17,203,110,1],[204,13,204,14,1],[262,9,262,10,1],[263,13,263,38,1],[264,13,264,24,1],[266,13,266,55,1],[267,13,267,47,1],[269,13,269,30,1],[270,9,270,10,1],[273,9,273,10,1],[274,13,274,35,1],[275,13,275,14,1],[276,17,276,46,1],[277,13,277,14,1],[278,9,278,10,1],[284,9,284,10,1],[285,13,285,56,1],[286,13,286,74,1],[287,13,287,44,1],[288,13,288,30,1],[289,9,289,10,1],[20,9,20,72,1],[294,9,294,29,1],[295,9,295,10,1],[296,13,296,45,1],[297,13,297,66,1],[298,13,298,69,1],[299,9,299,10,1],[370,9,370,10,1],[371,13,371,31,1],[372,13,372,14,1],[373,17,373,33,1],[374,17,374,18,1],[375,21,375,35,1],[376,17,376,18,1],[378,17,378,37,1],[379,13,379,14,1],[380,13,380,23,1],[381,9,381,10,1],[424,9,424,10,1],[425,13,425,61,1],[427,13,427,57,1],[428,13,428,14,1],[429,17,429,48,1],[430,17,430,59,1],[431,17,432,21,1],[432,22,433,25,1],[433,176,434,21,1],[434,22,434,24,1],[435,13,435,14,1],[436,9,436,10,1],[442,9,442,10,1],[443,13,443,45,1],[444,13,444,61,1],[446,13,446,57,1],[451,9,451,10,1],[18,9,18,101,1],[19,9,19,73,1],[432,21,432,22,1],[433,25,433,176,1],[434,21,434,22,1],[320,9,320,10,1],[321,13,321,45,1],[322,13,322,48,1],[324,13,324,32,1],[325,13,325,14,1],[326,17,326,41,1],[327,17,327,51,1],[328,17,328,49,1],[329,13,329,14,1],[331,13,331,47,1],[337,13,337,31,1],[338,13,338,14,1],[339,17,339,32,1],[340,13,340,14,1],[341,9,341,10,1],[482,9,482,10,1],[483,13,483,45,1],[484,13,484,14,1],[485,17,485,56,1],[486,13,486,14,1],[487,9,487,10,1],[523,9,523,10,1],[524,13,524,38,1],[525,13,525,14,1],[526,17,526,83,1],[527,17,527,85,1],[528,13,528,14,1],[529,9,529,10,1]]);
    </script>
  </body>
</html>