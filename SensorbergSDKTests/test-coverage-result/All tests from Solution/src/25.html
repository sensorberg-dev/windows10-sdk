<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>d:\work\sensorberg\windows10-sdk\sensorbergsdk\beaconaction.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using SensorbergSDK.Internal;
using System;
using System.Diagnostics;
using System.Runtime.Serialization;
using System.Text;
using System.Threading.Tasks;
using Windows.Data.Json;
using Windows.UI.Popups;
using Windows.UI.Xaml.Navigation;

namespace SensorbergSDK
{
    [DataContract]
    public enum BeaconActionType
    {
        UrlMessage = Constants.ActionTypeUrlMessage,
        VisitWebsite = Constants.ActionTypeVisitWebsite,
        InApp = Constants.ActionTypeInApp
    };

    /// &lt;summary&gt;
    /// Represents an action resolved based on a beacon event.
    /// &lt;/summary&gt;
    [DataContract]
    public sealed class BeaconAction
    {
        private string payloadString;
        private const char FieldSeparator = &#39;;&#39;; // For FromString() and ToString()

        public BeaconAction()
        {
            Payload = null;
        }

        [DataMember]
        public int Id { [DebuggerStepThrough] get; [DebuggerStepThrough] set; }

        [DataMember]
        public BeaconActionType Type { [DebuggerStepThrough] get; [DebuggerStepThrough] set; }

        [DataMember]
        public string Uuid { [DebuggerStepThrough] get; [DebuggerStepThrough] set; }

        [DataMember]
        public string Subject { [DebuggerStepThrough] get; [DebuggerStepThrough] set; }

        [DataMember]
        public string Body { [DebuggerStepThrough] get; [DebuggerStepThrough] set; }

        [DataMember]
        public string Url { [DebuggerStepThrough] get; [DebuggerStepThrough] set; }

        /// &lt;summary&gt;
        /// String representation of the payload.
        /// &lt;/summary&gt;
        [DataMember]
        public string PayloadString
        {
            get { return string.IsNullOrEmpty(payloadString) ? Payload?.ToString() : payloadString; }
            set { payloadString = value; }
        }

        /// &lt;summary&gt;
        /// Payload message set for Action on the service. 
        /// Value is null, if payload is not set.
        /// &lt;/summary&gt;
        public JsonObject Payload { [DebuggerStepThrough] get; [DebuggerStepThrough] set; }

        /// &lt;summary&gt;
        /// Sets the beacon action type based on the given value.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;type&quot;&gt;The type as integer.&lt;/param&gt;
        public void SetType(int type)
        {
            switch (type)
            {
                case Constants.ActionTypeUrlMessage:
                    Type = BeaconActionType.UrlMessage;
                    break;
                case Constants.ActionTypeVisitWebsite:
                    Type = BeaconActionType.VisitWebsite;
                    break;
                case Constants.ActionTypeInApp:
                    Type = BeaconActionType.InApp;
                    break;
                default:
                    throw new ArgumentException(&quot;Invalid type (&quot; + type + &quot;)&quot;);
            }
        }

        /// &lt;summary&gt;
        /// Sets the beacon action type based on the given value.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;type&quot;&gt;The type as string.&lt;/param&gt;
        /// &lt;returns&gt;True, if the type was set. False otherwise.&lt;/returns&gt;
        public bool SetType(string type)
        {
            bool wasSet = false;

            if (!string.IsNullOrEmpty(type))
            {
                if (type.Equals(BeaconActionType.InApp.ToString()))
                {
                    Type = BeaconActionType.InApp;
                    wasSet = true;
                }
                else if (type.Equals(BeaconActionType.UrlMessage.ToString()))
                {
                    Type = BeaconActionType.UrlMessage;
                    wasSet = true;
                }
                else if (type.Equals(BeaconActionType.VisitWebsite.ToString()))
                {
                    Type = BeaconActionType.VisitWebsite;
                    wasSet = true;
                }
            }

            return wasSet;
        }

        /// &lt;summary&gt;
        /// Validates the received action.
        /// 
        /// Requirements for each action type:
        /// - URL message: Mandatory: subject, body, URL
        /// - Visit website: Optional: subject, body. Mandatory URL
        /// - In-app: Optional: subject, body. Mandatory: URL
        /// &lt;/summary&gt;
        /// &lt;returns&gt;True, if valid. False otherwise.&lt;/returns&gt;
        public bool Validate()
        {
            bool valid = false;

            switch (Type)
            {
                case BeaconActionType.UrlMessage:
                    if (Subject.Length &gt; 0 &amp;&amp; Url.Length &gt; 0 &amp;&amp; Body.Length &gt; 0)
                    {
                        valid = true;
                    }

                    break;
                case BeaconActionType.VisitWebsite:
                case BeaconActionType.InApp:
                    if (Url.Length &gt; 0)
                    {
                        valid = true;
                    }

                    break;
            }

            return valid;
        }

        /// &lt;summary&gt;
        /// Tries to launch the web browser with the URL of this beacon action.
        /// Note that the type of this action must be VisitWebsite or no browser is launched.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;True, if the web browser was launched. False otherwise.&lt;/returns&gt;
        public async Task&lt;bool&gt; LaunchWebBrowserAsync()
        {
            bool webBrowserLaunched = false;

            if (Type == BeaconActionType.VisitWebsite &amp;&amp; !string.IsNullOrEmpty(Url))
            {
                await Windows.System.Launcher.LaunchUriAsync(new Uri(Url));
                webBrowserLaunched = true;
            }

            return webBrowserLaunched;
        }

        /// &lt;summary&gt;
        /// For convenience. Tries to create a beacon action instance from the parameter of the
        /// given navigation event arguments.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;args&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;A newly created beacon action instance, if successful. Null in case of an error.&lt;/returns&gt;
        public static BeaconAction FromNavigationEventArgs(NavigationEventArgs args)
        {
            if (args != null &amp;&amp; args.Parameter != null &amp;&amp; args.Parameter is string)
            {
                return BeaconAction.FromString(args.Parameter as string);
            }

            return null;
        }

        /// &lt;summary&gt;
        /// Creates a beacon action instance from the given string.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;beaconActionAsString&quot;&gt;The beacon action as string.&lt;/param&gt;
        /// &lt;returns&gt;A newly created beacon action instance, if successful. Null in case of an error.&lt;/returns&gt;
        public static BeaconAction FromString(string beaconActionAsString)
        {
            BeaconAction beaconAction = null;

            if (!string.IsNullOrEmpty(beaconActionAsString))
            {
                string[] fields = beaconActionAsString.Split(FieldSeparator);

                if (fields.Length &gt;= 2)
                {
                    beaconAction = new BeaconAction();

                    for (int i = 0; i &lt; fields.Length; ++i)
                    {
                        if (fields[i].Trim().Length &gt; 0)
                        {
                            switch (i)
                            {
                                case 0: // Id
                                    int id = 0;

                                    try
                                    {
                                        int.TryParse(fields[i], out id);
                                    }
                                    catch (Exception)
                                    {
                                    }

                                    beaconAction.Id = id;
                                    break;
                                case 1: // Type
                                    beaconAction.SetType(fields[i]);
                                    break;
                                case 2: // Subject
                                    beaconAction.Subject = fields[i];
                                    break;
                                case 3: // Body
                                    beaconAction.Body = fields[i];
                                    break;
                                case 4: // Url
                                    beaconAction.Url = fields[i];
                                    break;
                                case 5: // Payload
                                    JsonObject payload = null;
                                    bool jsonObjectParsed = false;

                                    try
                                    {
                                        jsonObjectParsed = JsonObject.TryParse(fields[i], out payload);
                                    }
                                    catch (Exception)
                                    {
                                    }

                                    if (jsonObjectParsed)
                                    {
                                        beaconAction.Payload = payload;
                                    }

                                    break;
                            }
                        }
                    }
                }
            }

            return beaconAction;
        }

        /// &lt;summary&gt;
        /// Converts this instance to a string.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;A string representation of this instance.&lt;/returns&gt;
        public override string ToString()
        {
            StringBuilder stringBuilder = new StringBuilder();
            stringBuilder.Append(Id.ToString());
            stringBuilder.Append(FieldSeparator);
            stringBuilder.Append(Type.ToString());
            stringBuilder.Append(FieldSeparator);
            stringBuilder.Append(string.IsNullOrEmpty(Subject) ? &quot; &quot; : Subject);
            stringBuilder.Append(FieldSeparator);
            stringBuilder.Append(string.IsNullOrEmpty(Body) ? &quot; &quot; : Body);
            stringBuilder.Append(FieldSeparator);
            stringBuilder.Append(string.IsNullOrEmpty(Url) ? &quot; &quot; : Url);

            if (Payload != null)
            {
                stringBuilder.Append(FieldSeparator);
                stringBuilder.Append(Payload.Stringify());
            }

            return stringBuilder.ToString();
        }

        /// &lt;summary&gt;
        /// Creates a message dialog based on the data of this beacon action.
        /// Note that no commands is added to the created dialog.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;A newly created message dialog instance.&lt;/returns&gt;
        public MessageDialog ToMessageDialog()
        {
            string message = string.Empty;

            switch (Type)
            {
                case BeaconActionType.UrlMessage:
                case BeaconActionType.VisitWebsite:
                    message = string.Format(&quot;{0}\nVisit {1}?&quot;, Body, Url);
                    break;
                case BeaconActionType.InApp:
                    message = Body;
                    break;
            }

            MessageDialog messageDialog = new MessageDialog(message, Subject);
            return messageDialog;
        }

        private bool Equals(BeaconAction other)
        {
            return Id == other.Id &amp;&amp; Type == other.Type &amp;&amp; string.Equals(Uuid, other.Uuid) &amp;&amp; string.Equals(Subject, other.Subject) &amp;&amp; string.Equals(Body, other.Body) &amp;&amp;
                   string.Equals(Url, other.Url) &amp;&amp; Equals(Payload?.ToString(), other.Payload?.ToString());
        }

        public override bool Equals(object obj)
        {
            if (ReferenceEquals(null, obj)) return false;
            if (ReferenceEquals(this, obj)) return true;
            return obj is BeaconAction &amp;&amp; Equals((BeaconAction) obj);
        }

        public override int GetHashCode()
        {
            unchecked
            {
                var hashCode = Id;
                hashCode = (hashCode*397) ^ (int) Type;
                hashCode = (hashCode*397) ^ (Uuid != null ? Uuid.GetHashCode() : 0);
                hashCode = (hashCode*397) ^ (Subject != null ? Subject.GetHashCode() : 0);
                hashCode = (hashCode*397) ^ (Body != null ? Body.GetHashCode() : 0);
                hashCode = (hashCode*397) ^ (Url != null ? Url.GetHashCode() : 0);
                hashCode = (hashCode*397) ^ (Payload != null ? Payload.GetHashCode() : 0);
                return hashCode;
            }
        }

        public static bool operator ==(BeaconAction left, BeaconAction right)
        {
            return Equals(left, right);
        }

        public static bool operator !=(BeaconAction left, BeaconAction right)
        {
            return !Equals(left, right);
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[87,21,87,80,0],[97,9,97,10,0],[98,13,98,33,0],[100,13,100,45,0],[101,13,101,14,0],[102,17,102,68,0],[103,17,103,18,0],[104,21,104,51,0],[105,21,105,35,0],[106,17,106,18,0],[107,22,107,78,0],[108,17,108,18,0],[109,21,109,56,0],[110,21,110,35,0],[111,17,111,18,0],[112,22,112,80,0],[113,17,113,18,0],[114,21,114,58,0],[115,21,115,35,0],[116,17,116,18,0],[117,13,117,14,0],[119,13,119,27,0],[120,9,120,10,0],[132,9,132,10,0],[133,13,133,32,0],[135,13,135,26,0],[138,21,138,81,0],[139,21,139,22,0],[140,25,140,38,0],[141,21,141,22,0],[143,21,143,27,0],[146,21,146,40,0],[147,21,147,22,0],[148,25,148,38,0],[149,21,149,22,0],[151,21,151,27,0],[154,13,154,26,0],[155,9,155,10,0],[182,9,182,10,0],[183,13,183,84,0],[184,13,184,14,0],[185,17,185,74,0],[188,13,188,25,0],[189,9,189,10,0],[197,9,197,10,0],[198,13,198,46,0],[200,13,200,61,0],[201,13,201,14,0],[202,17,202,78,0],[204,17,204,40,0],[205,17,205,18,0],[206,21,206,55,0],[208,26,208,35,0],[209,21,209,22,0],[210,25,210,57,0],[211,25,211,26,0],[212,29,212,39,0],[215,37,215,48,0],[218,37,218,38,0],[219,41,219,73,0],[220,37,220,38,0],[221,37,221,54,0],[222,37,222,38,0],[223,37,223,38,0],[225,37,225,58,0],[226,37,226,43,0],[228,37,228,69,0],[229,37,229,43,0],[231,37,231,70,0],[232,37,232,43,0],[234,37,234,67,0],[235,37,235,43,0],[237,37,237,66,0],[238,37,238,43,0],[240,37,240,63,0],[241,37,241,67,0],[244,37,244,38,0],[245,41,245,104,0],[246,37,246,38,0],[247,37,247,54,0],[248,37,248,38,0],[249,37,249,38,0],[251,37,251,58,0],[252,37,252,38,0],[253,41,253,72,0],[254,37,254,38,0],[256,37,256,43,0],[258,25,258,26,0],[259,21,259,22,0],[208,56,208,59,0],[208,37,208,54,0],[260,17,260,18,0],[261,13,261,14,0],[263,13,263,33,0],[264,9,264,10,0],[298,9,298,10,0],[299,13,299,43,0],[301,13,301,26,0],[305,21,305,75,0],[306,21,306,27,0],[308,21,308,36,0],[309,21,309,27,0],[312,13,312,79,0],[313,13,313,34,0],[314,9,314,10,0],[324,45,324,58,0],[325,45,325,57,0],[330,9,330,10,0],[332,13,332,14,0],[333,17,333,35,0],[334,17,334,56,0],[335,17,335,85,0],[336,17,336,91,0],[337,17,337,85,0],[338,17,338,83,0],[339,17,339,91,0],[340,17,340,33,0],[342,9,342,10,0],[345,9,345,10,0],[346,13,346,40,0],[347,9,347,10,0],[163,9,163,10,0],[164,13,164,45,0],[166,13,166,85,0],[167,13,167,14,0],[168,17,168,76,0],[169,17,169,43,0],[170,13,170,14,0],[172,13,172,39,0],[173,9,173,10,0],[30,9,30,30,1],[31,9,31,10,1],[32,13,32,28,1],[33,9,33,10,1],[36,25,36,51,1],[36,52,36,78,1],[39,40,39,66,1],[39,67,39,93,1],[42,30,42,56,1],[42,57,42,83,1],[45,33,45,59,1],[45,60,45,86,1],[48,30,48,56,1],[48,57,48,83,1],[51,29,51,55,1],[51,56,51,82,1],[59,17,59,18,1],[59,19,59,100,1],[59,101,59,102,1],[60,17,60,18,1],[60,19,60,41,1],[60,42,60,43,1],[67,37,67,63,1],[67,64,67,90,1],[74,9,74,10,1],[75,13,75,26,1],[78,21,78,56,1],[79,21,79,27,1],[81,21,81,58,1],[82,21,82,27,1],[84,21,84,51,1],[85,21,85,27,1],[89,9,89,10,1],[271,9,271,10,1],[272,13,272,63,1],[273,13,273,49,1],[274,13,274,50,1],[275,13,275,51,1],[276,13,276,50,1],[277,13,277,81,1],[278,13,278,50,1],[279,13,279,75,1],[280,13,280,50,1],[281,13,281,73,1],[283,13,283,33,1],[284,13,284,14,1],[285,17,285,54,1],[286,17,286,59,1],[287,13,287,14,1],[289,13,289,45,1],[290,9,290,10,1],[317,9,317,10,1],[318,13,319,108,1],[320,9,320,10,1],[323,9,323,10,1],[324,13,324,44,1],[325,13,325,44,1],[326,13,326,70,1],[327,9,327,10,1],[350,9,350,10,1],[351,13,351,41,1],[352,9,352,10,1]]);
    </script>
  </body>
</html>