<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>d:\work\sensorberg\windows10-sdk\sensorbergsdktests\integrationtest.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Threading;
using System.Threading.Tasks;
using Windows.Storage;
using Microsoft.VisualStudio.TestPlatform.UnitTestFramework;
using SensorbergSDK;
using SensorbergSDK.Internal;
using SensorbergSDK.Internal.Services;
using SensorbergSDKTests.Mocks;

namespace SensorbergSDKTests
{
    [TestClass]
    public class IntegrationTest
    {
        ManualResetEvent _manualEvent = new ManualResetEvent(false);
        Beacon beacon = new Beacon();
        Resolver res = new Resolver();
        BeaconEventArgs args = new BeaconEventArgs();
        ResolvedActionsEventArgs _e = null;

        [TestInitialize]
        public async Task Setup()
        {
            ServiceManager.ReadOnlyForTests = false;
            ServiceManager.Clear();
            ServiceManager.ApiConnction = new MockApiConnection();
            ServiceManager.LayoutManager = new LayoutManager();
            ServiceManager.SettingsManager = new SettingsManager();
            ServiceManager.StorageService = new StorageService() {Storage = new MockStorage()};
            ServiceManager.ReadOnlyForTests = true;
        }

        [TestMethod]
        public async Task Integration_connection()
        {
            SDKData.Instance.ApiKey = &quot;db427f16996116144c206efc651885bd76c864e1d5c07691e1ab0157d976ffd4&quot;;
            beacon.Id1 = &quot;7367672374000000ffff0000ffff0006&quot;;
            beacon.Id2 = 59242;
            beacon.Id3 = 27189;

            args.Beacon = beacon;
            args.EventType = BeaconEventType.Enter;
            res.ActionsResolved += Res_ActionResolved;
            await res.CreateRequest(args);
            _manualEvent.WaitOne();

            Assert.IsNotNull(_e);
            Assert.IsTrue(_e.ResolvedActions.Count == 1);
        }

        [TestMethod]
        public async Task Integration_timeframes1()
        {
            SDKData.Instance.ApiKey = &quot;db427f16996116144c206efc651885bd76c864e1d5c07691e1ab0157d976ffd4&quot;;
            beacon.Id1 = &quot;7367672374000000ffff0000ffff0007&quot;;
            beacon.Id2 = 39187;
            beacon.Id3 = 58763; //Valid only in 2017, beacon

            args.Beacon = beacon;
            args.EventType = BeaconEventType.Enter;
            res.ActionsResolved += Res_ActionResolved;
            await res.CreateRequest(args);
            _manualEvent.WaitOne();

            Assert.IsNotNull(_e);
            Assert.IsTrue(_e.ResolvedActions.Count == 1);

            var trueOffset = new DateTimeOffset(2017, 5, 1, 8, 6, 32, new TimeSpan(1, 0, 0));
            var falseOffset = new DateTimeOffset(2018, 5, 1, 8, 6, 32, new TimeSpan(1, 0, 0));

            Assert.IsTrue(_e.ResolvedActions[0].IsInsideTimeframes(trueOffset));
            Assert.IsFalse(_e.ResolvedActions[0].IsInsideTimeframes(falseOffset));
        }

        [TestMethod]
        public async Task Integration_timeframes2()
        {
            SDKData.Instance.ApiKey = &quot;db427f16996116144c206efc651885bd76c864e1d5c07691e1ab0157d976ffd4&quot;;
            beacon.Id1 = &quot;7367672374000000ffff0000ffff0003&quot;;
            beacon.Id2 = 48869;
            beacon.Id3 = 21321; //Three actions, beacon

            args.Beacon = beacon;
            args.EventType = BeaconEventType.Enter;
            res.ActionsResolved += Res_ActionResolved;
            await res.CreateRequest(args);
            _manualEvent.WaitOne();

            Assert.IsNotNull(_e);
            Assert.IsTrue(_e.ResolvedActions.Count == 4);

            var trueOffset = new DateTimeOffset(2017, 5, 1, 8, 6, 32, new TimeSpan(1, 0, 0));
            var falseOffset = new DateTimeOffset(2013, 5, 1, 8, 6, 32, new TimeSpan(1, 0, 0));

            Assert.IsTrue(_e.ResolvedActions[0].IsInsideTimeframes(trueOffset));
            Assert.IsFalse(_e.ResolvedActions[0].IsInsideTimeframes(falseOffset));
        }

        [TestMethod]
        public async Task Integration_payload()
        {
            SDKData.Instance.ApiKey = &quot;db427f16996116144c206efc651885bd76c864e1d5c07691e1ab0157d976ffd4&quot;;
            beacon.Id1 = &quot;7367672374000000ffff0000ffff0006&quot;;

            beacon.Id2 = 23430;
            beacon.Id3 = 28018; //Payload is awesome

            args.Beacon = beacon;
            args.EventType = BeaconEventType.Enter;
            res.ActionsResolved += Res_ActionResolved;
            await res.CreateRequest(args);
            _manualEvent.WaitOne();

            Assert.IsNotNull(_e);
            Assert.IsTrue(_e.ResolvedActions.Count == 1);
        }

        private void Res_ActionResolved(object sender, ResolvedActionsEventArgs e)
        {
            _e = e;
            _manualEvent.Set();
        }

    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[120,9,120,10,1],[121,13,121,20,1],[122,13,122,32,1],[123,9,123,10,1],[16,9,16,69,1],[17,9,17,38,1],[18,9,18,39,1],[19,9,19,54,1],[20,9,20,44,1],[24,9,24,10,1],[25,13,25,53,1],[26,13,26,36,1],[27,13,27,67,1],[28,13,28,64,1],[29,13,29,68,1],[30,13,30,96,1],[31,13,31,52,1],[32,9,32,10,1],[36,9,36,10,1],[37,13,37,106,1],[38,13,38,61,1],[39,13,39,32,1],[40,13,40,32,1],[42,13,42,34,1],[43,13,43,52,1],[44,13,44,55,1],[45,13,45,43,1],[46,13,46,36,1],[48,13,48,34,1],[49,13,49,58,1],[50,9,50,10,1],[54,9,54,10,1],[55,13,55,106,1],[56,13,56,61,1],[57,13,57,32,1],[58,13,58,32,1],[60,13,60,34,1],[61,13,61,52,1],[62,13,62,55,1],[63,13,63,43,1],[64,13,64,36,1],[66,13,66,34,1],[67,13,67,58,1],[69,13,69,94,1],[70,13,70,95,1],[72,13,72,81,1],[73,13,73,83,1],[74,9,74,10,1],[78,9,78,10,1],[79,13,79,106,1],[80,13,80,61,1],[81,13,81,32,1],[82,13,82,32,1],[84,13,84,34,1],[85,13,85,52,1],[86,13,86,55,1],[87,13,87,43,1],[88,13,88,36,1],[90,13,90,34,1],[91,13,91,58,1],[93,13,93,94,1],[94,13,94,95,1],[96,13,96,81,1],[97,13,97,83,1],[98,9,98,10,1],[102,9,102,10,1],[103,13,103,106,1],[104,13,104,61,1],[106,13,106,32,1],[107,13,107,32,1],[109,13,109,34,1],[110,13,110,52,1],[111,13,111,55,1],[112,13,112,43,1],[113,13,113,36,1],[115,13,115,34,1],[116,13,116,58,1],[117,9,117,10,1]]);
    </script>
  </body>
</html>