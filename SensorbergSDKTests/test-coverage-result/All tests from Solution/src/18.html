<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>d:\work\sensorberg\windows10-sdk\sensorbergsdktests\storageclasstest.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
// Created by Kay Czarnotta on 23.03.2016
// 
// Copyright (c) 2016,  Senorberg
// 
// All rights reserved.

using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Threading.Tasks;
using Windows.Data.Json;
using Windows.Storage;
using Windows.Storage.Streams;
using Microsoft.VisualStudio.TestPlatform.UnitTestFramework;
using SensorbergSDK;
using SensorbergSDK.Internal;
using SensorbergSDK.Internal.Data;
using SensorbergSDK.Services;
using SensorbergSDKTests.Mocks;

namespace SensorbergSDKTests
{
    [TestClass]
    public class StorageClassTest
    {
        private IStorage storage;

        [TestInitialize]
        public async Task Setup()
        {
            await TestHelper.ClearFiles(&quot;sensorberg-storage&quot;);
            storage = new FileStorage();
        }

        [TestMethod]
        public async Task Cleanup()
        {
            await storage.CleanDatabase();
        }


        /// &lt;summary&gt;
        /// Should not fail.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [TestMethod]
        public async Task InitTest()
        {
            await storage.InitStorage();
        }

        [TestMethod]
        public async Task DeleayedActionTest()
        {
            ResolvedAction action = new ResolvedAction();
            action.BeaconAction = new BeaconAction();
            action.BeaconAction.Body = &quot;body&quot;;
            action.BeaconAction.Id = 1;
            action.BeaconAction.Payload = JsonObject.Parse(&quot;{\&quot;pay\&quot;:\&quot;load\&quot;}&quot;);
            action.BeaconAction.Subject = &quot;Subject&quot;;
            action.BeaconAction.Type = BeaconActionType.InApp;
            action.BeaconAction.Url = &quot;http://sensorberg.com&quot;;
            action.BeaconAction.Uuid = &quot;uuid&quot;;
            action.Delay = 123;
            action.BeaconPids = new List&lt;string&gt;() {&quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;};
            action.EventTypeDetectedByDevice = BeaconEventType.EnterExit;
            action.ReportImmediately = true;
            action.SendOnlyOnce = true;
            action.SupressionTime = 321;
            action.Timeframes = new List&lt;Timeframe&gt;()
            {
                new Timeframe() {End = DateTimeOffset.Parse(&quot;2015-04-16T12:00:00.000+0000&quot;), Start = DateTimeOffset.Parse(&quot;2015-04-15T12:00:00.000+0000&quot;)}
            };

            await storage.InitStorage();

            await storage.SaveDelayedAction(action, DateTimeOffset.Parse(&quot;2015-04-16T12:00:00.000+0000&quot;), &quot;1&quot;, BeaconEventType.Enter);

            IList&lt;DelayedActionData&gt; delayedActions = await storage.GetDelayedActions(int.MaxValue);
            Assert.AreEqual(1, delayedActions.Count, &quot;to many actions found&quot;);

            DelayedActionData delayAction = delayedActions[0];
            Assert.AreEqual(&quot;1&quot;, delayAction.beaconPid, &quot;Not same beacon id&quot;);
            Assert.AreEqual(DateTimeOffset.Parse(&quot;2015-04-16T12:00:00.000+0000&quot;), delayAction.dueTime, &quot;not same delay time&quot;);
            Assert.AreEqual(BeaconEventType.Enter, delayAction.eventTypeDetectedByDevice, &quot;not same event type&quot;);

            Assert.AreEqual(action.Delay, delayAction.resolvedAction.Delay, &quot;not same action delay&quot;);
            Assert.AreEqual(action.EventTypeDetectedByDevice, delayAction.resolvedAction.EventTypeDetectedByDevice, &quot;not same action event type&quot;);
            Assert.AreEqual(action.ReportImmediately, delayAction.resolvedAction.ReportImmediately, &quot;not same ReportImmediately&quot;);
            Assert.AreEqual(action.SendOnlyOnce, delayAction.resolvedAction.SendOnlyOnce, &quot;not same SendOnlyOnce&quot;);
            Assert.AreEqual(action.SupressionTime, delayAction.resolvedAction.SupressionTime, &quot;not same SendOnlyOnce&quot;);
            Assert.AreEqual(action.Timeframes.Count, delayAction.resolvedAction.Timeframes.Count, &quot;not same Timeframes count&quot;);
            Assert.AreEqual(action.Timeframes[0].Start, delayAction.resolvedAction.Timeframes[0].Start, &quot;not same Timeframes count&quot;);
            Assert.AreEqual(action.Timeframes[0].End, delayAction.resolvedAction.Timeframes[0].End, &quot;not same Timeframes count&quot;);

            Assert.AreEqual(action.BeaconPids.Count, delayAction.resolvedAction.BeaconPids.Count, &quot;not same beacon count&quot;);
            Assert.AreEqual(action.BeaconAction.Body, delayAction.resolvedAction.BeaconAction.Body, &quot;not same beacon action body&quot;);
            Assert.AreEqual(action.BeaconAction.Subject, delayAction.resolvedAction.BeaconAction.Subject, &quot;not same beacon action Subject&quot;);
            Assert.AreEqual(action.BeaconAction.Id, delayAction.resolvedAction.BeaconAction.Id, &quot;not same beacon action Id&quot;);
            Assert.AreEqual(action.BeaconAction.Type, delayAction.resolvedAction.BeaconAction.Type, &quot;not same beacon action Type&quot;);
            Assert.AreEqual(action.BeaconAction.Uuid, delayAction.resolvedAction.BeaconAction.Uuid, &quot;not same beacon action Uuid&quot;);
            Assert.AreEqual(action.BeaconAction.Payload.ToString(), delayAction.resolvedAction.BeaconAction.Payload.ToString(), &quot;not same beacon action Payload&quot;);


            Assert.AreEqual(action, delayAction.resolvedAction, &quot;not same action&quot;);



            ResolvedAction action2 = new ResolvedAction();
            action2.BeaconAction = new BeaconAction();
            action2.BeaconAction.Body = &quot;body2&quot;;
            action2.BeaconAction.Id = 2;
            action2.BeaconAction.Payload = JsonObject.Parse(&quot;{\&quot;pay\&quot;:\&quot;load2\&quot;}&quot;);
            action2.BeaconAction.Subject = &quot;Subject2&quot;;
            action2.BeaconAction.Type = BeaconActionType.UrlMessage;
            action2.BeaconAction.Url = &quot;http://sensorberg.com&quot;;
            action2.BeaconAction.Uuid = &quot;uuid2&quot;;
            action2.Delay = 1234;
            action2.BeaconPids = new List&lt;string&gt;() {&quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;};
            action2.EventTypeDetectedByDevice = BeaconEventType.EnterExit;
            action2.ReportImmediately = false;
            action2.SendOnlyOnce = false;
            action2.SupressionTime = 3210;
            action2.Timeframes = new List&lt;Timeframe&gt;()
            {
                new Timeframe() {End = DateTimeOffset.Parse(&quot;2016-04-16T12:00:00.000+0000&quot;), Start = DateTimeOffset.Parse(&quot;2014-04-15T12:00:00.000+0000&quot;)}
            };

            await storage.SaveDelayedAction(action, DateTimeOffset.Parse(&quot;2015-05-16T12:00:00.000+0000&quot;), &quot;2&quot;, BeaconEventType.EnterExit);


            delayedActions = await storage.GetDelayedActions(int.MaxValue);
            Assert.AreEqual(2, delayedActions.Count, &quot;to many actions found&quot;);

            delayAction = delayedActions.FirstOrDefault(d =&gt; d.beaconPid == &quot;1&quot;);
            string idToDelete = delayAction.Id;
            Assert.AreEqual(&quot;1&quot;, delayAction.beaconPid, &quot;Not same beacon id&quot;);
            Assert.AreEqual(DateTimeOffset.Parse(&quot;2015-04-16T12:00:00.000+0000&quot;), delayAction.dueTime, &quot;not same delay time&quot;);
            Assert.AreEqual(BeaconEventType.Enter, delayAction.eventTypeDetectedByDevice, &quot;not same event type&quot;);

            Assert.AreEqual(action.Delay, delayAction.resolvedAction.Delay, &quot;not same action delay&quot;);
            Assert.AreEqual(action.EventTypeDetectedByDevice, delayAction.resolvedAction.EventTypeDetectedByDevice, &quot;not same action event type&quot;);
            Assert.AreEqual(action.ReportImmediately, delayAction.resolvedAction.ReportImmediately, &quot;not same ReportImmediately&quot;);
            Assert.AreEqual(action.SendOnlyOnce, delayAction.resolvedAction.SendOnlyOnce, &quot;not same SendOnlyOnce&quot;);
            Assert.AreEqual(action.SupressionTime, delayAction.resolvedAction.SupressionTime, &quot;not same SendOnlyOnce&quot;);
            Assert.AreEqual(action.Timeframes.Count, delayAction.resolvedAction.Timeframes.Count, &quot;not same Timeframes count&quot;);
            Assert.AreEqual(action.Timeframes[0].Start, delayAction.resolvedAction.Timeframes[0].Start, &quot;not same Timeframes count&quot;);
            Assert.AreEqual(action.Timeframes[0].End, delayAction.resolvedAction.Timeframes[0].End, &quot;not same Timeframes count&quot;);

            Assert.AreEqual(action.BeaconPids.Count, delayAction.resolvedAction.BeaconPids.Count, &quot;not same beacon count&quot;);
            Assert.AreEqual(action.BeaconAction.Body, delayAction.resolvedAction.BeaconAction.Body, &quot;not same beacon action body&quot;);
            Assert.AreEqual(action.BeaconAction.Subject, delayAction.resolvedAction.BeaconAction.Subject, &quot;not same beacon action Subject&quot;);
            Assert.AreEqual(action.BeaconAction.Id, delayAction.resolvedAction.BeaconAction.Id, &quot;not same beacon action Id&quot;);
            Assert.AreEqual(action.BeaconAction.Type, delayAction.resolvedAction.BeaconAction.Type, &quot;not same beacon action Type&quot;);
            Assert.AreEqual(action.BeaconAction.Uuid, delayAction.resolvedAction.BeaconAction.Uuid, &quot;not same beacon action Uuid&quot;);
            Assert.AreEqual(action.BeaconAction.Payload.ToString(), delayAction.resolvedAction.BeaconAction.Payload.ToString(), &quot;not same beacon action Payload&quot;);


            Assert.AreEqual(action, delayAction.resolvedAction, &quot;not same action&quot;);



            delayAction = delayedActions.FirstOrDefault(d =&gt; d.beaconPid == &quot;2&quot;);
            Assert.AreEqual(&quot;2&quot;, delayAction.beaconPid, &quot;Not same beacon id&quot;);
            Assert.AreEqual(DateTimeOffset.Parse(&quot;2015-05-16T12:00:00.000+0000&quot;), delayAction.dueTime, &quot;not same delay time&quot;);
            Assert.AreEqual(BeaconEventType.EnterExit, delayAction.eventTypeDetectedByDevice, &quot;not same event type&quot;);

            Assert.AreEqual(action.Delay, delayAction.resolvedAction.Delay, &quot;not same action delay&quot;);
            Assert.AreEqual(action.EventTypeDetectedByDevice, delayAction.resolvedAction.EventTypeDetectedByDevice, &quot;not same action event type&quot;);
            Assert.AreEqual(action.ReportImmediately, delayAction.resolvedAction.ReportImmediately, &quot;not same ReportImmediately&quot;);
            Assert.AreEqual(action.SendOnlyOnce, delayAction.resolvedAction.SendOnlyOnce, &quot;not same SendOnlyOnce&quot;);
            Assert.AreEqual(action.SupressionTime, delayAction.resolvedAction.SupressionTime, &quot;not same SendOnlyOnce&quot;);
            Assert.AreEqual(action.Timeframes.Count, delayAction.resolvedAction.Timeframes.Count, &quot;not same Timeframes count&quot;);
            Assert.AreEqual(action.Timeframes[0].Start, delayAction.resolvedAction.Timeframes[0].Start, &quot;not same Timeframes count&quot;);
            Assert.AreEqual(action.Timeframes[0].End, delayAction.resolvedAction.Timeframes[0].End, &quot;not same Timeframes count&quot;);

            Assert.AreEqual(action.BeaconPids.Count, delayAction.resolvedAction.BeaconPids.Count, &quot;not same beacon count&quot;);
            Assert.AreEqual(action.BeaconAction.Body, delayAction.resolvedAction.BeaconAction.Body, &quot;not same beacon action body&quot;);
            Assert.AreEqual(action.BeaconAction.Subject, delayAction.resolvedAction.BeaconAction.Subject, &quot;not same beacon action Subject&quot;);
            Assert.AreEqual(action.BeaconAction.Id, delayAction.resolvedAction.BeaconAction.Id, &quot;not same beacon action Id&quot;);
            Assert.AreEqual(action.BeaconAction.Type, delayAction.resolvedAction.BeaconAction.Type, &quot;not same beacon action Type&quot;);
            Assert.AreEqual(action.BeaconAction.Uuid, delayAction.resolvedAction.BeaconAction.Uuid, &quot;not same beacon action Uuid&quot;);
            Assert.AreEqual(action.BeaconAction.Payload.ToString(), delayAction.resolvedAction.BeaconAction.Payload.ToString(), &quot;not same beacon action Payload&quot;);


            Assert.AreEqual(action, delayAction.resolvedAction, &quot;not same action&quot;);


            await storage.SetDelayedActionAsExecuted(idToDelete);

            delayedActions = await storage.GetDelayedActions(int.MaxValue);
            Assert.AreEqual(1, delayedActions.Count, &quot;to many actions found after executing action&quot;);

            Assert.AreEqual(&quot;2&quot;, delayedActions[0].beaconPid, &quot;Not same beacon id&quot;);
        }


        [TestMethod]
        public async Task HistoryActionTest()
        {
            await storage.InitStorage();

            await storage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;1&quot;, &quot;1&quot;, DateTimeOffset.Parse(&quot;2016-04-16T12:00:00.000+0000&quot;), BeaconEventType.Enter));
            await storage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;2&quot;, &quot;2&quot;, DateTimeOffset.Parse(&quot;2016-04-16T13:00:00.000+0000&quot;), BeaconEventType.Exit));
            await storage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;3&quot;, &quot;3&quot;, DateTimeOffset.Parse(&quot;2016-04-16T14:00:00.000+0000&quot;), BeaconEventType.EnterExit));
            await storage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;3&quot;, &quot;2&quot;, DateTimeOffset.Parse(&quot;2016-04-16T14:00:00.000+0000&quot;), BeaconEventType.EnterExit));

            IList&lt;HistoryAction&gt; historyActions = await storage.GetUndeliveredActions();
            Assert.AreEqual(4, historyActions.Count, &quot;Not 4 actions&quot;);

            HistoryAction action = historyActions.First(t =&gt; t.trigger == (int) BeaconEventType.Enter);
            Assert.AreEqual(&quot;1&quot;, action.pid, &quot;not same pid&quot;);
            Assert.AreEqual(&quot;1&quot;, action.eid, &quot;not same eid&quot;);
            Assert.AreEqual(&quot;2016-04-16T12:00:00.000+00:00&quot;, action.dt, &quot;not same date&quot;);


            action = historyActions.First(t =&gt; t.trigger == (int) BeaconEventType.Exit);
            Assert.AreEqual(&quot;2&quot;, action.pid, &quot;not same pid&quot;);
            Assert.AreEqual(&quot;2&quot;, action.eid, &quot;not same eid&quot;);
            Assert.AreEqual(&quot;2016-04-16T13:00:00.000+00:00&quot;, action.dt, &quot;not same date&quot;);


            action = historyActions.First(t =&gt; t.trigger == (int) BeaconEventType.EnterExit &amp;&amp; t.pid == &quot;3&quot;);
            Assert.AreEqual(&quot;3&quot;, action.pid, &quot;not same pid&quot;);
            Assert.AreEqual(&quot;3&quot;, action.eid, &quot;not same eid&quot;);
            Assert.AreEqual(&quot;2016-04-16T14:00:00.000+00:00&quot;, action.dt, &quot;not same date&quot;);


            HistoryAction dbHistoryAction = await storage.GetAction(&quot;2&quot;);
            Assert.AreEqual((int) BeaconEventType.Exit, dbHistoryAction.trigger, &quot;not same type&quot;);
            Assert.AreEqual(&quot;2&quot;, dbHistoryAction.pid, &quot;not same pid&quot;);
            Assert.AreEqual(&quot;2&quot;, dbHistoryAction.eid, &quot;not same eid&quot;);
            Assert.AreEqual(DateTimeOffset.Parse(&quot;2016-04-16T13:00:00.000+0000&quot;), DateTimeOffset.Parse(dbHistoryAction.dt), &quot;not same date&quot;);


            IList&lt;HistoryAction&gt; dbHistoryActions = await storage.GetActions(&quot;3&quot;);
            Assert.AreEqual(2, dbHistoryActions.Count, &quot;Not 2 actions&quot;);

            dbHistoryAction = dbHistoryActions.First(t =&gt; t.pid == &quot;3&quot;);
            Assert.AreEqual((int) BeaconEventType.EnterExit, dbHistoryAction.trigger, &quot;not same type&quot;);
            Assert.AreEqual(&quot;3&quot;, dbHistoryAction.pid, &quot;not same pid&quot;);
            Assert.AreEqual(&quot;3&quot;, dbHistoryAction.eid, &quot;not same eid&quot;);
            Assert.AreEqual(DateTimeOffset.Parse(&quot;2016-04-16T14:00:00.000+0000&quot;), DateTimeOffset.Parse(dbHistoryAction.dt), &quot;not same date&quot;);

            dbHistoryAction = dbHistoryActions.First(t =&gt; t.pid == &quot;2&quot;);
            Assert.AreEqual((int) BeaconEventType.EnterExit, dbHistoryAction.trigger, &quot;not same type&quot;);
            Assert.AreEqual(&quot;2&quot;, dbHistoryAction.pid, &quot;not same pid&quot;);
            Assert.AreEqual(&quot;3&quot;, dbHistoryAction.eid, &quot;not same eid&quot;);
            Assert.AreEqual(DateTimeOffset.Parse(&quot;2016-04-16T14:00:00.000+0000&quot;), DateTimeOffset.Parse(dbHistoryAction.dt), &quot;not same date&quot;);

            Assert.AreEqual(0, (await storage.GetActions(&quot;&quot;)).Count, &quot;fails on empty id&quot;);
            Assert.AreEqual(0, (await storage.GetActions(&quot;1231312312&quot;)).Count, &quot;fails on unkown id&quot;);

            await storage.SetActionsAsDelivered();

            historyActions = await storage.GetUndeliveredActions();
            Assert.AreEqual(0, historyActions.Count, &quot;not all actions as delivered marked&quot;);


            Assert.IsNotNull(await storage.GetActions(&quot;3&quot;), &quot;no delivered message found&quot;);
            Assert.AreEqual(2, (await storage.GetActions(&quot;3&quot;)).Count, &quot;not all actions as delivered marked from eid 3 found&quot;);
        }

        [TestMethod]
        public async Task HistoryEventTest()
        {
            await storage.InitStorage();

            await storage.SaveHistoryEvents(FileStorageHelper.ToHistoryEvent(&quot;1&quot;, DateTimeOffset.Parse(&quot;2016-04-16T14:00:00.000+0000&quot;), BeaconEventType.Enter));
            await storage.SaveHistoryEvents(FileStorageHelper.ToHistoryEvent(&quot;1&quot;, DateTimeOffset.Parse(&quot;2016-04-16T15:00:00.000+0000&quot;), BeaconEventType.Exit));
            await storage.SaveHistoryEvents(FileStorageHelper.ToHistoryEvent(&quot;1&quot;, DateTimeOffset.Parse(&quot;2016-04-16T16:00:00.000+0000&quot;), BeaconEventType.EnterExit));
            await storage.SaveHistoryEvents(FileStorageHelper.ToHistoryEvent(&quot;2&quot;, DateTimeOffset.Parse(&quot;2016-04-16T17:00:00.000+0000&quot;), BeaconEventType.Enter));

            IList&lt;HistoryEvent&gt; historyEvents = await storage.GetUndeliveredEvents();
            HistoryEvent historyEvent = historyEvents.FirstOrDefault(h =&gt; h.dt == &quot;2016-04-16T15:00:00.000+00:00&quot;);
            Assert.AreEqual(&quot;1&quot;, historyEvent.pid, &quot;Wrong pid&quot;);
            Assert.AreEqual(&quot;2016-04-16T15:00:00.000+00:00&quot;, historyEvent.dt, &quot;Wrong date&quot;);
            Assert.AreEqual((int) BeaconEventType.Exit, historyEvent.trigger, &quot;Wrong trigger&quot;);



            await storage.SetEventsAsDelivered();

            historyEvents = await storage.GetUndeliveredEvents();
            Assert.AreEqual(0, historyEvents.Count, &quot;not all events as delivered marked&quot;);

        }

        [TestMethod]
        public async Task EventHistoryIssueTest()
        {
            await storage.InitStorage();

            await storage.SaveHistoryEvents(FileStorageHelper.ToHistoryEvent(&quot;1&quot;, DateTimeOffset.Parse(&quot;2016-04-16T14:00:00.000+0000&quot;), BeaconEventType.Enter));
            await storage.SaveHistoryEvents(FileStorageHelper.ToHistoryEvent(&quot;1&quot;, DateTimeOffset.Parse(&quot;2016-04-16T15:00:00.000+0000&quot;), BeaconEventType.Exit));
            await storage.SaveHistoryEvents(FileStorageHelper.ToHistoryEvent(&quot;1&quot;, DateTimeOffset.Parse(&quot;2016-04-16T16:00:00.000+0000&quot;), BeaconEventType.EnterExit));
            await storage.SaveHistoryEvents(FileStorageHelper.ToHistoryEvent(&quot;2&quot;, DateTimeOffset.Parse(&quot;2016-04-16T17:00:00.000+0000&quot;), BeaconEventType.Enter));

            IList&lt;HistoryEvent&gt; historyEvents = await storage.GetUndeliveredEvents();
            await storage.SaveHistoryEvents(FileStorageHelper.ToHistoryEvent(&quot;3&quot;, DateTimeOffset.Parse(&quot;2016-04-16T17:00:00.000+0000&quot;), BeaconEventType.Enter));
            await storage.SetEventsAsDelivered();

            historyEvents = await storage.GetUndeliveredEvents();
            Assert.AreEqual(1, historyEvents.Count, &quot;the new event is missing&quot;);
        }

        [TestMethod]
        public async Task StorageClearTest()
        {
            await storage.InitStorage();

            await storage.SaveHistoryEvents(FileStorageHelper.ToHistoryEvent(&quot;1&quot;, DateTimeOffset.Parse(&quot;2015-04-16T14:00:00.000+0000&quot;), BeaconEventType.Enter));
            await storage.SaveHistoryEvents(FileStorageHelper.ToHistoryEvent(&quot;1&quot;, DateTimeOffset.Parse(&quot;2015-04-16T15:00:00.000+0000&quot;), BeaconEventType.Exit));
            await storage.SaveHistoryEvents(FileStorageHelper.ToHistoryEvent(&quot;1&quot;, DateTimeOffset.Parse(&quot;2015-04-16T16:00:00.000+0000&quot;), BeaconEventType.EnterExit));
            await storage.SaveHistoryEvents(FileStorageHelper.ToHistoryEvent(&quot;2&quot;, DateTimeOffset.Parse(&quot;2015-04-16T17:00:00.000+0000&quot;), BeaconEventType.Enter));

            await storage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;1&quot;, &quot;1&quot;, DateTimeOffset.Parse(&quot;2015-04-16T12:00:00.000+0000&quot;), BeaconEventType.Enter));
            await storage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;2&quot;, &quot;2&quot;, DateTimeOffset.Parse(&quot;2015-04-16T13:00:00.000+0000&quot;), BeaconEventType.Exit));
            await storage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;3&quot;, &quot;3&quot;, DateTimeOffset.Parse(&quot;2015-04-16T14:00:00.000+0000&quot;), BeaconEventType.EnterExit));
            await storage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;3&quot;, &quot;2&quot;, DateTimeOffset.Parse(&quot;2015-04-16T14:00:00.000+0000&quot;), BeaconEventType.EnterExit));

            Assert.AreEqual(4, (await storage.GetUndeliveredEvents()).Count, &quot;not enough Undelivered Events found&quot;);
            Assert.AreEqual(4, (await storage.GetUndeliveredActions()).Count, &quot;not enough Undelivered Actions found&quot;);

            await storage.SetEventsAsDelivered();
            await storage.SetActionsAsDelivered();


            Assert.AreEqual(0, (await storage.GetUndeliveredEvents()).Count, &quot;Undelivered Events found&quot;);
            Assert.AreEqual(0, (await storage.GetUndeliveredActions()).Count, &quot;Undelivered Actions found&quot;);

            await storage.CleanDatabase();

            Assert.AreEqual(0, (await storage.GetActions(&quot;1&quot;)).Count, &quot;remaining Actions found&quot;);


            await storage.SaveHistoryEvents(FileStorageHelper.ToHistoryEvent(&quot;1&quot;, DateTimeOffset.Parse(&quot;2015-04-16T14:00:00.000+0000&quot;), BeaconEventType.Enter));
            await storage.SaveHistoryEvents(FileStorageHelper.ToHistoryEvent(&quot;1&quot;, DateTimeOffset.Parse(&quot;2015-04-16T15:00:00.000+0000&quot;), BeaconEventType.Exit));
            await storage.SaveHistoryEvents(FileStorageHelper.ToHistoryEvent(&quot;1&quot;, DateTimeOffset.Parse(&quot;2015-04-16T16:00:00.000+0000&quot;), BeaconEventType.EnterExit));
            await storage.SaveHistoryEvents(FileStorageHelper.ToHistoryEvent(&quot;2&quot;, DateTimeOffset.Parse(&quot;2015-04-16T17:00:00.000+0000&quot;), BeaconEventType.Enter));

            await storage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;1&quot;, &quot;1&quot;, DateTimeOffset.Parse(&quot;2015-04-16T12:00:00.000+0000&quot;), BeaconEventType.Enter));
            await storage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;2&quot;, &quot;2&quot;, DateTimeOffset.Parse(&quot;2015-04-16T13:00:00.000+0000&quot;), BeaconEventType.Exit));
            await storage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;3&quot;, &quot;3&quot;, DateTimeOffset.Parse(&quot;2015-04-16T14:00:00.000+0000&quot;), BeaconEventType.EnterExit));
            await storage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;3&quot;, &quot;2&quot;, DateTimeOffset.Parse(&quot;2015-04-16T14:00:00.000+0000&quot;), BeaconEventType.EnterExit));

            await storage.CleanDatabase();

            Assert.AreEqual(0, (await storage.GetUndeliveredEvents()).Count, &quot;Undelivered Events found&quot;);
            Assert.AreEqual(0, (await storage.GetUndeliveredActions()).Count, &quot;Undelivered Actions found&quot;);
        }

        [TestMethod]
        public async Task BackgroundEventStorageTest()
        {
            IStorage foregroundStorage = storage;
            await foregroundStorage.InitStorage();

            await foregroundStorage.SaveHistoryEvents(FileStorageHelper.ToHistoryEvent(&quot;1&quot;, DateTimeOffset.Parse(&quot;2016-04-16T14:00:00.000+0000&quot;), BeaconEventType.Enter));
            await foregroundStorage.SaveHistoryEvents(FileStorageHelper.ToHistoryEvent(&quot;1&quot;, DateTimeOffset.Parse(&quot;2016-04-16T15:00:00.000+0000&quot;), BeaconEventType.Exit));
            await foregroundStorage.SaveHistoryEvents(FileStorageHelper.ToHistoryEvent(&quot;1&quot;, DateTimeOffset.Parse(&quot;2016-04-16T16:00:00.000+0000&quot;), BeaconEventType.EnterExit));
            await foregroundStorage.SaveHistoryEvents(FileStorageHelper.ToHistoryEvent(&quot;2&quot;, DateTimeOffset.Parse(&quot;2016-04-16T17:00:00.000+0000&quot;), BeaconEventType.Enter));

            IList&lt;HistoryEvent&gt; historyEvents = await foregroundStorage.GetUndeliveredEvents();
            HistoryEvent historyEvent = historyEvents.FirstOrDefault(h =&gt; h.dt == &quot;2016-04-16T15:00:00.000+00:00&quot;);
            Assert.AreEqual(&quot;1&quot;, historyEvent.pid, &quot;Wrong pid&quot;);
            Assert.AreEqual(&quot;2016-04-16T15:00:00.000+00:00&quot;, historyEvent.dt, &quot;Wrong date&quot;);
            Assert.AreEqual((int) BeaconEventType.Exit, historyEvent.trigger, &quot;Wrong trigger&quot;);

            await foregroundStorage.SetEventsAsDelivered();

            historyEvents = await foregroundStorage.GetUndeliveredEvents();
            Assert.AreEqual(0, historyEvents.Count, &quot;not all events as delivered marked&quot;);


            IStorage backgroundStorage = new FileStorage() {Background = true};
            await backgroundStorage.InitStorage();

            await backgroundStorage.SaveHistoryEvents(FileStorageHelper.ToHistoryEvent(&quot;3&quot;, DateTimeOffset.Parse(&quot;2016-04-15T14:00:00.000+0000&quot;), BeaconEventType.Enter));
            await backgroundStorage.SaveHistoryEvents(FileStorageHelper.ToHistoryEvent(&quot;3&quot;, DateTimeOffset.Parse(&quot;2016-04-15T15:00:00.000+0000&quot;), BeaconEventType.Exit));
            await backgroundStorage.SaveHistoryEvents(FileStorageHelper.ToHistoryEvent(&quot;3&quot;, DateTimeOffset.Parse(&quot;2016-04-15T16:00:00.000+0000&quot;), BeaconEventType.EnterExit));
            await backgroundStorage.SaveHistoryEvents(FileStorageHelper.ToHistoryEvent(&quot;4&quot;, DateTimeOffset.Parse(&quot;2016-04-15T17:00:00.000+0000&quot;), BeaconEventType.Enter));

            historyEvents = await backgroundStorage.GetUndeliveredEvents();
            historyEvent = historyEvents.FirstOrDefault(h =&gt; h.dt == &quot;2016-04-15T15:00:00.000+00:00&quot;);
            Assert.AreEqual(&quot;3&quot;, historyEvent.pid, &quot;Wrong pid&quot;);
            Assert.AreEqual(&quot;2016-04-15T15:00:00.000+00:00&quot;, historyEvent.dt, &quot;Wrong date&quot;);
            Assert.AreEqual((int) BeaconEventType.Exit, historyEvent.trigger, &quot;Wrong trigger&quot;);

            await backgroundStorage.SetEventsAsDelivered();

            historyEvents = await backgroundStorage.GetUndeliveredEvents();
            Assert.AreEqual(0, historyEvents.Count, &quot;not all events as delivered marked&quot;);
        }

        [TestMethod]
        public async Task GetEventInForegroundFromBackgroundStorageTest()
        {
            IStorage foregroundStorage = storage;
            await foregroundStorage.InitStorage();
            IStorage backgroundStorage = new FileStorage() {Background = true};
            await backgroundStorage.InitStorage();

            await foregroundStorage.SaveHistoryEvents(FileStorageHelper.ToHistoryEvent(&quot;1&quot;, DateTimeOffset.Parse(&quot;2016-04-16T14:00:00.000+0000&quot;), BeaconEventType.Enter));
            await foregroundStorage.SaveHistoryEvents(FileStorageHelper.ToHistoryEvent(&quot;1&quot;, DateTimeOffset.Parse(&quot;2016-04-16T15:00:00.000+0000&quot;), BeaconEventType.Exit));
            await foregroundStorage.SaveHistoryEvents(FileStorageHelper.ToHistoryEvent(&quot;1&quot;, DateTimeOffset.Parse(&quot;2016-04-16T16:00:00.000+0000&quot;), BeaconEventType.EnterExit));
            await foregroundStorage.SaveHistoryEvents(FileStorageHelper.ToHistoryEvent(&quot;2&quot;, DateTimeOffset.Parse(&quot;2016-04-16T17:00:00.000+0000&quot;), BeaconEventType.Enter));

            await backgroundStorage.SaveHistoryEvents(FileStorageHelper.ToHistoryEvent(&quot;3&quot;, DateTimeOffset.Parse(&quot;2016-04-15T14:00:00.000+0000&quot;), BeaconEventType.Enter));
            await backgroundStorage.SaveHistoryEvents(FileStorageHelper.ToHistoryEvent(&quot;3&quot;, DateTimeOffset.Parse(&quot;2016-04-15T15:00:00.000+0000&quot;), BeaconEventType.Exit));
            await backgroundStorage.SaveHistoryEvents(FileStorageHelper.ToHistoryEvent(&quot;3&quot;, DateTimeOffset.Parse(&quot;2016-04-15T16:00:00.000+0000&quot;), BeaconEventType.EnterExit));
            await backgroundStorage.SaveHistoryEvents(FileStorageHelper.ToHistoryEvent(&quot;4&quot;, DateTimeOffset.Parse(&quot;2016-04-15T17:00:00.000+0000&quot;), BeaconEventType.Enter));

            //verify every storage api accesses every data
            IList&lt;HistoryEvent&gt; historyEvents = await backgroundStorage.GetUndeliveredEvents();
            HistoryEvent historyEvent = historyEvents.FirstOrDefault(h =&gt; h.dt == &quot;2016-04-15T15:00:00.000+00:00&quot;);
            Assert.AreEqual(&quot;3&quot;, historyEvent.pid, &quot;Wrong pid&quot;);
            Assert.AreEqual(&quot;2016-04-15T15:00:00.000+00:00&quot;, historyEvent.dt, &quot;Wrong date&quot;);
            Assert.AreEqual((int) BeaconEventType.Exit, historyEvent.trigger, &quot;Wrong trigger&quot;);

            historyEvent = historyEvents.FirstOrDefault(h =&gt; h.dt == &quot;2016-04-16T15:00:00.000+00:00&quot;);
            Assert.AreEqual(&quot;1&quot;, historyEvent.pid, &quot;Wrong pid&quot;);
            Assert.AreEqual(&quot;2016-04-16T15:00:00.000+00:00&quot;, historyEvent.dt, &quot;Wrong date&quot;);
            Assert.AreEqual((int) BeaconEventType.Exit, historyEvent.trigger, &quot;Wrong trigger&quot;);


            historyEvents = await foregroundStorage.GetUndeliveredEvents();
            historyEvent = historyEvents.FirstOrDefault(h =&gt; h.dt == &quot;2016-04-15T15:00:00.000+00:00&quot;);
            Assert.AreEqual(&quot;3&quot;, historyEvent.pid, &quot;Wrong pid&quot;);
            Assert.AreEqual(&quot;2016-04-15T15:00:00.000+00:00&quot;, historyEvent.dt, &quot;Wrong date&quot;);
            Assert.AreEqual((int) BeaconEventType.Exit, historyEvent.trigger, &quot;Wrong trigger&quot;);

            historyEvent = historyEvents.FirstOrDefault(h =&gt; h.dt == &quot;2016-04-16T15:00:00.000+00:00&quot;);
            Assert.AreEqual(&quot;1&quot;, historyEvent.pid, &quot;Wrong pid&quot;);
            Assert.AreEqual(&quot;2016-04-16T15:00:00.000+00:00&quot;, historyEvent.dt, &quot;Wrong date&quot;);
            Assert.AreEqual((int) BeaconEventType.Exit, historyEvent.trigger, &quot;Wrong trigger&quot;);


            await backgroundStorage.SetEventsAsDelivered();
            historyEvents = await backgroundStorage.GetUndeliveredEvents();
            Assert.AreEqual(0, historyEvents.Count, &quot;not all events as delivered marked - background&quot;);

            historyEvents = await foregroundStorage.GetUndeliveredEvents();
            Assert.AreEqual(0, historyEvents.Count, &quot;not all events as delivered marked - foreground&quot;);
        }

        [TestMethod]
        public async Task BackgroundActionStorageTest()
        {
            IStorage foregroundStorage = storage;
            await foregroundStorage.InitStorage();
            IStorage backgroundStorage = new FileStorage() {Background = true};
            await backgroundStorage.InitStorage();

            await foregroundStorage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;1&quot;, &quot;1&quot;, DateTimeOffset.Parse(&quot;2016-04-16T12:00:00.000+0000&quot;), BeaconEventType.Enter));
            await foregroundStorage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;2&quot;, &quot;2&quot;, DateTimeOffset.Parse(&quot;2016-04-16T13:00:00.000+0000&quot;), BeaconEventType.Exit));
            await foregroundStorage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;3&quot;, &quot;3&quot;, DateTimeOffset.Parse(&quot;2016-04-16T14:00:00.000+0000&quot;), BeaconEventType.EnterExit));
            await foregroundStorage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;3&quot;, &quot;2&quot;, DateTimeOffset.Parse(&quot;2016-04-16T14:00:00.000+0000&quot;), BeaconEventType.EnterExit));

            IList&lt;HistoryAction&gt; historyActions = await foregroundStorage.GetUndeliveredActions();
            Assert.AreEqual(4, historyActions.Count, &quot;Not 4 actions&quot;);

            HistoryAction action = historyActions.First(t =&gt; t.trigger == (int) BeaconEventType.Enter);
            Assert.AreEqual(&quot;1&quot;, action.pid, &quot;not same pid&quot;);
            Assert.AreEqual(&quot;1&quot;, action.eid, &quot;not same eid&quot;);
            Assert.AreEqual(&quot;2016-04-16T12:00:00.000+00:00&quot;, action.dt, &quot;not same date&quot;);


            action = historyActions.First(t =&gt; t.trigger == (int) BeaconEventType.Exit);
            Assert.AreEqual(&quot;2&quot;, action.pid, &quot;not same pid&quot;);
            Assert.AreEqual(&quot;2&quot;, action.eid, &quot;not same eid&quot;);
            Assert.AreEqual(&quot;2016-04-16T13:00:00.000+00:00&quot;, action.dt, &quot;not same date&quot;);

            HistoryAction dbHistoryAction = await foregroundStorage.GetAction(&quot;2&quot;);
            Assert.AreEqual((int) BeaconEventType.Exit, dbHistoryAction.trigger, &quot;not same type&quot;);
            Assert.AreEqual(&quot;2&quot;, dbHistoryAction.pid, &quot;not same pid&quot;);
            Assert.AreEqual(&quot;2&quot;, dbHistoryAction.eid, &quot;not same eid&quot;);
            Assert.AreEqual(DateTimeOffset.Parse(&quot;2016-04-16T13:00:00.000+0000&quot;), DateTimeOffset.Parse(dbHistoryAction.dt), &quot;not same date&quot;);


            IList&lt;HistoryAction&gt; dbHistoryActions = await foregroundStorage.GetActions(&quot;3&quot;);
            Assert.AreEqual(2, dbHistoryActions.Count, &quot;Not 2 actions&quot;);

            Assert.AreEqual(0, (await foregroundStorage.GetActions(&quot;&quot;)).Count, &quot;fails on empty id&quot;);
            Assert.AreEqual(0, (await foregroundStorage.GetActions(&quot;1231312312&quot;)).Count, &quot;fails on unkown id&quot;);

            await foregroundStorage.SetActionsAsDelivered();
            historyActions = await foregroundStorage.GetUndeliveredActions();
            Assert.AreEqual(0, historyActions.Count, &quot;not all actions as delivered marked&quot;);


            Assert.IsNotNull(await foregroundStorage.GetActions(&quot;3&quot;), &quot;no delivered message found&quot;);

            await backgroundStorage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;4&quot;, &quot;1&quot;, DateTimeOffset.Parse(&quot;2016-04-16T12:00:00.000+0000&quot;), BeaconEventType.Enter));
            await backgroundStorage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;5&quot;, &quot;2&quot;, DateTimeOffset.Parse(&quot;2016-04-16T13:00:00.000+0000&quot;), BeaconEventType.Exit));
            await backgroundStorage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;6&quot;, &quot;3&quot;, DateTimeOffset.Parse(&quot;2016-04-16T14:00:00.000+0000&quot;), BeaconEventType.EnterExit));
            await backgroundStorage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;6&quot;, &quot;2&quot;, DateTimeOffset.Parse(&quot;2016-04-16T14:00:00.000+0000&quot;), BeaconEventType.EnterExit));

            historyActions = await backgroundStorage.GetUndeliveredActions();
            Assert.AreEqual(4, historyActions.Count, &quot;Not 4 actions&quot;);

            action = historyActions.First(t =&gt; t.trigger == (int) BeaconEventType.Enter);
            Assert.AreEqual(&quot;1&quot;, action.pid, &quot;not same pid&quot;);
            Assert.AreEqual(&quot;4&quot;, action.eid, &quot;not same eid&quot;);
            Assert.AreEqual(&quot;2016-04-16T12:00:00.000+00:00&quot;, action.dt, &quot;not same date&quot;);


            action = historyActions.First(t =&gt; t.trigger == (int) BeaconEventType.Exit);
            Assert.AreEqual(&quot;2&quot;, action.pid, &quot;not same pid&quot;);
            Assert.AreEqual(&quot;5&quot;, action.eid, &quot;not same eid&quot;);
            Assert.AreEqual(&quot;2016-04-16T13:00:00.000+00:00&quot;, action.dt, &quot;not same date&quot;);


            dbHistoryAction = await backgroundStorage.GetAction(&quot;5&quot;);
            Assert.AreEqual((int) BeaconEventType.Exit, dbHistoryAction.trigger, &quot;not same type&quot;);
            Assert.AreEqual(&quot;2&quot;, dbHistoryAction.pid, &quot;not same pid&quot;);
            Assert.AreEqual(&quot;5&quot;, dbHistoryAction.eid, &quot;not same eid&quot;);
            Assert.AreEqual(DateTimeOffset.Parse(&quot;2016-04-16T13:00:00.000+0000&quot;), DateTimeOffset.Parse(dbHistoryAction.dt), &quot;not same date&quot;);


            dbHistoryActions = await backgroundStorage.GetActions(&quot;6&quot;);
            Assert.AreEqual(2, dbHistoryActions.Count, &quot;Not 2 actions&quot;);

            Assert.AreEqual(0, (await backgroundStorage.GetActions(&quot;&quot;)).Count, &quot;fails on empty id&quot;);
            Assert.AreEqual(0, (await backgroundStorage.GetActions(&quot;1231312312&quot;)).Count, &quot;fails on unkown id&quot;);

            await backgroundStorage.SetActionsAsDelivered();
            historyActions = await backgroundStorage.GetUndeliveredActions();
            Assert.AreEqual(0, historyActions.Count, &quot;not all actions as delivered marked&quot;);
        }

        [TestMethod]
        public async Task GetBackgroundActionsFromBackgroundinForegroundTest()
        {
            IStorage foregroundStorage = storage;
            IStorage backgroundStorage = new FileStorage() {Background = true};
            await backgroundStorage.InitStorage();

            await backgroundStorage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;1&quot;, &quot;1&quot;, DateTimeOffset.Parse(&quot;2016-04-16T12:00:00.000+0000&quot;), BeaconEventType.Enter));
            await backgroundStorage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;2&quot;, &quot;2&quot;, DateTimeOffset.Parse(&quot;2016-04-16T13:00:00.000+0000&quot;), BeaconEventType.Exit));
            await backgroundStorage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;3&quot;, &quot;3&quot;, DateTimeOffset.Parse(&quot;2016-04-16T14:00:00.000+0000&quot;), BeaconEventType.EnterExit));
            await backgroundStorage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;3&quot;, &quot;2&quot;, DateTimeOffset.Parse(&quot;2016-04-16T14:00:00.000+0000&quot;), BeaconEventType.EnterExit));
            await backgroundStorage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;4&quot;, &quot;1&quot;, DateTimeOffset.Parse(&quot;2016-04-16T12:00:00.000+0000&quot;), BeaconEventType.Enter));
            await backgroundStorage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;5&quot;, &quot;2&quot;, DateTimeOffset.Parse(&quot;2016-04-16T13:00:00.000+0000&quot;), BeaconEventType.Exit));
            await backgroundStorage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;6&quot;, &quot;3&quot;, DateTimeOffset.Parse(&quot;2016-04-16T14:00:00.000+0000&quot;), BeaconEventType.EnterExit));
            await backgroundStorage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;6&quot;, &quot;2&quot;, DateTimeOffset.Parse(&quot;2016-04-16T14:00:00.000+0000&quot;), BeaconEventType.EnterExit));

            await foregroundStorage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;1&quot;, &quot;1&quot;, DateTimeOffset.Parse(&quot;2016-04-16T12:00:00.000+0000&quot;), BeaconEventType.Enter));
            await foregroundStorage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;2&quot;, &quot;2&quot;, DateTimeOffset.Parse(&quot;2016-04-16T13:00:00.000+0000&quot;), BeaconEventType.Exit));
            await foregroundStorage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;3&quot;, &quot;3&quot;, DateTimeOffset.Parse(&quot;2016-04-16T14:00:00.000+0000&quot;), BeaconEventType.EnterExit));
            await foregroundStorage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;3&quot;, &quot;2&quot;, DateTimeOffset.Parse(&quot;2016-04-16T14:00:00.000+0000&quot;), BeaconEventType.EnterExit));
            await foregroundStorage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;4&quot;, &quot;1&quot;, DateTimeOffset.Parse(&quot;2016-04-16T12:00:00.000+0000&quot;), BeaconEventType.Enter));
            await foregroundStorage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;5&quot;, &quot;2&quot;, DateTimeOffset.Parse(&quot;2016-04-16T13:00:00.000+0000&quot;), BeaconEventType.Exit));
            await foregroundStorage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;6&quot;, &quot;3&quot;, DateTimeOffset.Parse(&quot;2016-04-16T14:00:00.000+0000&quot;), BeaconEventType.EnterExit));
            await foregroundStorage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;6&quot;, &quot;2&quot;, DateTimeOffset.Parse(&quot;2016-04-16T14:00:00.000+0000&quot;), BeaconEventType.EnterExit));


            IList&lt;HistoryAction&gt; historyActions = await backgroundStorage.GetUndeliveredActions();
            Assert.AreEqual(16, historyActions.Count, &quot;Not 16 actions&quot;);

            historyActions = await foregroundStorage.GetUndeliveredActions();
            Assert.AreEqual(16, historyActions.Count, &quot;Not 16 actions&quot;);

            HistoryAction dbHistoryAction = await backgroundStorage.GetAction(&quot;5&quot;);
            Assert.AreEqual((int) BeaconEventType.Exit, dbHistoryAction.trigger, &quot;not same type&quot;);
            Assert.AreEqual(&quot;2&quot;, dbHistoryAction.pid, &quot;not same pid&quot;);
            Assert.AreEqual(&quot;5&quot;, dbHistoryAction.eid, &quot;not same eid&quot;);
            Assert.AreEqual(DateTimeOffset.Parse(&quot;2016-04-16T13:00:00.000+0000&quot;), DateTimeOffset.Parse(dbHistoryAction.dt), &quot;not same date&quot;);

            dbHistoryAction = await foregroundStorage.GetAction(&quot;5&quot;);
            Assert.AreEqual((int) BeaconEventType.Exit, dbHistoryAction.trigger, &quot;not same type&quot;);
            Assert.AreEqual(&quot;2&quot;, dbHistoryAction.pid, &quot;not same pid&quot;);
            Assert.AreEqual(&quot;5&quot;, dbHistoryAction.eid, &quot;not same eid&quot;);
            Assert.AreEqual(DateTimeOffset.Parse(&quot;2016-04-16T13:00:00.000+0000&quot;), DateTimeOffset.Parse(dbHistoryAction.dt), &quot;not same date&quot;);


            IList&lt;HistoryAction&gt; dbHistoryActions = await backgroundStorage.GetActions(&quot;6&quot;);
            Assert.AreEqual(4, dbHistoryActions.Count, &quot;Not 4 actions&quot;);

            dbHistoryActions = await foregroundStorage.GetActions(&quot;6&quot;);
            Assert.AreEqual(4, dbHistoryActions.Count, &quot;Not 4 actions&quot;);


            await foregroundStorage.SetActionsAsDelivered();
            historyActions = await backgroundStorage.GetUndeliveredActions();
            Assert.AreEqual(0, historyActions.Count, &quot;not all actions as delivered marked&quot;);

        }

        [TestMethod]
        public async Task TestFileLock()
        {
            await storage.InitStorage();
            await storage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;1&quot;, &quot;1&quot;, DateTimeOffset.Parse(&quot;2016-04-16T12:00:00.000+0000&quot;), BeaconEventType.Enter));
            await storage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;2&quot;, &quot;2&quot;, DateTimeOffset.Parse(&quot;2016-04-16T13:00:00.000+0000&quot;), BeaconEventType.Exit));

            StorageFolder folder = await ((FileStorage) storage).GetFolder(FileStorage.FOREGROUND_ACTIONS_FOLDER);
            StorageFile file = await folder.CreateFileAsync(FileStorage.ACTIONS_FILE_NAME, CreationCollisionOption.OpenIfExists);
            IRandomAccessStream randomAccessStream;
            using (randomAccessStream = await file.OpenAsync(FileAccessMode.ReadWrite, StorageOpenOptions.AllowOnlyReaders))
            {
                Task.Run(() =&gt;
                {
                    Task.Delay(200);
                    randomAccessStream.Dispose();
                }).ConfigureAwait(false);
                await storage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;1&quot;, &quot;1&quot;, DateTimeOffset.Parse(&quot;2016-04-16T12:00:00.000+0000&quot;), BeaconEventType.Enter));
            }
            using (randomAccessStream = await file.OpenAsync(FileAccessMode.ReadWrite, StorageOpenOptions.AllowOnlyReaders))
            {
                try
                {
                    await storage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;2&quot;, &quot;2&quot;, DateTimeOffset.Parse(&quot;2016-04-16T13:00:00.000+0000&quot;), BeaconEventType.Exit));
                    Assert.Fail(&quot;No exception thrown&quot;);
                }
                catch (UnauthorizedAccessException)
                {
                }
                randomAccessStream.Dispose();
            }
            folder = await ((FileStorage) storage).GetFolder(FileStorage.FOREGROUND_EVENTS_FOLDER);
            file = await folder.CreateFileAsync(&quot;1&quot;, CreationCollisionOption.OpenIfExists);
            await storage.SaveHistoryEvents(FileStorageHelper.ToHistoryEvent(&quot;1&quot;, DateTimeOffset.Parse(&quot;2016-04-16T14:00:00.000+0000&quot;), BeaconEventType.Enter));
            await storage.SaveHistoryEvents(FileStorageHelper.ToHistoryEvent(&quot;1&quot;, DateTimeOffset.Parse(&quot;2016-04-16T15:00:00.000+0000&quot;), BeaconEventType.Exit));

            using (randomAccessStream = await file.OpenAsync(FileAccessMode.ReadWrite, StorageOpenOptions.AllowOnlyReaders))
            {
                Task.Run(() =&gt;
                {
                    Task.Delay(200);
                    randomAccessStream.Dispose();
                }).ConfigureAwait(false);
                await storage.SaveHistoryEvents(FileStorageHelper.ToHistoryEvent(&quot;1&quot;, DateTimeOffset.Parse(&quot;2016-04-16T14:00:00.000+0000&quot;), BeaconEventType.Enter));
            }
            using (randomAccessStream = await file.OpenAsync(FileAccessMode.ReadWrite, StorageOpenOptions.AllowOnlyReaders))
            {
                try
                {
                    await storage.SaveHistoryEvents(FileStorageHelper.ToHistoryEvent(&quot;1&quot;, DateTimeOffset.Parse(&quot;2016-04-16T15:00:00.000+0000&quot;), BeaconEventType.Exit));
                    Assert.Fail(&quot;No exception thrown&quot;);
                }
                catch (UnauthorizedAccessException)
                {
                }
                randomAccessStream.Dispose();
            }
        }

        [TestMethod]
        public async Task EventStateTest()
        {
            await storage.InitStorage();
            await storage.SaveBeaconEventState(&quot;1&quot;, BeaconEventType.Enter);
            await storage.SaveBeaconEventState(&quot;2&quot;, BeaconEventType.Enter);
            await storage.SaveBeaconEventState(&quot;3&quot;, BeaconEventType.Enter);
            await storage.SaveBeaconEventState(&quot;1&quot;, BeaconEventType.Exit);
            await storage.SaveBeaconEventState(&quot;4&quot;, BeaconEventType.Exit);


            Assert.AreEqual(BeaconEventType.Exit, (await storage.GetLastEventStateForBeacon(&quot;1&quot;)).LastEvent, &quot;Last event was not exit for 1&quot;);
            Assert.AreEqual(BeaconEventType.Enter, (await storage.GetLastEventStateForBeacon(&quot;2&quot;)).LastEvent, &quot;Last event was not enter for 2&quot;);
            Assert.AreEqual(BeaconEventType.Enter, (await storage.GetLastEventStateForBeacon(&quot;3&quot;)).LastEvent, &quot;Last event was not enter for 3&quot;);
            Assert.AreEqual(BeaconEventType.Exit, (await storage.GetLastEventStateForBeacon(&quot;4&quot;)).LastEvent, &quot;Last event was not exit for 4&quot;);
            Assert.IsNull(await storage.GetLastEventStateForBeacon(&quot;5&quot;), &quot;not null object&quot;);
        }

        [TestMethod]
        public async Task HistoryBeaconActionTest()
        {
            await storage.InitStorage();
            await storage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;1&quot;, &quot;1&quot;, DateTimeOffset.Parse(&quot;2016-04-16T12:00:00.000+0000&quot;), BeaconEventType.Enter));
            await storage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;2&quot;, &quot;2&quot;, DateTimeOffset.Parse(&quot;2016-04-16T13:00:00.000+0000&quot;), BeaconEventType.Exit));
            await storage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;3&quot;, &quot;3&quot;, DateTimeOffset.Parse(&quot;2016-04-16T14:00:00.000+0000&quot;), BeaconEventType.EnterExit));
            await storage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;3&quot;, &quot;2&quot;, DateTimeOffset.Parse(&quot;2016-04-16T14:00:00.000+0000&quot;), BeaconEventType.EnterExit));

            IList&lt;HistoryAction&gt; historyActions = await storage.GetUndeliveredActions();
            Assert.AreEqual(4, historyActions.Count, &quot;Not 4 actions&quot;);

            HistoryAction action = historyActions.First(t =&gt; t.trigger == (int) BeaconEventType.Enter);
            Assert.AreEqual(&quot;1&quot;, action.pid, &quot;not same pid&quot;);
            Assert.AreEqual(&quot;1&quot;, action.eid, &quot;not same eid&quot;);
            Assert.AreEqual(&quot;2016-04-16T12:00:00.000+00:00&quot;, action.dt, &quot;not same date&quot;);
        }

       /* [TestMethod]
        public async Task BackgroundActionsTest()
        {
            await storage.InitStorage();
            BeaconAction beaconAction = new BeaconAction();
            beaconAction.Body = &quot;body2&quot;;
            beaconAction.Id = 2;
            beaconAction.Payload = JsonObject.Parse(&quot;{\&quot;pay\&quot;:\&quot;load2\&quot;}&quot;);
            beaconAction.Subject = &quot;Subject2&quot;;
            beaconAction.Type = BeaconActionType.UrlMessage;
            beaconAction.Url = &quot;http://sensorberg.com&quot;;
            beaconAction.Uuid = &quot;uuid2&quot;;

            await storage.SaveHistoryAction(beaconAction);
            beaconAction = new BeaconAction();
            beaconAction.Body = &quot;body2&quot;;
            beaconAction.Id = 3;
            beaconAction.Payload = JsonObject.Parse(&quot;{\&quot;pay\&quot;:\&quot;load2\&quot;}&quot;);
            beaconAction.Subject = &quot;Subject2&quot;;
            beaconAction.Type = BeaconActionType.UrlMessage;
            beaconAction.Url = &quot;http://sensorberg.com&quot;;
            beaconAction.Uuid = &quot;uuid2&quot;;
            await storage.SaveActionForForeground(beaconAction);

            beaconAction = new BeaconAction();
            beaconAction.Body = &quot;body2&quot;;
            beaconAction.Id = 44;
            beaconAction.Payload = JsonObject.Parse(&quot;{\&quot;pay\&quot;:\&quot;load2\&quot;}&quot;);
            beaconAction.Subject = &quot;Subject2&quot;;
            beaconAction.Type = BeaconActionType.UrlMessage;
            beaconAction.Url = &quot;http://sensorberg.com&quot;;
            beaconAction.Uuid = &quot;uuid4&quot;;
            await storage.SaveActionForForeground(beaconAction);

            List&lt;BeaconAction&gt; actions = await storage.GetActionsForForeground(true);

            Assert.AreEqual(3, actions.Count, &quot;Not 3 actions found&quot;);
            Assert.AreEqual(beaconAction, actions.First(a =&gt; a.Id == 44));

            actions = await storage.GetActionsForForeground();
            Assert.AreEqual(3, actions.Count, &quot;Not 3 actions found&quot;);

            actions = await storage.GetActionsForForeground();
            Assert.AreEqual(0, actions.Count, &quot;Elements found, deletion not worked&quot;);
        }*/

        [TestMethod]
        public async Task ReadEmptyFolderFilesTest()
        {
            await storage.InitStorage();
            await storage.GetActionsForForeground();
            await storage.GetAction(&quot;1&quot;);
            await storage.GetActions(&quot;asd&quot;);
            await storage.GetDelayedActions(123);
            await storage.GetLastEventStateForBeacon(&quot;123&quot;);
            await storage.GetUndeliveredActions();
            await storage.GetUndeliveredEvents();
            await storage.CleanDatabase();
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[615,21,615,56,0],[616,17,616,18,0],[641,21,641,56,0],[642,17,642,18,0],[31,9,31,10,1],[32,13,32,63,1],[33,13,33,41,1],[34,9,34,10,1],[38,9,38,10,1],[39,13,39,43,1],[40,9,40,10,1],[49,9,49,10,1],[50,13,50,41,1],[51,9,51,10,1],[136,62,136,80,1],[164,62,164,80,1],[212,62,212,102,1],[218,48,218,87,1],[224,48,224,108,1],[240,59,240,71,1],[246,59,246,71,1],[276,75,276,114,1],[366,75,366,114,1],[386,62,386,101,1],[417,75,417,114,1],[422,62,422,101,1],[429,62,429,101,1],[434,62,434,101,1],[464,62,464,102,1],[470,48,470,87,1],[503,48,503,88,1],[509,48,509,87,1],[680,62,680,102,1],[55,9,55,10,1],[56,13,56,58,1],[57,13,57,54,1],[58,13,58,47,1],[59,13,59,40,1],[60,13,60,82,1],[61,13,61,53,1],[62,13,62,63,1],[63,13,63,63,1],[64,13,64,47,1],[65,13,65,32,1],[66,13,66,73,1],[67,13,67,74,1],[68,13,68,45,1],[69,13,69,40,1],[70,13,70,41,1],[71,13,74,15,1],[76,13,76,41,1],[78,13,78,135,1],[80,13,80,101,1],[81,13,81,79,1],[83,13,83,63,1],[84,13,84,79,1],[85,13,85,127,1],[86,13,86,114,1],[88,13,88,102,1],[89,13,89,147,1],[90,13,90,131,1],[91,13,91,116,1],[92,13,92,120,1],[93,13,93,128,1],[94,13,94,134,1],[95,13,95,130,1],[97,13,97,124,1],[98,13,98,132,1],[99,13,99,141,1],[100,13,100,126,1],[101,13,101,132,1],[102,13,102,132,1],[103,13,103,163,1],[106,13,106,84,1],[110,13,110,59,1],[111,13,111,55,1],[112,13,112,49,1],[113,13,113,41,1],[114,13,114,84,1],[115,13,115,55,1],[116,13,116,69,1],[117,13,117,64,1],[118,13,118,49,1],[119,13,119,34,1],[120,13,120,79,1],[121,13,121,75,1],[122,13,122,47,1],[123,13,123,42,1],[124,13,124,43,1],[125,13,128,15,1],[130,13,130,139,1],[133,13,133,76,1],[134,13,134,79,1],[136,13,136,62,1],[136,80,136,82,1],[137,13,137,48,1],[138,13,138,79,1],[139,13,139,127,1],[140,13,140,114,1],[142,13,142,102,1],[143,13,143,147,1],[144,13,144,131,1],[145,13,145,116,1],[146,13,146,120,1],[147,13,147,128,1],[148,13,148,134,1],[149,13,149,130,1],[151,13,151,124,1],[152,13,152,132,1],[153,13,153,141,1],[154,13,154,126,1],[155,13,155,132,1],[156,13,156,132,1],[157,13,157,163,1],[160,13,160,84,1],[164,13,164,62,1],[164,80,164,82,1],[165,13,165,79,1],[166,13,166,127,1],[167,13,167,118,1],[169,13,169,102,1],[170,13,170,147,1],[171,13,171,131,1],[172,13,172,116,1],[173,13,173,120,1],[174,13,174,128,1],[175,13,175,134,1],[176,13,176,130,1],[178,13,178,124,1],[179,13,179,132,1],[180,13,180,141,1],[181,13,181,126,1],[182,13,182,132,1],[183,13,183,132,1],[184,13,184,163,1],[187,13,187,84,1],[190,13,190,66,1],[192,13,192,76,1],[193,13,193,102,1],[195,13,195,85,1],[196,9,196,10,1],[201,9,201,10,1],[202,13,202,41,1],[204,13,204,167,1],[205,13,205,166,1],[206,13,206,171,1],[207,13,207,171,1],[209,13,209,89,1],[210,13,210,71,1],[212,13,212,62,1],[212,102,212,104,1],[213,13,213,62,1],[214,13,214,62,1],[215,13,215,90,1],[218,13,218,48,1],[218,87,218,89,1],[219,13,219,62,1],[220,13,220,62,1],[221,13,221,90,1],[224,13,224,48,1],[224,108,224,110,1],[225,13,225,62,1],[226,13,226,62,1],[227,13,227,90,1],[230,13,230,74,1],[231,13,231,99,1],[232,13,232,71,1],[233,13,233,71,1],[234,13,234,142,1],[237,13,237,83,1],[238,13,238,73,1],[240,13,240,59,1],[240,71,240,73,1],[241,13,241,104,1],[242,13,242,71,1],[243,13,243,71,1],[244,13,244,142,1],[246,13,246,59,1],[246,71,246,73,1],[247,13,247,104,1],[248,13,248,71,1],[249,13,249,71,1],[250,13,250,142,1],[252,13,252,91,1],[253,13,253,102,1],[255,13,255,51,1],[257,13,257,68,1],[258,13,258,93,1],[261,13,261,91,1],[262,13,262,127,1],[263,9,263,10,1],[267,9,267,10,1],[268,13,268,41,1],[270,13,270,161,1],[271,13,271,160,1],[272,13,272,165,1],[273,13,273,161,1],[275,13,275,86,1],[276,13,276,75,1],[276,114,276,116,1],[277,13,277,65,1],[278,13,278,93,1],[279,13,279,96,1],[283,13,283,50,1],[285,13,285,66,1],[286,13,286,91,1],[288,9,288,10,1],[292,9,292,10,1],[293,13,293,41,1],[295,13,295,161,1],[296,13,296,160,1],[297,13,297,165,1],[298,13,298,161,1],[300,13,300,86,1],[301,13,301,161,1],[302,13,302,50,1],[304,13,304,66,1],[305,13,305,81,1],[306,9,306,10,1],[310,9,310,10,1],[311,13,311,41,1],[313,13,313,161,1],[314,13,314,160,1],[315,13,315,165,1],[316,13,316,161,1],[318,13,318,167,1],[319,13,319,166,1],[320,13,320,171,1],[321,13,321,171,1],[323,13,323,117,1],[324,13,324,119,1],[326,13,326,50,1],[327,13,327,51,1],[330,13,330,106,1],[331,13,331,108,1],[333,13,333,43,1],[335,13,335,98,1],[338,13,338,161,1],[339,13,339,160,1],[340,13,340,165,1],[341,13,341,161,1],[343,13,343,167,1],[344,13,344,166,1],[345,13,345,171,1],[346,13,346,171,1],[348,13,348,43,1],[350,13,350,106,1],[351,13,351,108,1],[352,9,352,10,1],[356,9,356,10,1],[357,13,357,50,1],[358,13,358,51,1],[360,13,360,171,1],[361,13,361,170,1],[362,13,362,175,1],[363,13,363,171,1],[365,13,365,96,1],[366,13,366,75,1],[366,114,366,116,1],[367,13,367,65,1],[368,13,368,93,1],[369,13,369,96,1],[371,13,371,60,1],[373,13,373,76,1],[374,13,374,91,1],[377,13,377,80,1],[378,13,378,51,1],[380,13,380,171,1],[381,13,381,170,1],[382,13,382,175,1],[383,13,383,171,1],[385,13,385,76,1],[386,13,386,62,1],[386,101,386,103,1],[387,13,387,65,1],[388,13,388,93,1],[389,13,389,96,1],[391,13,391,60,1],[393,13,393,76,1],[394,13,394,91,1],[395,9,395,10,1],[399,9,399,10,1],[400,13,400,50,1],[401,13,401,51,1],[402,13,402,80,1],[403,13,403,51,1],[405,13,405,171,1],[406,13,406,170,1],[407,13,407,175,1],[408,13,408,171,1],[410,13,410,171,1],[411,13,411,170,1],[412,13,412,175,1],[413,13,413,171,1],[416,13,416,96,1],[417,13,417,75,1],[417,114,417,116,1],[418,13,418,65,1],[419,13,419,93,1],[420,13,420,96,1],[422,13,422,62,1],[422,101,422,103,1],[423,13,423,65,1],[424,13,424,93,1],[425,13,425,96,1],[428,13,428,76,1],[429,13,429,62,1],[429,101,429,103,1],[430,13,430,65,1],[431,13,431,93,1],[432,13,432,96,1],[434,13,434,62,1],[434,101,434,103,1],[435,13,435,65,1],[436,13,436,93,1],[437,13,437,96,1],[440,13,440,60,1],[441,13,441,76,1],[442,13,442,104,1],[444,13,444,76,1],[445,13,445,104,1],[446,9,446,10,1],[450,9,450,10,1],[451,13,451,50,1],[452,13,452,51,1],[453,13,453,80,1],[454,13,454,51,1],[456,13,456,177,1],[457,13,457,176,1],[458,13,458,181,1],[459,13,459,181,1],[461,13,461,99,1],[462,13,462,71,1],[464,13,464,62,1],[464,102,464,104,1],[465,13,465,62,1],[466,13,466,62,1],[467,13,467,90,1],[470,13,470,48,1],[470,87,470,89,1],[471,13,471,62,1],[472,13,472,62,1],[473,13,473,90,1],[475,13,475,84,1],[476,13,476,99,1],[477,13,477,71,1],[478,13,478,71,1],[479,13,479,142,1],[482,13,482,93,1],[483,13,483,73,1],[485,13,485,101,1],[486,13,486,112,1],[488,13,488,61,1],[489,13,489,78,1],[490,13,490,93,1],[493,13,493,101,1],[495,13,495,177,1],[496,13,496,176,1],[497,13,497,181,1],[498,13,498,181,1],[500,13,500,78,1],[501,13,501,71,1],[503,13,503,48,1],[503,88,503,90,1],[504,13,504,62,1],[505,13,505,62,1],[506,13,506,90,1],[509,13,509,48,1],[509,87,509,89,1],[510,13,510,62,1],[511,13,511,62,1],[512,13,512,90,1],[515,13,515,70,1],[516,13,516,99,1],[517,13,517,71,1],[518,13,518,71,1],[519,13,519,142,1],[522,13,522,72,1],[523,13,523,73,1],[525,13,525,101,1],[526,13,526,112,1],[528,13,528,61,1],[529,13,529,78,1],[530,13,530,93,1],[531,9,531,10,1],[535,9,535,10,1],[536,13,536,50,1],[537,13,537,80,1],[538,13,538,51,1],[540,13,540,177,1],[541,13,541,176,1],[542,13,542,181,1],[543,13,543,181,1],[544,13,544,177,1],[545,13,545,176,1],[546,13,546,181,1],[547,13,547,181,1],[549,13,549,177,1],[550,13,550,176,1],[551,13,551,181,1],[552,13,552,181,1],[553,13,553,177,1],[554,13,554,176,1],[555,13,555,181,1],[556,13,556,181,1],[559,13,559,99,1],[560,13,560,73,1],[562,13,562,78,1],[563,13,563,73,1],[565,13,565,84,1],[566,13,566,99,1],[567,13,567,71,1],[568,13,568,71,1],[569,13,569,142,1],[571,13,571,70,1],[572,13,572,99,1],[573,13,573,71,1],[574,13,574,71,1],[575,13,575,142,1],[578,13,578,93,1],[579,13,579,73,1],[581,13,581,72,1],[582,13,582,73,1],[585,13,585,61,1],[586,13,586,78,1],[587,13,587,93,1],[589,9,589,10,1],[604,17,604,18,1],[605,21,605,37,1],[606,21,606,50,1],[607,17,607,18,1],[630,17,630,18,1],[631,21,631,37,1],[632,21,632,50,1],[633,17,633,18,1],[593,9,593,10,1],[594,13,594,41,1],[595,13,595,167,1],[596,13,596,166,1],[598,13,598,115,1],[599,13,599,130,1],[601,13,601,125,1],[602,13,602,14,1],[603,17,604,17,1],[604,18,605,21,1],[605,37,606,21,1],[606,50,607,17,1],[607,18,607,42,1],[608,17,608,171,1],[609,13,609,14,1],[610,13,610,125,1],[611,13,611,14,1],[613,17,613,18,1],[614,21,614,174,1],[617,17,617,52,1],[618,17,618,18,1],[619,17,619,18,1],[620,17,620,46,1],[621,13,621,14,1],[622,13,622,100,1],[623,13,623,92,1],[624,13,624,161,1],[625,13,625,160,1],[627,13,627,125,1],[628,13,628,14,1],[629,17,630,17,1],[630,18,631,21,1],[631,37,632,21,1],[632,50,633,17,1],[633,18,633,42,1],[634,17,634,165,1],[635,13,635,14,1],[636,13,636,125,1],[637,13,637,14,1],[639,17,639,18,1],[640,21,640,168,1],[643,17,643,52,1],[644,17,644,18,1],[645,17,645,18,1],[646,17,646,46,1],[647,13,647,14,1],[648,9,648,10,1],[652,9,652,10,1],[653,13,653,41,1],[654,13,654,76,1],[655,13,655,76,1],[656,13,656,76,1],[657,13,657,75,1],[658,13,658,75,1],[661,13,661,143,1],[662,13,662,145,1],[663,13,663,145,1],[664,13,664,143,1],[665,13,665,93,1],[666,9,666,10,1],[670,9,670,10,1],[671,13,671,41,1],[672,13,672,167,1],[673,13,673,166,1],[674,13,674,171,1],[675,13,675,171,1],[677,13,677,89,1],[678,13,678,71,1],[680,13,680,62,1],[680,102,680,104,1],[681,13,681,62,1],[682,13,682,62,1],[683,13,683,90,1],[684,9,684,10,1],[734,9,734,10,1],[735,13,735,41,1],[736,13,736,53,1],[737,13,737,42,1],[738,13,738,45,1],[739,13,739,50,1],[740,13,740,61,1],[741,13,741,51,1],[742,13,742,50,1],[743,13,743,43,1],[744,9,744,10,1]]);
    </script>
  </body>
</html>