<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>d:\work\sensorberg\windows10-sdk\sensorbergsdktests\backgroundenginetest.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
// Created by Kay Czarnotta on 20.04.2016
// 
// Copyright (c) 2016,  Sensorberg
// 
// All rights reserved.

using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.IO;
using System.Linq;
using System.Threading.Tasks;
using Windows.Devices.Bluetooth;
using Windows.Storage;
using MetroLog;
using Microsoft.VisualStudio.TestPlatform.UnitTestFramework;
using SensorbergSDK;
using SensorbergSDK.Internal;
using SensorbergSDK.Internal.Services;
using SensorbergSDKBackground;
using SensorbergSDKTests.Mocks;

namespace SensorbergSDKTests
{
    [TestClass]
    public class BackgroundEngineTest
    {
        private static readonly ILogger logger = LogManagerFactory.DefaultLogManager.GetLogger&lt;BackgroundEngineTest&gt;();
        private const int OUT_OF_RANGE_DB = -128;

        [TestInitialize]
        public async Task Setup()
        {
            ServiceManager.ReadOnlyForTests = false;
            ServiceManager.Clear();
            ServiceManager.ApiConnction = new MockApiConnection();
            ServiceManager.LayoutManager = new LayoutManager();
            ServiceManager.SettingsManager = new SettingsManager();
            ServiceManager.StorageService = new StorageService() {Storage = new MockStorage()};
            ServiceManager.ReadOnlyForTests = true;
            logger.Debug(&quot;Setup - End&quot;);
        }

        [TestMethod]
        [Timeout(2000)]
        public async Task ResolveBackgroundEvent()
        {
            logger.Debug(&quot;ResolveBackgroundEvent - Start&quot;);
            LayoutManager layoutManager = (LayoutManager) ServiceManager.LayoutManager;
            await layoutManager.VerifyLayoutAsync(true);
            BeaconAction orgAction = layoutManager.Layout.ResolvedActions.FirstOrDefault(ra =&gt; ra.BeaconAction.Uuid == &quot;9ded63644e424d758b0218f7c70f2473&quot;).BeaconAction;

            List&lt;Beacon&gt; list = new List&lt;Beacon&gt;() {new Beacon() {Id1 = &quot;7367672374000000ffff0000ffff0004&quot;, Id2 = 39178, Id3 = 30929}};
            BackgroundEngine engine = new BackgroundEngine();
            TaskCompletionSource&lt;BeaconAction&gt; action = new TaskCompletionSource&lt;BeaconAction&gt;();
            engine.BeaconActionResolved += (sender, args) =&gt;
            {
                action.SetResult(args);
            };
            await engine.InitializeAsync();
            await engine.ResolveBeaconActionsAsync(list, OUT_OF_RANGE_DB);


            BeaconAction result = await action.Task;

            Assert.AreEqual(orgAction, result, &quot;action not found&quot;);
            logger.Debug(&quot;ResolveBackgroundEvent - End&quot;);
        }

        [TestMethod]
        [Timeout(2000)]
        public async Task ResolveBackgroundEventSingle()
        {
            logger.Debug(&quot;ResolveBackgroundEventSingle - Start&quot;);
            LayoutManager layoutManager = (LayoutManager) ServiceManager.LayoutManager;
            await layoutManager.VerifyLayoutAsync(true);
            BeaconAction orgAction = layoutManager.Layout.ResolvedActions.FirstOrDefault(ra =&gt; ra.BeaconAction.Uuid == &quot;9ded63644e424d758b0218f7c70f2473&quot;).BeaconAction;

            List&lt;Beacon&gt; list = new List&lt;Beacon&gt;()
            {
                new Beacon() {Id1 = &quot;7367672374000000ffff0000ffff0004&quot;, Id2 = 39178, Id3 = 30929},
                new Beacon() {Id1 = &quot;7367672374000000ffff0000ffff0004&quot;, Id2 = 39178, Id3 = 30929}
            };
            BackgroundEngine engine = new BackgroundEngine();
            TaskCompletionSource&lt;BeaconAction&gt; action = new TaskCompletionSource&lt;BeaconAction&gt;();
            int resolveCount = 0;
            engine.BeaconActionResolved += (sender, args) =&gt;
            {
                resolveCount++;
                action.SetResult(args);
            };
            await engine.InitializeAsync();
            await engine.ResolveBeaconActionsAsync(list, OUT_OF_RANGE_DB);


            BeaconAction result = await action.Task;

            Assert.AreEqual(orgAction, result, &quot;action not found&quot;);
            Assert.AreEqual(1, resolveCount, &quot;More then onetime resolved&quot;);
            logger.Debug(&quot;ResolveBackgroundEventSingle - End&quot;);
        }

        [TestMethod]
        [Timeout(2000)]
        public async Task ResolveBackgroundEventSupress()
        {
            logger.Debug(&quot;ResolveBackgroundEventSupress - Start&quot;);
            LayoutManager layoutManager = (LayoutManager) ServiceManager.LayoutManager;
            await layoutManager.VerifyLayoutAsync(true);
            BeaconAction orgAction = layoutManager.Layout.ResolvedActions.FirstOrDefault(ra =&gt; ra.BeaconAction.Uuid == &quot;9ded63644e424d758b0218f7c70f2473&quot;).BeaconAction;

            List&lt;Beacon&gt; list = new List&lt;Beacon&gt;()
            {
                new Beacon() {Id1 = &quot;7367672374000000ffff0000ffff0004&quot;, Id2 = 39178, Id3 = 30929},
                new Beacon() {Id1 = &quot;7367672374000000ffff0000ffff0003&quot;, Id2 = 48869, Id3 = 21321},
                new Beacon() {Id1 = &quot;7367672374000000ffff0000ffff0004&quot;, Id2 = 39178, Id3 = 30929},
                new Beacon() {Id1 = &quot;7367672374000000ffff0000ffff0003&quot;, Id2 = 48869, Id3 = 21321}
            };
            BackgroundEngine engine = new BackgroundEngine();
            TaskCompletionSource&lt;BeaconAction&gt; action = new TaskCompletionSource&lt;BeaconAction&gt;();
            int resolveCount = 0;
            engine.BeaconActionResolved += (sender, args) =&gt;
            {
                resolveCount++;
                action.TrySetResult(args);
            };
            await engine.InitializeAsync();
            await engine.ResolveBeaconActionsAsync(list, OUT_OF_RANGE_DB);


            BeaconAction result = await action.Task;

            Assert.AreEqual(orgAction, result, &quot;action not found&quot;);
            Assert.AreEqual(4, resolveCount, &quot;More then 4 resolved&quot;);
            logger.Debug(&quot;ResolveBackgroundEventSupress - End&quot;);
        }

        [TestMethod]
        public async Task ResolveMultipleAction()
        {
            logger.Debug(&quot;ResolveMultipleAction - Start&quot;);
            LayoutManager layoutManager = (LayoutManager) ServiceManager.LayoutManager;
            await layoutManager.VerifyLayoutAsync(true);

            BackgroundEngine engine = new BackgroundEngine();
            IList&lt;BeaconAction&gt; actions = new List&lt;BeaconAction&gt;();
            engine.BeaconActionResolved += (sender, args) =&gt;
            {
                actions.Add(args);
            };
            List&lt;Beacon&gt; list = new List&lt;Beacon&gt;() {new Beacon() {Id1 = &quot;7367672374000000ffff0000ffff0003&quot;, Id2 = 48869, Id3 = 21321}};

            await engine.InitializeAsync();
            await engine.ResolveBeaconActionsAsync(list, OUT_OF_RANGE_DB);


            Assert.AreEqual(4, actions.Count, &quot;Not 4 action found&quot;);
            logger.Debug(&quot;ResolveMultipleAction - End&quot;);
        }

        [TestMethod]
        public async Task ResolveSingleActionNoResult()
        {
            logger.Debug(&quot;ResolveSingleActionNoResult - Start&quot;);
            LayoutManager layoutManager = (LayoutManager) ServiceManager.LayoutManager;
            await layoutManager.VerifyLayoutAsync(true);

            BackgroundEngine engine = new BackgroundEngine();
            TaskCompletionSource&lt;IList&lt;BeaconAction&gt;&gt; action = new TaskCompletionSource&lt;IList&lt;BeaconAction&gt;&gt;();
            IList&lt;BeaconAction&gt; actions = new List&lt;BeaconAction&gt;();
            engine.BeaconActionResolved += (sender, args) =&gt;
            {
                actions.Add(args);
                if (actions.Count &gt;= 3)
                {
                    action.SetResult(actions);
                }
            };
            List&lt;Beacon&gt; list = new List&lt;Beacon&gt;() {new Beacon() {Id1 = &quot;7367672374000000ffff0000ffff1234&quot;, Id2 = 39178, Id3 = 30929}};

            if (await Task.WhenAny(action.Task, Task.Delay(500)) == action.Task)
            {
                Assert.AreEqual(0, action.Task.Result, &quot;Not 0 action found&quot;);
            }
            else
            {
                //timeout is fine
            }
            logger.Debug(&quot;ResolveSingleActionNoResult - End&quot;);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[172,13,172,14,0],[173,17,173,35,0],[174,17,174,40,0],[175,17,175,18,0],[176,21,176,47,0],[177,17,177,18,0],[178,13,178,14,0],[182,13,182,14,0],[183,17,183,78,0],[184,13,184,14,0],[28,9,28,120,1],[33,9,33,10,1],[34,13,34,53,1],[35,13,35,36,1],[36,13,36,67,1],[37,13,37,64,1],[38,13,38,68,1],[39,13,39,96,1],[40,13,40,52,1],[41,13,41,41,1],[42,9,42,10,1],[57,13,57,14,1],[58,17,58,40,1],[59,13,59,14,1],[51,96,51,154,1],[77,96,77,154,1],[110,96,110,154,1],[47,9,47,10,1],[48,13,48,60,1],[49,13,49,88,1],[50,13,50,57,1],[51,13,51,96,1],[51,154,51,169,1],[53,13,53,136,1],[54,13,54,62,1],[55,13,55,98,1],[56,13,57,13,1],[57,14,58,17,1],[58,40,59,13,1],[59,14,59,15,1],[60,13,60,44,1],[61,13,61,75,1],[64,13,64,53,1],[66,13,66,68,1],[67,13,67,58,1],[68,9,68,10,1],[88,13,88,14,1],[89,17,89,32,1],[90,17,90,40,1],[91,13,91,14,1],[73,9,73,10,1],[74,13,74,66,1],[75,13,75,88,1],[76,13,76,57,1],[77,13,77,96,1],[77,154,77,169,1],[79,13,83,15,1],[84,13,84,62,1],[85,13,85,98,1],[86,13,86,34,1],[87,13,88,13,1],[88,14,89,17,1],[89,32,90,17,1],[90,40,91,13,1],[91,14,91,15,1],[92,13,92,44,1],[93,13,93,75,1],[96,13,96,53,1],[98,13,98,68,1],[99,13,99,76,1],[100,13,100,64,1],[101,9,101,10,1],[123,13,123,14,1],[124,17,124,32,1],[125,17,125,43,1],[126,13,126,14,1],[106,9,106,10,1],[107,13,107,67,1],[108,13,108,88,1],[109,13,109,57,1],[110,13,110,96,1],[110,154,110,169,1],[112,13,118,15,1],[119,13,119,62,1],[120,13,120,98,1],[121,13,121,34,1],[122,13,123,13,1],[123,14,124,17,1],[124,32,125,17,1],[125,43,126,13,1],[126,14,126,15,1],[127,13,127,44,1],[128,13,128,75,1],[131,13,131,53,1],[133,13,133,68,1],[134,13,134,70,1],[135,13,135,65,1],[136,9,136,10,1],[148,13,148,14,1],[149,17,149,35,1],[150,13,150,14,1],[140,9,140,10,1],[141,13,141,59,1],[142,13,142,88,1],[143,13,143,57,1],[145,13,145,62,1],[146,13,146,68,1],[147,13,148,13,1],[148,14,149,17,1],[149,35,150,13,1],[150,14,150,15,1],[151,13,151,136,1],[153,13,153,44,1],[154,13,154,75,1],[157,13,157,69,1],[158,13,158,57,1],[159,9,159,10,1],[163,9,163,10,1],[164,13,164,65,1],[165,13,165,88,1],[166,13,166,57,1],[168,13,168,62,1],[169,13,169,112,1],[170,13,170,68,1],[171,13,172,13,1],[172,14,173,17,1],[173,35,174,17,1],[174,40,175,17,1],[175,18,176,21,1],[176,47,177,17,1],[177,18,178,13,1],[178,14,178,15,1],[179,13,179,136,1],[181,13,181,81,1],[186,13,186,14,1],[188,13,188,14,1],[189,13,189,63,1],[190,9,190,10,1]]);
    </script>
  </body>
</html>