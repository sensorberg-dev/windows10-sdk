<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>d:\work\sensorberg\windows10-sdk\sensorbergsdktests\requestqueuetest.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
// Created by Kay Czarnotta on 09.03.2016
// 
// Copyright (c) 2016,  Sensorberg
// 
// All rights reserved.

using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Threading.Tasks;
using Windows.Storage;
using Microsoft.VisualStudio.TestPlatform.UnitTestFramework;
using SensorbergSDK;
using SensorbergSDK.Internal;
using SensorbergSDK.Internal.Services;
using SensorbergSDKTests.Mocks;

namespace SensorbergSDKTests
{
    [TestClass]
    public class RequestQueueTest
    {
        [TestInitialize]
        public async Task TestSetup()
        {
            ServiceManager.ReadOnlyForTests = false;
            ServiceManager.Clear();
            ServiceManager.LayoutManager = new MockLayoutManager();
            ServiceManager.ReadOnlyForTests = true;
        }

        [TestMethod]
        public async Task SimpleRequestQueueTest()
        {
            RequestQueue queue = new RequestQueue();
            Request req = new Request(new BeaconEventArgs(), 1);
            TaskCompletionSource&lt;RequestResultState&gt; requestReady = new TaskCompletionSource&lt;RequestResultState&gt;();
            req.Result += (sender, state1) =&gt; { requestReady.SetResult(state1); };
            queue.Add(req);

            RequestResultState state = await requestReady.Task;
            Assert.AreEqual(RequestResultState.Success, state, &quot;Request not successfull&quot;);
        }

        [TestMethod]
        public async Task MultipleRequestQueueTest()
        {
            RequestQueue queue = new RequestQueue();
            TaskCompletionSource&lt;RequestResultState&gt; requestReady = new TaskCompletionSource&lt;RequestResultState&gt;();
            List&lt;RequestResultState&gt; requestsList = new List&lt;RequestResultState&gt;();
            for (int i = 0; i &lt; 10; i++)
            {
                Request req = new Request(new BeaconEventArgs(), i);
                if (i == 9)
                {
                    req.Result += (sender, state1) =&gt;
                    {
                        Debug.WriteLine(&quot;MultipleRequestQueueTest - &quot; + ((Request) sender).RequestId + &quot; - &quot; + state1);
                        requestsList.Add(state1);
                        requestReady.SetResult(state1);
                    };
                }
                else
                {
                    req.Result += (sender, state1) =&gt;
                    {
                        Debug.WriteLine(&quot;MultipleRequestQueueTest - &quot; + ((Request) sender).RequestId + &quot; - &quot; + state1);
                        requestsList.Add(state1);
                    };
                }
                queue.Add(req);
            }
            if (await Task.WhenAny(requestReady.Task, Task.Delay(500000)) == requestReady.Task)
            {
                Assert.AreEqual(RequestResultState.Success, requestReady.Task.Result, &quot;Request not successfull&quot;);

                Assert.AreEqual(10, requestsList.Count, &quot;Not 10 request results&quot;);
            }
            else
            {
                Assert.Fail(&quot;Timout&quot;);
            }
        }


        [TestMethod]
        public async Task MultipleRequestWithFailuresQueueTest()
        {
            ((MockLayoutManager) ServiceManager.LayoutManager).ShouldFail += (r, fail) =&gt;
            {
                if (r.RequestId == 5 &amp;&amp; r.TryCount == 1)
                {
                    fail.Fail = true;
                    return;
                }

                if (r.RequestId == 6)
                {
                    fail.Fail = true;
                    return;
                }
            };

            RequestQueue queue = new RequestQueue();
            TaskCompletionSource&lt;RequestResultState&gt; requestReady = new TaskCompletionSource&lt;RequestResultState&gt;();
            List&lt;RequestResultState&gt; requestsList = new List&lt;RequestResultState&gt;();
            for (int i = 0; i &lt; 10; i++)
            {
                Request req = new Request(new BeaconEventArgs(), i);
                req.Result += (sender, state1) =&gt;
                {
                    Debug.WriteLine(&quot;MultipleRequestWithFailuresQueueTest - &quot; + ((Request) sender).RequestId + &quot; - &quot; + state1);
                    if (((Request) sender).RequestId == 5 &amp;&amp; ((Request) sender).TryCount != 2)
                    {
                        return;
                    }
                    if (((Request) sender).RequestId == 6 &amp;&amp; ((Request) sender).TryCount != 3)
                    {
                        return;
                    }
                    requestsList.Add(state1);
                    if (queue.QueueSize == 0)
                    {
                        requestReady.SetResult(state1);
                    }
                };
                queue.Add(req);
            }
            if (await Task.WhenAny(requestReady.Task, Task.Delay(500000)) == requestReady.Task)
            {
                Assert.AreEqual(RequestResultState.Failed, requestReady.Task.Result, &quot;Request successfull (last should fail)&quot;);

                Assert.AreEqual(10, requestsList.Count, &quot;Not 10 request results&quot;);
            }
            else
            {
                Assert.Fail(&quot;Timout&quot;);
            }
        }

        [TestMethod]
        public async Task MultipleRequestBlocksQueueTest()
        {
            RequestQueue queue = new RequestQueue();
            TaskCompletionSource&lt;RequestResultState&gt; requestReady = new TaskCompletionSource&lt;RequestResultState&gt;();
            List&lt;RequestResultState&gt; requestsList = new List&lt;RequestResultState&gt;();
            for (int i = 0; i &lt; 10; i++)
            {
                Request req = new Request(new BeaconEventArgs(), i);
                req.Result += (sender, state1) =&gt;
                {
                    Debug.WriteLine(&quot;MultipleRequestBlocksQueueTest - &quot; + ((Request) sender).RequestId + &quot; - &quot; + state1);
                    requestsList.Add(state1);
                    if (requestsList.Count == 10)
                    {
                        requestReady.SetResult(state1);
                    }
                };
                queue.Add(req);
            }
            if (await Task.WhenAny(requestReady.Task, Task.Delay(500000)) == requestReady.Task)
            {
                Assert.AreEqual(RequestResultState.Success, requestReady.Task.Result, &quot;Request not successfull&quot;);

                Assert.AreEqual(10, requestsList.Count, &quot;Not 10 request results&quot;);
            }
            else
            {
                Assert.Fail(&quot;Timout&quot;);
            }



            requestReady = new TaskCompletionSource&lt;RequestResultState&gt;();
            requestsList = new List&lt;RequestResultState&gt;();
            for (int i = 0; i &lt; 10; i++)
            {
                Request req = new Request(new BeaconEventArgs(), i);
                req.Result += (sender, state1) =&gt;
                {
                    Debug.WriteLine(&quot;MultipleRequestBlocksQueueTest#2 - &quot; + ((Request) sender).RequestId + &quot; - &quot; + state1);
                    requestsList.Add(state1);
                    if (requestsList.Count == 10)
                    {
                        requestReady.SetResult(state1);
                    }
                };
                queue.Add(req);
            }
            if (await Task.WhenAny(requestReady.Task, Task.Delay(500000)) == requestReady.Task)
            {
                Assert.AreEqual(RequestResultState.Success, requestReady.Task.Result, &quot;Request not successfull&quot;);

                Assert.AreEqual(10, requestsList.Count, &quot;Not 10 request results&quot;);
            }
            else
            {
                Assert.Fail(&quot;Timout2&quot;);
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[80,13,80,14,0],[81,17,81,39,0],[114,21,114,22,0],[115,25,115,32,0],[118,21,118,22,0],[119,25,119,32,0],[136,13,136,14,0],[137,17,137,39,0],[168,13,168,14,0],[169,17,169,39,0],[170,13,170,14,0],[197,13,197,14,0],[198,17,198,40,0],[25,9,25,10,1],[26,13,26,53,1],[27,13,27,36,1],[28,13,28,68,1],[29,13,29,52,1],[30,9,30,10,1],[38,47,38,48,1],[38,49,38,80,1],[38,81,38,82,1],[34,9,34,10,1],[35,13,35,53,1],[36,13,36,65,1],[37,13,37,116,1],[38,13,38,47,1],[38,48,38,49,1],[38,80,38,81,1],[38,82,38,83,1],[39,13,39,28,1],[41,13,41,64,1],[42,13,42,91,1],[43,9,43,10,1],[57,21,57,22,1],[58,25,58,120,1],[59,25,59,50,1],[60,25,60,56,1],[61,21,61,22,1],[66,21,66,22,1],[67,25,67,120,1],[68,25,68,50,1],[69,21,69,22,1],[47,9,47,10,1],[48,13,48,53,1],[49,13,49,116,1],[50,13,50,84,1],[51,18,51,27,1],[52,13,52,14,1],[53,17,53,69,1],[54,17,54,28,1],[55,17,55,18,1],[56,21,57,21,1],[57,22,58,25,1],[58,120,59,25,1],[59,50,60,25,1],[60,56,61,21,1],[61,22,61,23,1],[62,17,62,18,1],[64,17,64,18,1],[65,21,66,21,1],[66,22,67,25,1],[67,120,68,25,1],[68,50,69,21,1],[69,22,69,23,1],[70,17,70,18,1],[71,17,71,32,1],[72,13,72,14,1],[51,37,51,40,1],[51,29,51,35,1],[73,13,73,96,1],[74,13,74,14,1],[75,17,75,114,1],[77,17,77,83,1],[78,13,78,14,1],[82,13,82,14,1],[83,9,83,10,1],[111,17,111,18,1],[112,21,112,128,1],[113,21,113,95,1],[117,21,117,95,1],[121,21,121,46,1],[122,21,122,46,1],[123,21,123,22,1],[124,25,124,56,1],[125,21,125,22,1],[126,17,126,18,1],[90,13,90,14,1],[91,17,91,57,1],[92,17,92,18,1],[93,21,93,38,1],[94,21,94,28,1],[97,17,97,38,1],[98,17,98,18,1],[99,21,99,38,1],[100,21,100,28,1],[102,13,102,14,1],[88,9,88,10,1],[89,13,90,13,1],[90,14,91,17,1],[91,57,92,17,1],[92,18,93,21,1],[93,38,94,21,1],[94,28,97,17,1],[97,38,98,17,1],[98,18,99,21,1],[99,38,100,21,1],[100,28,102,13,1],[102,14,102,15,1],[104,13,104,53,1],[105,13,105,116,1],[106,13,106,84,1],[107,18,107,27,1],[108,13,108,14,1],[109,17,109,69,1],[110,17,111,17,1],[111,18,112,21,1],[112,128,113,21,1],[113,95,114,21,1],[114,22,115,25,1],[115,32,117,21,1],[117,95,118,21,1],[118,22,119,25,1],[119,32,121,21,1],[121,46,122,21,1],[122,46,123,21,1],[123,22,124,25,1],[124,56,125,21,1],[125,22,126,17,1],[126,18,126,19,1],[127,17,127,32,1],[128,13,128,14,1],[107,37,107,40,1],[107,29,107,35,1],[129,13,129,96,1],[130,13,130,14,1],[131,17,131,128,1],[133,17,133,83,1],[134,13,134,14,1],[138,13,138,14,1],[139,9,139,10,1],[151,17,151,18,1],[152,21,152,122,1],[153,21,153,46,1],[154,21,154,50,1],[155,21,155,22,1],[156,25,156,56,1],[157,21,157,22,1],[158,17,158,18,1],[180,17,180,18,1],[181,21,181,124,1],[182,21,182,46,1],[183,21,183,50,1],[184,21,184,22,1],[185,25,185,56,1],[186,21,186,22,1],[187,17,187,18,1],[143,9,143,10,1],[144,13,144,53,1],[145,13,145,116,1],[146,13,146,84,1],[147,18,147,27,1],[148,13,148,14,1],[149,17,149,69,1],[150,17,151,17,1],[151,18,152,21,1],[152,122,153,21,1],[153,46,154,21,1],[154,50,155,21,1],[155,22,156,25,1],[156,56,157,21,1],[157,22,158,17,1],[158,18,158,19,1],[159,17,159,32,1],[160,13,160,14,1],[147,37,147,40,1],[147,29,147,35,1],[161,13,161,96,1],[162,13,162,14,1],[163,17,163,114,1],[165,17,165,83,1],[166,13,166,14,1],[174,13,174,75,1],[175,13,175,59,1],[176,18,176,27,1],[177,13,177,14,1],[178,17,178,69,1],[179,17,180,17,1],[180,18,181,21,1],[181,124,182,21,1],[182,46,183,21,1],[183,50,184,21,1],[184,22,185,25,1],[185,56,186,21,1],[186,22,187,17,1],[187,18,187,19,1],[188,17,188,32,1],[189,13,189,14,1],[176,37,176,40,1],[176,29,176,35,1],[190,13,190,96,1],[191,13,191,14,1],[192,17,192,114,1],[194,17,194,83,1],[195,13,195,14,1],[199,13,199,14,1],[200,9,200,10,1]]);
    </script>
  </body>
</html>