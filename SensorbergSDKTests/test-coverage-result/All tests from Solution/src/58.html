<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>d:\work\sensorberg\windows10-sdk\sensorbergsdk\internal\services\settingsmanager.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Diagnostics;
using System.IO;
using System.Runtime.Serialization.Json;
using System.Threading;
using System.Threading.Tasks;
using Windows.Data.Json;
using Windows.Storage;
using SensorbergSDK.Services;

namespace SensorbergSDK.Internal.Services
{
    public sealed class SettingsManager: ISettingsManager, IDisposable
    {
        private const string STORAGE_KEY = &quot;app_settings&quot;;
        private readonly ApplicationDataContainer _localSettings = ApplicationData.Current.LocalSettings;
        private readonly SDKData _sdkData;
        private Timer _updateSettingsTimer;
        private AppSettings _lastSettings;

        public event EventHandler&lt;SettingsEventArgs&gt; SettingsUpdated;
        public AppSettings DefaultAppSettings { get; set; }


        public SettingsManager()
        {
            _sdkData = SDKData.Instance;
        }

        public async Task&lt;AppSettings&gt; GetSettings(bool forceUpdate = false)
        {
            if (_lastSettings != null &amp;&amp; forceUpdate == false)
            {
                Debug.WriteLine(&quot;SettingsManager returned settings from cache.&quot; + _lastSettings);
                return _lastSettings;
            }

            var settings = (await GetSettingsFromApiAsync() ?? GetSettingsFromStorage()) ?? CreateDefaultSettings();

            InitTimer(settings.SettingsUpdateInterval);

            _lastSettings = settings;
            return settings;
        }

        private void InitTimer(UInt64 miliseconds)
        {
            TimeSpan interval = TimeSpan.FromMilliseconds(miliseconds);
            if (_updateSettingsTimer != null)
            {
                _updateSettingsTimer.Change(interval, interval);
                return;
            }

            _updateSettingsTimer = new Timer(OnTimerTick,null, interval, interval);
        }

        private async void OnTimerTick(object state)
        {
            var settings = await GetSettings(true);
            if (SettingsUpdated != null &amp;&amp; settings != null)
            {
                SettingsUpdated(this, new SettingsEventArgs(settings));
            }
        }

        private async Task&lt;AppSettings&gt; GetSettingsFromApiAsync()
        {

            try
            {
                var responseMessage = await ServiceManager.ApiConnction.LoadSettings(_sdkData);
                if (string.IsNullOrEmpty(responseMessage))
                {
                    return null;
                }

                var parsed = JsonValue.Parse(responseMessage);

                var settingsParsed = parsed.GetObject()[&quot;settings&quot;];

                var settings = AppSettings.FromJson(settingsParsed.GetObject());
                SaveSettingsToStorage(settings);

                Debug.WriteLine(&quot;Got settings from api. &quot; + settings);

                return settings;
            }
            catch (Exception ex)
            {
                Debug.WriteLine(&quot;SettingsManager.GetSettingsFromApiAsync(): Failed to send HTTP request: &quot; + ex.Message);
                return null;
            }
        }

        private AppSettings CreateDefaultSettings()
        {
            Debug.WriteLine(&quot;SettingsManager used default settings values.&quot;);
            return DefaultAppSettings != null
                ? DefaultAppSettings
                : new AppSettings();
        }

        private void SaveSettingsToStorage(AppSettings settings)
        {
            MemoryStream stream1 = new MemoryStream();
            DataContractJsonSerializer ser = new DataContractJsonSerializer(typeof(AppSettings));
            ser.WriteObject(stream1, settings);
            stream1.Position = 0;
            StreamReader sr = new StreamReader(stream1);
            string jsonString = sr.ReadToEnd();
            _localSettings.Values[STORAGE_KEY] = jsonString;
        }

        private AppSettings GetSettingsFromStorage()
        {
            var storageValue = _localSettings.Values[STORAGE_KEY];

            var storageString = storageValue?.ToString();

            if (string.IsNullOrEmpty(storageString))
            {
                return null;
            }

            var parsed = JsonValue.Parse(storageString);
            return AppSettings.FromJson(parsed.GetObject());
        }

        public void Dispose()
        {
            _updateSettingsTimer?.Dispose();
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[22,54,22,58,0],[50,13,50,14,0],[51,17,51,65,0],[52,17,52,24,0],[105,9,105,10,0],[106,13,106,55,0],[107,13,107,98,0],[108,13,108,48,0],[109,13,109,34,0],[110,13,110,57,0],[111,13,111,48,0],[112,13,112,61,0],[113,9,113,10,0],[126,13,126,57,0],[127,13,127,61,0],[131,9,131,10,0],[132,13,132,45,0],[133,9,133,10,0],[59,9,59,10,0],[60,13,60,52,0],[61,13,61,61,0],[62,13,62,14,0],[63,17,63,72,0],[64,13,64,14,0],[65,9,65,10,0],[78,17,78,63,0],[80,17,80,69,0],[82,17,82,81,0],[83,17,83,49,0],[85,17,85,71,0],[87,17,87,33,0],[89,13,89,33,0],[90,13,90,14,0],[91,17,91,122,0],[92,17,92,29,0],[22,49,22,53,1],[16,9,16,106,1],[25,9,25,33,1],[26,9,26,10,1],[27,13,27,41,1],[28,9,28,10,1],[47,9,47,10,1],[48,13,48,72,1],[49,13,49,46,1],[55,13,55,84,1],[56,9,56,10,1],[97,9,97,10,1],[98,13,98,78,1],[99,13,101,37,1],[102,9,102,10,1],[116,9,116,10,1],[117,13,117,67,1],[119,13,119,58,1],[121,13,121,53,1],[122,13,122,14,1],[123,17,123,29,1],[128,9,128,10,1],[31,9,31,10,1],[32,13,32,63,1],[33,13,33,14,1],[34,17,34,98,1],[35,17,35,38,1],[38,13,38,117,1],[40,13,40,56,1],[42,13,42,38,1],[43,13,43,29,1],[44,9,44,10,1],[68,9,68,10,1],[71,13,71,14,1],[72,17,72,96,1],[73,17,73,59,1],[74,17,74,18,1],[75,21,75,33,1],[94,9,94,10,1]]);
    </script>
  </body>
</html>