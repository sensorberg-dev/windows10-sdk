<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>d:\work\sensorberg\windows10-sdk\sensorbergsdktests\storageservicetest.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
// Created by Kay Czarnotta on 10.03.2016
// 
// Copyright (c) 2016,  Sensorberg
// 
// All rights reserved.

using System;
using System.Collections.Generic;
using System.IO;
using System.Threading.Tasks;
using Windows.Data.Json;
using Windows.Storage;
using Microsoft.VisualStudio.TestPlatform.UnitTestFramework;
using SensorbergSDK;
using SensorbergSDK.Internal;
using SensorbergSDK.Internal.Data;
using SensorbergSDK.Internal.Services;
using SensorbergSDK.Services;
using SensorbergSDKTests.Mocks;

namespace SensorbergSDKTests
{
    [TestClass]
    public class StorageServiceTest
    {
        [TestInitialize]
        public async Task Setup()
        {
            await TestHelper.ClearFiles(&quot;sensorberg-storage&quot;);
            ServiceManager.ReadOnlyForTests = false;
            ServiceManager.Clear();
            ServiceManager.ApiConnction = new MockApiConnection();
            ServiceManager.LayoutManager = new LayoutManager();
            ServiceManager.StorageService = new StorageServiceExtend();
            ServiceManager.SettingsManager = new SettingsManager();
            ServiceManager.ReadOnlyForTests = true;


            await ServiceManager.StorageService.InitStorage();
        }

        [TestMethod]
        public async Task ValidateAPIKeyTest()
        {
            MockApiConnection connection = (MockApiConnection) ServiceManager.ApiConnction;

            IStorageService service = ServiceManager.StorageService;
            Assert.AreEqual(ApiKeyValidationResult.Valid, await service.ValidateApiKey(&quot;true&quot;), &quot;Not successfull&quot;);
            connection.APIInvalid = true;
            Assert.AreEqual(ApiKeyValidationResult.Invalid, await service.ValidateApiKey(&quot;false&quot;), &quot;Not invalid&quot;);
            connection.APIInvalid = false;


            connection.FailNetwork = true;
            Assert.AreEqual(ApiKeyValidationResult.NetworkError, await service.ValidateApiKey(&quot;true&quot;), &quot;No network issue&quot;);
            connection.FailNetwork = false;

            connection.UnknownError = true;
            Assert.AreEqual(ApiKeyValidationResult.UnknownError, await service.ValidateApiKey(&quot;true&quot;), &quot;No unknown issue&quot;);
            connection.UnknownError = false;
        }

        [TestMethod]
        public async Task RetrieveLayoutTest()
        {
            MockApiConnection connection = (MockApiConnection) ServiceManager.ApiConnction;
            IStorageService service = ServiceManager.StorageService;

            ApplicationData.Current.LocalSettings.Values.Remove(LayoutManager.KeyLayoutHeaders);
            ApplicationData.Current.LocalSettings.Values.Remove(LayoutManager.KeyLayoutRetrievedTime);
            await TestHelper.RemoveFile(LayoutManager.KeyLayoutContent);

            connection.FailNetwork = true;
            LayoutResult layout = await service.RetrieveLayout();
            Assert.AreEqual(NetworkResult.NetworkError, layout.Result, &quot;Not failed&quot;);
            connection.FailNetwork = false;

            layout = await service.RetrieveLayout();
            Assert.AreEqual(NetworkResult.Success, layout.Result, &quot;Not successfull loaded&quot;);
            LayoutManagerTest.ValidateMockLayout(layout.Layout);

            connection.FailNetwork = true;
            //should be cached
            layout = await service.RetrieveLayout();
            Assert.AreEqual(NetworkResult.Success, layout.Result, &quot;Not successfull loaded from cache&quot;);
            LayoutManagerTest.ValidateMockLayout(layout.Layout);
        }

        [TestMethod]
        public async Task FlushHistoryTest()
        {
            StorageServiceExtend sse = (StorageServiceExtend) ServiceManager.StorageService;
            MockStorage mockStorage = new MockStorage();
            sse.SetStorage(mockStorage);
            mockStorage.UndeliveredActions = new List&lt;HistoryAction&gt; {new HistoryAction(new DBHistoryAction())};
            mockStorage.UndeliveredEvents = new List&lt;HistoryEvent&gt; {new HistoryEvent(new DBHistoryEvent())};

            MockApiConnection connection = (MockApiConnection) ServiceManager.ApiConnction;
            IStorageService service = ServiceManager.StorageService;


            connection.FailNetwork = true;
            Assert.IsFalse(await service.FlushHistory(), &quot;Flushing History not failed&quot;);
            connection.FailNetwork = false;
            Assert.IsTrue(mockStorage.UndeliveredEvents.Count != 0, &quot;Event were resetet&quot;);
            Assert.IsTrue(mockStorage.UndeliveredActions.Count != 0, &quot;Actions were resetet&quot;);

            Assert.IsTrue(await service.FlushHistory(), &quot;Flushing History not succeed&quot;);
            Assert.IsTrue(mockStorage.UndeliveredEvents.Count == 0, &quot;Event were not marked as send&quot;);
            Assert.IsTrue(mockStorage.UndeliveredActions.Count == 0, &quot;Actions were not marked as send&quot;);
        }

        [TestMethod]
        public async Task TestHistorActionCacheTest()
        {
            IStorageService service = ServiceManager.StorageService;
            await service.SaveHistoryAction(&quot;1&quot;, &quot;11&quot;, DateTime.Now, BeaconEventType.Enter);
            await service.SaveHistoryAction(&quot;2&quot;, &quot;11&quot;, DateTime.Now, BeaconEventType.Enter);
            await service.SaveHistoryAction(&quot;3&quot;, &quot;11&quot;, DateTime.Now, BeaconEventType.Enter);
            await service.SaveHistoryAction(&quot;1&quot;, &quot;11&quot;, DateTime.Now, BeaconEventType.Enter);
            await service.SaveHistoryAction(&quot;5&quot;, &quot;11&quot;, DateTime.Now, BeaconEventType.Enter);

            IList&lt;HistoryAction&gt; dbHistoryActions = await service.GetActions(&quot;1&quot;);

            Assert.AreEqual(2, dbHistoryActions.Count, &quot;Not 2 actions found&quot;);

            StorageService serviceInstance = (StorageService) service;
            IStorage storage = serviceInstance.Storage;
            await storage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;1&quot;, &quot;11&quot;, DateTime.Now, BeaconEventType.Enter));

            dbHistoryActions = await service.GetActions(&quot;1&quot;);

            Assert.AreEqual(2, dbHistoryActions.Count, &quot;Not 2 actions found, cache not worked&quot;);

            dbHistoryActions = await service.GetActions(&quot;1&quot;);

            Assert.AreEqual(2, dbHistoryActions.Count, &quot;Not 2 actions found&quot;);


            await storage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;6&quot;, &quot;11&quot;, DateTime.Now, BeaconEventType.Enter));
            dbHistoryActions = await service.GetActions(&quot;6&quot;);

            Assert.AreEqual(1, dbHistoryActions.Count, &quot;Not 1 actions found&quot;);
        }

        [TestMethod]
        public async Task TestBackgroundActionsTest()
        {
            ServiceManager.ReadOnlyForTests = false;
            ServiceManager.LayoutManager = new LayoutManagerExtend();
            ((LayoutManagerExtend) ServiceManager.LayoutManager).SetLayout(
                Layout.FromJson(
                    await
                        FileIO.ReadTextAsync(
                            await StorageFile.GetFileFromApplicationUriAsync(new Uri(&quot;ms-appx:///Assets/raw/mock/layout_request_header.txt&quot;, UriKind.RelativeOrAbsolute))),
                    JsonObject.Parse(
                        await
                            FileIO.ReadTextAsync(
                                await StorageFile.GetFileFromApplicationUriAsync(new Uri(&quot;ms-appx:///Assets/raw/mock/mock_layout.json&quot;, UriKind.RelativeOrAbsolute)))),
                    DateTimeOffset.Now));
            ServiceManager.ReadOnlyForTests = true;

            FileStorage storage = new FileStorage {Background = true};

            await
                storage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;9ded63644e424d758b0218f7c70f2473&quot;, &quot;1&quot;, DateTimeOffset.Parse(&quot;2016-04-16T12:00:00.000+0000&quot;),
                    BeaconEventType.Enter));
            await
                storage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;3f30be2605524f82a9bf0ccb4a81618f&quot;, &quot;2&quot;, DateTimeOffset.Parse(&quot;2016-04-16T13:00:00.000+0000&quot;),
                    BeaconEventType.Exit));
            await
                storage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;312a8594e07542bd814ecdd17f76538e&quot;, &quot;3&quot;, DateTimeOffset.Parse(&quot;2016-04-16T14:00:00.000+0000&quot;),
                    BeaconEventType.EnterExit));
            await
                storage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;959ea393e3424ab7ad53584a8b789197&quot;, &quot;2&quot;, DateTimeOffset.Parse(&quot;2016-04-16T14:00:00.000+0000&quot;),
                    BeaconEventType.EnterExit));


            IStorageService storageService = ServiceManager.StorageService;
            List&lt;BeaconAction&gt; beaconActions = await storageService.GetActionsForForeground();

            Assert.AreEqual(4, beaconActions.Count, &quot;Not 4 actions found&quot;);

            await
                storage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;9ded63644e424d758b0218f7c70f2473&quot;, &quot;1&quot;, DateTimeOffset.Parse(&quot;2016-04-16T12:00:00.000+0000&quot;),
                    BeaconEventType.Enter));
            await
                storage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;3f30be2605524f82a9bf0ccb4a81618f&quot;, &quot;2&quot;, DateTimeOffset.Parse(&quot;2016-04-16T13:00:00.000+0000&quot;),
                    BeaconEventType.Exit));
            await
                storage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;312a8594e07542bd814ecdd17f76538e&quot;, &quot;3&quot;, DateTimeOffset.Parse(&quot;2016-04-16T14:00:00.000+0000&quot;),
                    BeaconEventType.EnterExit));
            await
                storage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;959ea393e3424ab7ad53584a8b789197&quot;, &quot;2&quot;, DateTimeOffset.Parse(&quot;2016-04-16T14:00:00.000+0000&quot;),
                    BeaconEventType.EnterExit));

            beaconActions = await storageService.GetActionsForForeground();

            Assert.AreEqual(4, beaconActions.Count, &quot;Not 4 actions found&quot;);

            StorageService service = (StorageService) ServiceManager.StorageService;
            IStorage foregroundStorage = service.Storage;
            await
                foregroundStorage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;4&quot;, &quot;1&quot;, DateTimeOffset.Parse(&quot;2016-04-16T12:00:00.000+0000&quot;),
                    BeaconEventType.Enter));
            await
                foregroundStorage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;3&quot;, &quot;2&quot;, DateTimeOffset.Parse(&quot;2016-04-16T13:00:00.000+0000&quot;),
                    BeaconEventType.Exit));
            await
                foregroundStorage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;2&quot;, &quot;3&quot;, DateTimeOffset.Parse(&quot;2016-04-16T14:00:00.000+0000&quot;),
                    BeaconEventType.EnterExit));
            await
                foregroundStorage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;1&quot;, &quot;2&quot;, DateTimeOffset.Parse(&quot;2016-04-16T14:00:00.000+0000&quot;),
                    BeaconEventType.EnterExit));

            IList&lt;HistoryAction&gt; historyActions = await foregroundStorage.GetUndeliveredActions();

            Assert.AreEqual(12, historyActions.Count, &quot;Not 12 history actions found&quot;);


            await
                storage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;9ded63644e424d758b0218f7c70f2473&quot;, &quot;1&quot;, DateTimeOffset.Parse(&quot;2016-04-16T12:00:00.000+0000&quot;),
                    BeaconEventType.Enter));
            await
                storage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;3f30be2605524f82a9bf0ccb4a81618f&quot;, &quot;2&quot;, DateTimeOffset.Parse(&quot;2016-04-16T13:00:00.000+0000&quot;),
                    BeaconEventType.Exit));
            await
                storage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;312a8594e07542bd814ecdd17f76538e&quot;, &quot;3&quot;, DateTimeOffset.Parse(&quot;2016-04-16T14:00:00.000+0000&quot;),
                    BeaconEventType.EnterExit));
            await
                storage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;959ea393e3424ab7ad53584a8b789197&quot;, &quot;2&quot;, DateTimeOffset.Parse(&quot;2016-04-16T14:00:00.000+0000&quot;),
                    BeaconEventType.EnterExit));

            await foregroundStorage.SetActionsAsDelivered();
            historyActions = await foregroundStorage.GetUndeliveredActions();
            Assert.AreEqual(4, historyActions.Count, &quot;Not 4 history actions found&quot;);

            beaconActions = await storageService.GetActionsForForeground();

            Assert.AreEqual(4, beaconActions.Count, &quot;Not 4 actions found&quot;);



            await
                storage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;9ded63644e424d758b0218f7c70f2473&quot;, &quot;1&quot;, DateTimeOffset.Parse(&quot;2016-04-16T12:00:00.000+0000&quot;),
                    BeaconEventType.Enter));
            await
                storage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;3f30be2605524f82a9bf0ccb4a81618f&quot;, &quot;2&quot;, DateTimeOffset.Parse(&quot;2016-04-16T13:00:00.000+0000&quot;),
                    BeaconEventType.Exit));
            await
                storage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;312a8594e07542bd814ecdd17f76538e&quot;, &quot;3&quot;, DateTimeOffset.Parse(&quot;2016-04-16T14:00:00.000+0000&quot;),
                    BeaconEventType.EnterExit));
            await
                storage.SaveHistoryAction(FileStorageHelper.ToHistoryAction(&quot;959ea393e3424ab7ad53584a8b789197&quot;, &quot;2&quot;, DateTimeOffset.Parse(&quot;2016-04-16T14:00:00.000+0000&quot;),
                    BeaconEventType.EnterExit));

            await foregroundStorage.GetUndeliveredActions();
            await foregroundStorage.SetActionsAsDelivered();
            historyActions = await foregroundStorage.GetUndeliveredActions();
            Assert.AreEqual(0, historyActions.Count, &quot;Not 0 history actions found&quot;);

            beaconActions = await storageService.GetActionsForForeground();

            Assert.AreEqual(4, beaconActions.Count, &quot;Not 4 actions found&quot;);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[28,9,28,10,1],[29,13,29,63,1],[30,13,30,53,1],[31,13,31,36,1],[32,13,32,67,1],[33,13,33,64,1],[34,13,34,72,1],[35,13,35,68,1],[36,13,36,52,1],[39,13,39,63,1],[40,9,40,10,1],[44,9,44,10,1],[45,13,45,92,1],[47,13,47,69,1],[48,13,48,116,1],[49,13,49,42,1],[50,13,50,115,1],[51,13,51,43,1],[54,13,54,43,1],[55,13,55,124,1],[56,13,56,44,1],[58,13,58,44,1],[59,13,59,124,1],[60,13,60,45,1],[61,9,61,10,1],[65,9,65,10,1],[66,13,66,92,1],[67,13,67,69,1],[69,13,69,97,1],[70,13,70,103,1],[71,13,71,73,1],[73,13,73,43,1],[74,13,74,66,1],[75,13,75,86,1],[76,13,76,44,1],[78,13,78,53,1],[79,13,79,93,1],[80,13,80,65,1],[82,13,82,43,1],[84,13,84,53,1],[85,13,85,104,1],[86,13,86,65,1],[87,9,87,10,1],[91,9,91,10,1],[92,13,92,93,1],[93,13,93,57,1],[94,13,94,41,1],[95,13,95,113,1],[96,13,96,109,1],[98,13,98,92,1],[99,13,99,69,1],[102,13,102,43,1],[103,13,103,89,1],[104,13,104,44,1],[105,13,105,91,1],[106,13,106,94,1],[108,13,108,89,1],[109,13,109,102,1],[110,13,110,105,1],[111,9,111,10,1],[115,9,115,10,1],[116,13,116,69,1],[117,13,117,93,1],[118,13,118,93,1],[119,13,119,93,1],[120,13,120,93,1],[121,13,121,93,1],[123,13,123,83,1],[125,13,125,79,1],[127,13,127,71,1],[128,13,128,56,1],[129,13,129,128,1],[131,13,131,62,1],[133,13,133,97,1],[135,13,135,62,1],[137,13,137,79,1],[140,13,140,128,1],[141,13,141,62,1],[143,13,143,79,1],[144,9,144,10,1],[148,9,148,10,1],[149,13,149,53,1],[150,13,150,70,1],[151,13,160,42,1],[161,13,161,52,1],[163,13,163,71,1],[165,13,167,45,1],[168,13,170,44,1],[171,13,173,49,1],[174,13,176,49,1],[179,13,179,76,1],[180,13,180,95,1],[182,13,182,76,1],[184,13,186,45,1],[187,13,189,44,1],[190,13,192,49,1],[193,13,195,49,1],[197,13,197,76,1],[199,13,199,76,1],[201,13,201,85,1],[202,13,202,58,1],[203,13,205,45,1],[206,13,208,44,1],[209,13,211,49,1],[212,13,214,49,1],[216,13,216,99,1],[218,13,218,87,1],[221,13,223,45,1],[224,13,226,44,1],[227,13,229,49,1],[230,13,232,49,1],[234,13,234,61,1],[235,13,235,78,1],[236,13,236,85,1],[238,13,238,76,1],[240,13,240,76,1],[244,13,246,45,1],[247,13,249,44,1],[250,13,252,49,1],[253,13,255,49,1],[257,13,257,61,1],[258,13,258,61,1],[259,13,259,78,1],[260,13,260,85,1],[262,13,262,76,1],[264,13,264,76,1],[265,9,265,10,1]]);
    </script>
  </body>
</html>