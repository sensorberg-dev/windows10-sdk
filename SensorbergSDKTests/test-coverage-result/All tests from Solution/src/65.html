<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>d:\work\sensorberg\windows10-sdk\sensorbergsdktests\sdkenginetest.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
// Created by Kay Czarnotta on 20.04.2016
// 
// Copyright (c) 2016,  Sensorberg
// 
// All rights reserved.

using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Windows.Storage;
using Microsoft.VisualStudio.TestPlatform.UnitTestFramework;
using SensorbergSDK;
using SensorbergSDK.Internal;
using SensorbergSDK.Internal.Services;
using SensorbergSDKTests.Mocks;

namespace SensorbergSDKTests
{
    [TestClass]
    public class SDKEngineTest
    {
        [TestInitialize]
        public async Task Setup()
        {
            await TestHelper.ClearFiles(&quot;sensorberg-storage&quot;);
            ServiceManager.ReadOnlyForTests = false;
            ServiceManager.Clear();
            ServiceManager.ApiConnction = new MockApiConnection();
            ServiceManager.LayoutManager = new LayoutManager();
            ServiceManager.SettingsManager = new SettingsManager();
            ServiceManager.StorageService = new StorageService();
            ServiceManager.ReadOnlyForTests = true;
        }

        [TestMethod]
        public async Task ResolveBackgroundBeaconsSingleAction()
        {
            LayoutManager layoutManager = (LayoutManager) ServiceManager.LayoutManager;
            await layoutManager.VerifyLayoutAsync(true);
            SDKEngine engine = new SDKEngine(false);
            await engine.InitializeAsync();

            BeaconAction orgAction = layoutManager.Layout.ResolvedActions.FirstOrDefault(ra =&gt; ra.BeaconAction.Uuid == &quot;9ded63644e424d758b0218f7c70f2473&quot;).BeaconAction;

            TaskCompletionSource&lt;BeaconAction&gt; action = new TaskCompletionSource&lt;BeaconAction&gt;();
            engine.BeaconActionResolved += (sender, args) =&gt;
            {
                action.SetResult(args);
            };
            await
                engine.ResolveBeaconAction(new BeaconEventArgs()
                {
                    Beacon = new Beacon() {Id1 = &quot;7367672374000000ffff0000ffff0004&quot;, Id2 = 39178, Id3 = 30929},
                    EventType = BeaconEventType.Enter
                });

            BeaconAction result = await action.Task;

            Assert.AreEqual(orgAction, result, &quot;action not found&quot;);
        }

        [TestMethod]
        [Timeout(2000)]
        public async Task ResolveMultipleAction()
        {
            LayoutManager layoutManager = (LayoutManager) ServiceManager.LayoutManager;
            await layoutManager.VerifyLayoutAsync(true);
            SDKEngine engine = new SDKEngine(false);
            await engine.InitializeAsync();

            TaskCompletionSource&lt;IList&lt;BeaconAction&gt;&gt; action = new TaskCompletionSource&lt;IList&lt;BeaconAction&gt;&gt;();
            IList&lt;BeaconAction&gt; list = new List&lt;BeaconAction&gt;();
            engine.BeaconActionResolved += (sender, args) =&gt;
            {
                list.Add(args);
                if (list.Count &gt;= 3)
                {
                    action.TrySetResult(list);
                }
            };
            await
                engine.ResolveBeaconAction(new BeaconEventArgs()
                {
                    Beacon = new Beacon() {Id1 = &quot;7367672374000000ffff0000ffff0003&quot;, Id2 = 48869, Id3 = 21321},
                    EventType = BeaconEventType.Enter
                });

            IList&lt;BeaconAction&gt; result = await action.Task;

            Assert.AreEqual(3, result.Count, &quot;Not 3 action found&quot;);
        }

        [TestMethod]
        [Timeout(2000)]
        public async Task ResolveSingleActionNoResult()
        {
            LayoutManager layoutManager = (LayoutManager) ServiceManager.LayoutManager;
            await layoutManager.VerifyLayoutAsync(true);
            SDKEngine engine = new SDKEngine(false);
            await engine.InitializeAsync();

            TaskCompletionSource&lt;IList&lt;BeaconAction&gt;&gt; action = new TaskCompletionSource&lt;IList&lt;BeaconAction&gt;&gt;();
            IList&lt;BeaconAction&gt; list = new List&lt;BeaconAction&gt;();
            engine.BeaconActionResolved += (sender, args) =&gt;
            {
                list.Add(args);
                if (list.Count &gt;= 3)
                {
                    action.SetResult(list);
                }
            };
            await
                engine.ResolveBeaconAction(new BeaconEventArgs()
                {
                    Beacon = new Beacon() {Id1 = &quot;7367672374000000ffff0000ffff1234&quot;, Id2 = 39178, Id3 = 30929},
                    EventType = BeaconEventType.Enter
                });

            if (await Task.WhenAny(action.Task, Task.Delay(500)) == action.Task)
            {
                Assert.AreEqual(0, action.Task.Result, &quot;Not 0 action found&quot;);
            }
            else
            {
                //timeout is fine
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[106,13,106,14,0],[107,17,107,32,0],[108,17,108,37,0],[109,17,109,18,0],[110,21,110,44,0],[111,17,111,18,0],[112,13,112,14,0],[121,13,121,14,0],[122,17,122,78,0],[123,13,123,14,0],[25,9,25,10,1],[26,13,26,63,1],[27,13,27,53,1],[28,13,28,36,1],[29,13,29,67,1],[30,13,30,64,1],[31,13,31,68,1],[32,13,32,66,1],[33,13,33,52,1],[34,9,34,10,1],[48,13,48,14,1],[49,17,49,40,1],[50,13,50,14,1],[44,96,44,154,1],[38,9,38,10,1],[39,13,39,88,1],[40,13,40,57,1],[41,13,41,53,1],[42,13,42,44,1],[44,13,44,96,1],[44,154,44,169,1],[46,13,46,98,1],[47,13,48,13,1],[48,14,49,17,1],[49,40,50,13,1],[50,14,50,15,1],[51,13,56,20,1],[58,13,58,53,1],[60,13,60,68,1],[61,9,61,10,1],[75,13,75,14,1],[76,17,76,32,1],[77,17,77,37,1],[78,17,78,18,1],[79,21,79,47,1],[80,17,80,18,1],[81,13,81,14,1],[66,9,66,10,1],[67,13,67,88,1],[68,13,68,57,1],[69,13,69,53,1],[70,13,70,44,1],[72,13,72,112,1],[73,13,73,65,1],[74,13,75,13,1],[75,14,76,17,1],[76,32,77,17,1],[77,37,78,17,1],[78,18,79,21,1],[79,47,80,17,1],[80,18,81,13,1],[81,14,81,15,1],[82,13,87,20,1],[89,13,89,60,1],[91,13,91,68,1],[92,9,92,10,1],[97,9,97,10,1],[98,13,98,88,1],[99,13,99,57,1],[100,13,100,53,1],[101,13,101,44,1],[103,13,103,112,1],[104,13,104,65,1],[105,13,106,13,1],[106,14,107,17,1],[107,32,108,17,1],[108,37,109,17,1],[109,18,110,21,1],[110,44,111,17,1],[111,18,112,13,1],[112,14,112,15,1],[113,13,118,20,1],[120,13,120,81,1],[125,13,125,14,1],[127,13,127,14,1],[128,9,128,10,1]]);
    </script>
  </body>
</html>