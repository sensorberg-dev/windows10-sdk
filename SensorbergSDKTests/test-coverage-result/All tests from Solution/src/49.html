<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>d:\work\sensorberg\windows10-sdk\sensorbergsdk\internal\transport\layoutmanager.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Linq;
using System.Threading.Tasks;
using Windows.Foundation;
using SensorbergSDK.Internal.Services;
using SensorbergSDK.Services;

namespace SensorbergSDK.Internal
{
    /// &lt;summary&gt;
    /// Manages the layouts and encapsulates both retrieving fresh layouts from the web and
    /// caching them.
    /// &lt;/summary&gt;
    public class LayoutManager : ILayoutManager
    {
        public const string KeyLayoutHeaders = &quot;layout_headers&quot;;
        public const string KeyLayoutContent = &quot;layout_content.cache&quot;; // Cache file
        public const string KeyLayoutRetrievedTime = &quot;layout_retrieved_time&quot;;

        /// &lt;summary&gt;
        /// Fired, when the layout becomes valid/invalid.
        /// &lt;/summary&gt;
        public event EventHandler&lt;bool&gt; LayoutValidityChanged;

        public Layout Layout { get; protected set; }

        /// &lt;summary&gt;
        /// Checks the layout validity.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;True, if layout is valid. False, if invalid.&lt;/returns&gt;
        public bool IsLayoutValid
        {
            get
            {
                return Layout != null &amp;&amp; Layout.ValidTill &gt;= DateTimeOffset.Now;
            }
        }

        /// &lt;summary&gt;
        /// Makes sure the layout is up-to-date.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;forceUpdate&quot;&gt;If true, will update the layout even if valid.&lt;/param&gt;
        /// &lt;returns&gt;True, if layout is valid (or was updated), false otherwise.&lt;/returns&gt;
        public IAsyncOperation&lt;bool&gt; VerifyLayoutAsync(bool forceUpdate)
        {
            return InternalVerifyLayoutAsync(forceUpdate).AsAsyncOperation&lt;bool&gt;();
        }

        private async Task&lt;bool&gt; InternalVerifyLayoutAsync(bool forceUpdate)
        {
            if (forceUpdate || !IsLayoutValid)
            {
                if (!forceUpdate)
                {
                    // Check local storage first
                    Layout = await ServiceManager.StorageService.LoadLayoutFromLocalStorage();
                }

                if (forceUpdate || !IsLayoutValid)
                {
                    // Make sure that the existing layout (even if old) is not set to null in case
                    // we fail to load the fresh one from the web.
                    LayoutResult freshLayout = await ServiceManager.StorageService.RetrieveLayout();

                    if (freshLayout != null &amp;&amp; freshLayout.Result == NetworkResult.Success)
                    {
                        Layout = freshLayout.Layout;
                        Debug.WriteLine(&quot;Layout changed.&quot;);
                    }
                    else
                    {
                        //TODO some thing should happen
                    }
                }
            }

            return IsLayoutValid;
        }


        /// &lt;summary&gt;
        /// Executes the given request.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;request&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;The result state (success or failure).&lt;/returns&gt;
        public IAsyncOperation&lt;RequestResultState&gt; ExecuteRequestAsync(Request request)
        {
            IAsyncOperation&lt;RequestResultState&gt; resultState = InternalExecuteRequestAsync(request).AsAsyncOperation&lt;RequestResultState&gt;();
            return resultState;
        }

        /// &lt;summary&gt;
        /// Invalidates both the current and cached layout.
        /// &lt;/summary&gt;
        public async Task InvalidateLayout()
        {
            Layout = null;
            await ServiceManager.StorageService.InvalidateLayout();
        }

        public ResolvedAction GetAction(string actionId)
        {
            return Layout.ResolvedActions.FirstOrDefault(r =&gt; r.BeaconAction.Uuid == actionId);
        }

        internal async Task&lt;RequestResultState&gt; InternalExecuteRequestAsync(Request request)
        {
            System.Diagnostics.Debug.WriteLine(&quot;LayoutManager.InternalExecuteRequestAsync(): Request ID is &quot; + request.RequestId);
            RequestResultState resultState = RequestResultState.Failed;

            if (request != null &amp;&amp; request.BeaconEventArgs != null &amp;&amp; request.BeaconEventArgs.Beacon != null)
            {
                if (await VerifyLayoutAsync(false))
                {
                    request.ResolvedActions = Layout.GetResolvedActionsForPidAndEvent(
                        request.BeaconEventArgs.Beacon.Pid, request.BeaconEventArgs.EventType);

                    foreach (ResolvedAction resolvedAction in request.ResolvedActions)
                    {
                        if (resolvedAction != null &amp;&amp; resolvedAction.BeaconAction != null)
                        {
                            resolvedAction.BeaconAction.Id = request.RequestId;
                        }
                    }

                    resultState = RequestResultState.Success;
                }
            }

            return resultState;
        }


        /// &lt;summary&gt;
        /// Creates a hash string based on the beacon ID1s in the given layout.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;layout&quot;&gt;The layout containing the beacon ID1s.&lt;/param&gt;
        /// &lt;returns&gt;A hash string of the beacon ID1s or null in case of an error.&lt;/returns&gt;
        public static string CreateHashOfBeaconId1sInLayout(Layout layout)
        {
            string hash = null;

            if (layout != null)
            {
                IList&lt;string&gt; beaconId1s = layout.AccountBeaconId1s;

                if (beaconId1s.Count &gt; 0)
                {
                    hash = beaconId1s[0];

                    for (int i = 1; i &lt; beaconId1s.Count; ++i)
                    {
                        var currentUuid = beaconId1s[i];

                        for (int j = 0; j &lt; currentUuid.Length; ++j)
                        {
                            if (hash.Length &lt; j + 1)
                            {
                                hash += currentUuid[j];
                            }
                            else
                            {
                                char combinationChar = (char)(((int)hash[j] + (int)currentUuid[j]) / 2 + 1);

                                if (j == 0)
                                {
                                    hash = combinationChar + hash.Substring(j + 1);
                                }
                                else if (hash.Length &gt; j + 1)
                                {
                                    hash = hash.Substring(0, j) + combinationChar + hash.Substring(j + 1);
                                }
                                else
                                {
                                    hash = hash.Substring(0, j) + combinationChar;
                                }
                            }
                        }
                    }
                }
            }

            return hash;
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[142,9,142,10,0],[143,13,143,32,0],[145,13,145,32,0],[146,13,146,14,0],[147,17,147,69,0],[149,17,149,42,0],[150,17,150,18,0],[151,21,151,42,0],[153,26,153,35,0],[154,21,154,22,0],[155,25,155,57,0],[157,30,157,39,0],[158,25,158,26,0],[159,29,159,53,0],[160,29,160,30,0],[161,33,161,56,0],[162,29,162,30,0],[164,29,164,30,0],[165,33,165,109,0],[167,33,167,44,0],[168,33,168,34,0],[169,37,169,84,0],[170,33,170,34,0],[171,38,171,62,0],[172,33,172,34,0],[173,37,173,107,0],[174,33,174,34,0],[176,33,176,34,0],[177,37,177,83,0],[178,33,178,34,0],[179,29,179,30,0],[180,25,180,26,0],[157,65,157,68,0],[157,41,157,63,0],[181,21,181,22,0],[153,59,153,62,0],[153,37,153,57,0],[182,17,182,18,0],[183,13,183,14,0],[185,13,185,25,0],[186,9,186,10,0],[73,21,73,22,0],[75,21,75,22,0],[27,32,27,36,1],[27,37,27,51,1],[36,13,36,14,1],[37,17,37,81,1],[38,13,38,14,1],[47,9,47,10,1],[48,13,48,84,1],[49,9,49,10,1],[89,9,89,10,1],[90,13,90,139,1],[91,13,91,32,1],[92,9,92,10,1],[104,9,104,10,1],[105,13,105,63,1],[105,94,105,96,1],[106,9,106,10,1],[52,9,52,10,1],[53,13,53,47,1],[54,13,54,14,1],[55,17,55,34,1],[56,17,56,18,1],[58,21,58,95,1],[59,17,59,18,1],[61,17,61,51,1],[62,17,62,18,1],[65,21,65,101,1],[67,21,67,92,1],[68,21,68,22,1],[69,25,69,53,1],[70,25,70,60,1],[71,21,71,22,1],[76,17,76,18,1],[77,13,77,14,1],[79,13,79,34,1],[80,9,80,10,1],[98,9,98,10,1],[99,13,99,27,1],[100,13,100,68,1],[101,9,101,10,1],[105,63,105,94,1],[109,9,109,10,1],[110,13,110,131,1],[111,13,111,72,1],[113,13,113,110,1],[114,13,114,14,1],[115,17,115,52,1],[116,17,116,18,1],[117,21,118,96,1],[120,21,120,28,1],[120,63,120,86,1],[120,30,120,59,1],[121,21,121,22,1],[122,25,122,91,1],[123,25,123,26,1],[124,29,124,80,1],[125,25,125,26,1],[126,21,126,22,1],[120,60,120,62,1],[128,21,128,62,1],[129,17,129,18,1],[130,13,130,14,1],[132,13,132,32,1],[133,9,133,10,1]]);
    </script>
  </body>
</html>