<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>d:\work\sensorberg\windows10-sdk\sensorbergsdk\internal\resolver.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using SensorbergSDK.Internal;
using System;
using System.Collections.Generic;
using System.Threading.Tasks;
using MetroLog;
using SensorbergSDK.Internal.Data;

namespace SensorbergSDK
{
    /// &lt;summary&gt;
    /// Manages resolving the actions associated to beacon events.
    /// &lt;/summary&gt;
	public sealed class Resolver: IResolver
    {
        private static readonly ILogger logger = LogManagerFactory.DefaultLogManager.GetLogger&lt;Resolver&gt;();
        public event EventHandler&lt;ResolvedActionsEventArgs&gt; ActionsResolved;
        public event EventHandler&lt;string&gt; FailedToResolveActions;

        public event EventHandler&lt;int&gt; RequestQueueCountChanged
        {
            add { _requestQueue.QueueCountChanged += value; }
            remove { _requestQueue.QueueCountChanged -= value; }
        }

        private readonly RequestQueue _requestQueue;
        private Dictionary&lt;string, string&gt; _filter = new Dictionary&lt;string, string&gt;();

        public Resolver()
        {
            _requestQueue = new RequestQueue();
        }

        public void Dispose()
        {
            _requestQueue.Clear();
        }

        /// &lt;summary&gt;
        /// Creates and schedules an execution of a request for the given beacon event.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;beaconEventArgs&quot;&gt;The beacon event details.&lt;/param&gt;
        /// &lt;returns&gt;The request ID.&lt;/returns&gt;
        public async Task&lt;int&gt; CreateRequest(BeaconEventArgs beaconEventArgs)
        {
            int requestId = SDKData.Instance.NextId();
            logger.Debug(&quot;Resolver: Beacon &quot; + beaconEventArgs.Beacon.Id1 + &quot; &quot; + beaconEventArgs.Beacon.Id2 + &quot; &quot; + beaconEventArgs.Beacon.Id3+&quot; ---&gt; Request: &quot;+requestId);
            Request request = new Request(beaconEventArgs, requestId);
            request.Result += OnRequestResult;
            _requestQueue.Add(request);
            return requestId;
        }

        /// &lt;summary&gt;
        /// Handles a completed (or failed) request.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
        private void OnRequestResult(object sender, RequestResultState e)
        {
            Request request = sender as Request;

            if (request != null)
            {
                request.Result -= OnRequestResult;

                logger.Debug(&quot;Resolver: OnRequestResult(): Request with ID &quot; + request.RequestId + &quot; was &quot; + e);
                if (e == RequestResultState.Success)
                {

                    if (ActionsResolved != null)
                    {
                        ResolvedActionsEventArgs eventArgs = new ResolvedActionsEventArgs();
                        eventArgs.ResolvedActions = request.ResolvedActions;
                        eventArgs.RequestID = request.RequestId;
                        eventArgs.BeaconEventType = request.BeaconEventArgs.EventType;
                        
                        if (request.BeaconEventArgs != null &amp;&amp; request.BeaconEventArgs.Beacon != null)
                        {
                            eventArgs.BeaconPid = request.BeaconEventArgs.Beacon.Pid;
                        }

                        ActionsResolved(this, eventArgs);
                    }
                }
                else if (e == RequestResultState.Failed)
                {
                    logger.Info(&quot;Resolver: OnRequestResult(): Request with ID &quot; + request.RequestId + &quot; failed&quot;);

                    FailedToResolveActions?.Invoke(this, request.ErrorMessage);
                }
            }
        }
    }
}



    </pre>
    <script type="text/javascript">
      highlightRanges([[21,17,21,18,0],[21,19,21,60,0],[21,61,21,62,0],[22,20,22,21,0],[22,22,22,63,0],[22,64,22,65,0],[85,22,85,57,0],[86,17,86,18,0],[87,21,87,114,0],[89,21,89,80,0],[90,17,90,18,0],[26,9,26,87,1],[28,9,28,26,1],[29,9,29,10,1],[30,13,30,48,1],[31,9,31,10,1],[34,9,34,10,1],[35,13,35,35,1],[36,9,36,10,1],[59,9,59,10,1],[60,13,60,49,1],[62,13,62,33,1],[63,13,63,14,1],[64,17,64,51,1],[66,17,66,113,1],[67,17,67,53,1],[68,17,68,18,1],[70,21,70,49,1],[71,21,71,22,1],[72,25,72,93,1],[73,25,73,77,1],[74,25,74,65,1],[75,25,75,87,1],[77,25,77,103,1],[78,25,78,26,1],[79,29,79,86,1],[80,25,80,26,1],[82,25,82,58,1],[83,21,83,22,1],[84,17,84,18,1],[91,13,91,14,1],[92,9,92,10,1],[15,9,15,108,1],[44,9,44,10,1],[45,13,45,55,1],[46,13,46,174,1],[47,13,47,71,1],[48,13,48,47,1],[49,13,49,40,1],[50,13,50,30,1],[51,9,51,10,1]]);
    </script>
  </body>
</html>