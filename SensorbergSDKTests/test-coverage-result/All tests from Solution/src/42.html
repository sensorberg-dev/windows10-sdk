<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>d:\work\sensorberg\windows10-sdk\sensorbergsdk\internal\data\eventhistory.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Threading.Tasks;
using System.Threading;
using MetroLog;
using SensorbergSDK.Internal.Services;

namespace SensorbergSDK.Internal
{
    /// &lt;summary&gt;
    /// Event storage. It stores all past beacon events and actions associated with the events.
    /// &lt;/summary&gt;
    public sealed class EventHistory : IDisposable
    {
        private static readonly ILogger logger = LogManagerFactory.DefaultLogManager.GetLogger&lt;EventHistory&gt;();
        private readonly AutoResetEvent _asyncWaiter;

        public EventHistory()
        {
            _asyncWaiter = new AutoResetEvent(true);
        }

        /// &lt;summary&gt;
        /// If sendOnlyOnce is true for resolved action, fuction will check from the history if the
        /// action is already presented for the user.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;resolvedAction&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;True ,if action type is SendOnlyOnce, and it has been shown already. Otherwise false.&lt;/returns&gt;
        public async Task&lt;bool&gt; CheckSendOnlyOnceAsync(ResolvedAction resolvedAction)
        {
            logger.Trace(&quot;CheckSendOnlyOnceAsync {0}&quot;, resolvedAction.BeaconAction.Id);
            bool sendonlyOnce = false;

            if (resolvedAction.SendOnlyOnce)
            {
                try
                {
                    _asyncWaiter.WaitOne();
                    HistoryAction dbHistoryAction = await ServiceManager.StorageService.GetAction(resolvedAction.BeaconAction.Uuid);

                    if (dbHistoryAction != null)
                    {
                        sendonlyOnce = true;
                    }

                }
                finally
                {
                    _asyncWaiter.Set();
                }
            }

            return sendonlyOnce;
        }

        /// &lt;summary&gt;
        /// If supressionTime is set for the action, fuction will check from the history if the
        /// action is already presented during the supression time.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;resolvedAction&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;True only if action should be supressed.&lt;/returns&gt;
        public async Task&lt;bool&gt; ShouldSupressAsync(ResolvedAction resolvedAction)
        {
            logger.Trace(&quot;ShouldSupressAsync {0}&quot;, resolvedAction.BeaconAction.Id);
            bool suppress = false;

            if (resolvedAction.SupressionTime &gt; 0)
            {
                try
                {
                    _asyncWaiter.WaitOne();
                    IList&lt;HistoryAction&gt; dbHistoryActions = await ServiceManager.StorageService.GetActions(resolvedAction.BeaconAction.Uuid);

                    if (dbHistoryActions != null)
                    {
                        foreach (var dbHistoryAction in dbHistoryActions)
                        {
                            var action_timestamp = DateTimeOffset.Parse(dbHistoryAction.dt).AddSeconds(resolvedAction.SupressionTime);

                            if (action_timestamp &gt; DateTimeOffset.Now)
                            {
                                suppress = true;
                                break;
                            }
                        }
                    }
                }
                finally
                {
                    _asyncWaiter.Set();
                }
            }

            return suppress;
        }

        /// &lt;summary&gt;
        /// Stores a beacon event to the database.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;eventArgs&quot;&gt;&lt;/param&gt;
        public async Task SaveBeaconEventAsync(BeaconEventArgs eventArgs)
        {
            await ServiceManager.StorageService.SaveHistoryEvent(eventArgs.Beacon.Pid, eventArgs.Timestamp, eventArgs.EventType);
        }

        /// &lt;summary&gt;
        /// Stores a resolved and executed action to the database.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;eventArgs&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;beaconAction&quot;&gt;&lt;/param&gt;
        public async Task SaveExecutedResolvedActionAsync(ResolvedActionsEventArgs eventArgs, BeaconAction beaconAction)
        {
            await ServiceManager.StorageService.SaveHistoryAction(beaconAction.Uuid, eventArgs.BeaconPid, DateTime.Now, eventArgs.BeaconEventType);
        }

        /// &lt;summary&gt;
        /// For convenience.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;beaconAction&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;beaconPid&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;beaconEventType&quot;&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public async Task SaveExecutedResolvedActionAsync(BeaconAction beaconAction, string beaconPid, BeaconEventType beaconEventType)
        {
            await ServiceManager.StorageService.SaveHistoryAction(beaconAction.Uuid, beaconPid, DateTime.Now, beaconEventType);
        }

        /// &lt;summary&gt;
        /// Checks if there are new events or actions in the history and sends them to the server.
        /// &lt;/summary&gt;
        public async Task FlushHistoryAsync()
        {
            await ServiceManager.StorageService.FlushHistory();
        }

        public void Dispose()
        {
            _asyncWaiter?.Dispose();
        }
    }
}


    </pre>
    <script type="text/javascript">
      highlightRanges([[137,9,137,10,0],[138,13,138,37,0],[139,9,139,10,0],[18,9,18,30,1],[19,9,19,10,1],[20,13,20,53,1],[21,9,21,10,1],[15,9,15,112,1],[30,9,30,10,1],[31,13,31,88,1],[32,13,32,39,1],[34,13,34,45,1],[35,13,35,14,1],[37,17,37,18,1],[38,21,38,44,1],[39,21,39,133,1],[41,21,41,49,1],[42,21,42,22,1],[43,25,43,45,1],[44,21,44,22,1],[46,17,46,18,1],[48,17,48,18,1],[49,21,49,40,1],[50,17,50,18,1],[51,13,51,14,1],[53,13,53,33,1],[54,9,54,10,1],[63,9,63,10,1],[64,13,64,84,1],[65,13,65,35,1],[67,13,67,51,1],[68,13,68,14,1],[70,17,70,18,1],[71,21,71,44,1],[72,21,72,142,1],[74,21,74,50,1],[75,21,75,22,1],[76,25,76,32,1],[76,57,76,73,1],[76,34,76,53,1],[77,25,77,26,1],[78,29,78,135,1],[80,29,80,71,1],[81,29,81,30,1],[82,33,82,49,1],[83,33,83,39,1],[85,25,85,26,1],[76,54,76,56,1],[86,21,86,22,1],[87,17,87,18,1],[89,17,89,18,1],[90,21,90,40,1],[91,17,91,18,1],[92,13,92,14,1],[94,13,94,29,1],[95,9,95,10,1],[102,9,102,10,1],[103,13,103,130,1],[104,9,104,10,1],[112,9,112,10,1],[113,13,113,148,1],[114,9,114,10,1],[124,9,124,10,1],[125,13,125,128,1],[126,9,126,10,1],[132,9,132,10,1],[133,13,133,64,1],[134,9,134,10,1]]);
    </script>
  </body>
</html>