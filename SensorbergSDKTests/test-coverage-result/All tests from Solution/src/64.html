<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>d:\work\sensorberg\windows10-sdk\sensorbergsdk\internal\services\syncresolver.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
// Created by Kay Czarnotta on 19.04.2016
// 
// Copyright (c) 2016,  Sensorberg
// 
// All rights reserved.

using System;
using System.Threading.Tasks;
using MetroLog;
using SensorbergSDK.Internal.Data;

namespace SensorbergSDK.Internal.Services
{
    public class SyncResolver : IResolver
    {
        private static readonly ILogger logger = LogManagerFactory.DefaultLogManager.GetLogger&lt;SyncResolver&gt;();
        public event EventHandler&lt;ResolvedActionsEventArgs&gt; ActionsResolved;
        public event EventHandler&lt;string&gt; FailedToResolveActions;

        public void Dispose()
        {
            throw new NotImplementedException();
        }

        public async Task&lt;int&gt; CreateRequest(BeaconEventArgs beaconEventArgs)
        {
            int requestId = SDKData.Instance.NextId();
            logger.Debug(&quot;Resolver: Beacon &quot; + beaconEventArgs.Beacon.Id1 + &quot; &quot; + beaconEventArgs.Beacon.Id2 + &quot; &quot; + beaconEventArgs.Beacon.Id3 + &quot; ---&gt; Request: &quot; + requestId);
            Request request = new Request(beaconEventArgs, requestId);
            await Resolve(request);
            return requestId;
        }

        private async Task Resolve(Request request)
        {
            logger.Trace(&quot;take next request &quot; + request.RequestId);
            request.TryCount++;
            RequestResultState requestResult = RequestResultState.None;

            try
            {
                requestResult = await ServiceManager.LayoutManager.ExecuteRequestAsync(request);
            }
            catch (ArgumentNullException ex)
            {
                request.ErrorMessage = ex.Message;
                requestResult = RequestResultState.Failed;
            }
            catch (Exception ex)
            {
                request.ErrorMessage = ex.Message;
                requestResult = RequestResultState.Failed;
            }
            logger.Debug(&quot;request result &quot; + request.RequestId + &quot; &quot; + requestResult);

            switch (requestResult)
            {
                case RequestResultState.Failed:
                {
                    if (request.TryCount &gt;= request.MaxNumberOfRetries)
                    {
                        // The maximum number of retries has been exceeded =&gt; fail
                        OnRequestServed(request, requestResult);
                    }
                    else
                    {
                        int numberOfTriesLeft = request.MaxNumberOfRetries - request.TryCount;

                        logger.Debug(&quot;RequestQueue.ServeNextRequestAsync(): Request with ID &quot;
                                     + request.RequestId + &quot; failed, will try &quot;
                                     + numberOfTriesLeft + &quot; more &quot; + (numberOfTriesLeft &gt; 1 ? &quot;times&quot; : &quot;time&quot;));

                        await Resolve(request);
                    }

                }
                    break;
                case RequestResultState.Success:
                {
                    OnRequestServed(request, requestResult);
                    break;
                }
            }
        }

        private void OnRequestServed(object sender, RequestResultState e)
        {
            Request request = sender as Request;

            if (request != null)
            {
                logger.Debug(&quot;OnRequestServed: Request with ID &quot; + request.RequestId + &quot; was &quot; + e);
                if (e == RequestResultState.Success)
                {

                    if (ActionsResolved != null)
                    {
                        ResolvedActionsEventArgs eventArgs = new ResolvedActionsEventArgs();
                        eventArgs.ResolvedActions = request.ResolvedActions;
                        eventArgs.RequestID = request.RequestId;
                        eventArgs.BeaconEventType = request.BeaconEventArgs.EventType;

                        if (request.BeaconEventArgs != null &amp;&amp; request.BeaconEventArgs.Beacon != null)
                        {
                            eventArgs.BeaconPid = request.BeaconEventArgs.Beacon.Pid;
                        }

                        ActionsResolved(this, eventArgs);
                    }
                }
                else if (e == RequestResultState.Failed)
                {
                    logger.Info(&quot;OnRequestServed: Request with ID &quot; + request.RequestId + &quot; failed&quot;);

                    FailedToResolveActions?.Invoke(this, request.ErrorMessage);
                }
            }
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[21,9,21,10,0],[22,13,22,49,0],[111,22,111,57,0],[112,17,112,18,0],[113,21,113,102,0],[115,21,115,80,0],[116,17,116,18,0],[44,13,44,45,0],[45,13,45,14,0],[46,17,46,51,0],[47,17,47,59,0],[48,13,48,14,0],[49,13,49,33,0],[50,13,50,14,0],[51,17,51,51,0],[52,17,52,59,0],[53,13,53,14,0],[59,17,59,18,0],[60,21,60,72,0],[61,21,61,22,0],[63,25,63,65,0],[64,21,64,22,0],[66,21,66,22,0],[67,25,67,95,0],[69,25,71,115,0],[73,25,73,48,0],[74,21,74,22,0],[76,17,76,18,0],[77,21,77,27,0],[87,9,87,10,1],[88,13,88,49,1],[90,13,90,33,1],[91,13,91,14,1],[92,17,92,101,1],[93,17,93,53,1],[94,17,94,18,1],[96,21,96,49,1],[97,21,97,22,1],[98,25,98,93,1],[99,25,99,77,1],[100,25,100,65,1],[101,25,101,87,1],[103,25,103,103,1],[104,25,104,26,1],[105,29,105,86,1],[106,25,106,26,1],[108,25,108,58,1],[109,21,109,22,1],[110,17,110,18,1],[117,13,117,14,1],[118,9,118,10,1],[16,9,16,112,1],[26,9,26,10,1],[27,13,27,55,1],[28,13,28,178,1],[29,13,29,71,1],[30,13,30,36,1],[31,13,31,30,1],[32,9,32,10,1],[35,9,35,10,1],[36,13,36,68,1],[37,13,37,32,1],[38,13,38,72,1],[41,13,41,14,1],[42,17,42,97,1],[43,13,43,14,1],[54,13,54,87,1],[56,13,56,35,1],[79,17,79,18,1],[80,21,80,61,1],[81,21,81,27,1],[84,9,84,10,1]]);
    </script>
  </body>
</html>